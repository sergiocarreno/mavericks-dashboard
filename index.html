<!DOCTYPE html>
<html lang="pt">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no,viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>Mavericks Import Hunter</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
</script>
</script>
<style>
/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   APPLE-INSPIRED DESIGN SYSTEM
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
:root {
  /* Backgrounds */
  --bg: #000000;
  --bg1: #0a0a0a;
  --bg2: #111111;
  --bg3: #1a1a1a;
  --bg4: #222222;

  /* Surfaces (glassmorphism) */
  --surface: rgba(28,28,30,0.92);
  --surface2: rgba(44,44,46,0.80);
  --surface3: rgba(58,58,60,0.60);

  /* Text */
  --t1: #ffffff;
  --t2: rgba(255,255,255,.70);
  --t3: rgba(255,255,255,.45);
  --t4: rgba(255,255,255,.25);

  /* Accent colors */
  --blue:   #0a84ff;
  --blue2:  rgba(10,132,255,.18);
  --blue3:  rgba(10,132,255,.08);
  --green:  #30d158;
  --green2: rgba(48,209,88,.18);
  --green3: rgba(48,209,88,.08);
  --gold:   #ffd60a;
  --gold2:  rgba(255,214,10,.18);
  --gold3:  rgba(255,214,10,.08);
  --red:    #ff453a;
  --red2:   rgba(255,69,58,.18);
  --red3:   rgba(255,69,58,.08);
  --wa:     #25d366;

  /* Borders */
  --sep:  rgba(255,255,255,.10);
  --sep2: rgba(255,255,255,.06);

  /* Radii */
  --r-xs: 8px;
  --r-sm: 12px;
  --r:    16px;
  --r-lg: 20px;
  --r-xl: 26px;

  /* Fonts */
  --f: 'Inter', -apple-system, BlinkMacSystemFont, 'SF Pro Text', sans-serif;

  /* Safe areas */
  --sat: env(safe-area-inset-top, 0px);
  --sab: env(safe-area-inset-bottom, 0px);
}

*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
html { scroll-behavior: smooth; -webkit-text-size-adjust: 100%; }
body {
  font-family: var(--f);
  background: var(--bg);
  color: var(--t1);
  min-height: 100vh;
  min-height: -webkit-fill-available;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
  overflow-x: hidden;
}
input, select, button, textarea { font-family: var(--f); }
button { cursor: pointer; }
::-webkit-scrollbar { width: 0; }

/* ‚ïê‚ïê‚ïê NCM PROGRESS BAR ‚ïê‚ïê‚ïê */
#ncmStatus {
  position: fixed; top: 0; left: 0; right: 0; height: 2px;
  background: linear-gradient(90deg, var(--blue), var(--green));
  z-index: 9999; transform: scaleX(0); transform-origin: left;
  transition: transform .4s ease;
}
#ncmStatus.loading { animation: ncmBar 2s ease-in-out infinite; }
#ncmStatus.done    { transform: scaleX(1); opacity: 0; transition: opacity .6s .4s; }
@keyframes ncmBar { 0%{transform:scaleX(0)} 60%{transform:scaleX(.8)} 100%{transform:scaleX(.95)} }

/* ‚ïê‚ïê‚ïê TOAST ‚ïê‚ïê‚ïê */
#toast {
  position: fixed; bottom: calc(80px + var(--sab)); left: 50%;
  transform: translateX(-50%) translateY(20px);
  background: rgba(40,40,42,.98); backdrop-filter: blur(20px) saturate(180%);
  border: 1px solid var(--sep); color: var(--t1);
  padding: 12px 20px; border-radius: 30px;
  font-size: 15px; font-weight: 600; letter-spacing: -.01em;
  z-index: 9998; transition: transform .28s cubic-bezier(.4,0,.2,1), opacity .28s;
  pointer-events: none; white-space: nowrap;
  box-shadow: 0 8px 32px rgba(0,0,0,.5);
  opacity: 0;
}
#toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }

/* ‚ïê‚ïê‚ïê LOGIN SCREEN ‚ïê‚ïê‚ïê */
#loginScreen {
  position: fixed; inset: 0; background: var(--bg);
  z-index: 1000; display: none; align-items: center; justify-content: center; padding: 24px;
}
.login-card {
  background: var(--bg2); border: 1px solid var(--sep);
  border-radius: var(--r-xl); padding: 40px 28px;
  max-width: 380px; width: 100%; text-align: center;
}
.login-icon { font-size: 52px; margin-bottom: 16px; display: block; }
.login-title { font-size: 26px; font-weight: 700; letter-spacing: -.5px; margin-bottom: 8px; }
.login-title span { color: var(--green); }
.login-sub { font-size: 15px; color: var(--t2); line-height: 1.6; margin-bottom: 28px; }
.btn-google {
  display: flex; align-items: center; justify-content: center; gap: 10px;
  width: 100%; padding: 15px; background: var(--bg3); border: 1px solid var(--sep2);
  border-radius: var(--r-sm); color: var(--t1); font-size: 16px; font-weight: 600;
  transition: all .2s; margin-bottom: 12px;
}
.btn-google:hover { background: var(--bg4); border-color: var(--sep); }
.login-note { font-size: 13px; color: var(--t3); }

/* ‚ïê‚ïê‚ïê HEADER ‚ïê‚ïê‚ïê */
.hdr {
  position: sticky; top: 0; z-index: 200;
  height: 56px;
  background: rgba(0,0,0,.85);
  backdrop-filter: blur(20px) saturate(180%);
  -webkit-backdrop-filter: blur(20px) saturate(180%);
  border-bottom: 1px solid var(--sep2);
  display: flex; align-items: center; padding: 0 16px; gap: 10px;
}
.hdr-icon {
  width: 34px; height: 34px; border-radius: 9px; flex-shrink: 0;
  background: linear-gradient(135deg, var(--blue), var(--green));
  display: flex; align-items: center; justify-content: center; font-size: 17px;
}
.hdr-name { font-size: 16px; font-weight: 700; letter-spacing: -.3px; flex: 1; }
.hdr-right { display: flex; align-items: center; gap: 8px; flex-shrink: 0; }
.rate-chip {
  background: var(--bg3); border: 1px solid var(--sep2); padding: 5px 10px;
  border-radius: 20px; font-size: 12px; font-weight: 600;
  color: var(--t2); display: flex; align-items: center; gap: 6px;
}
.rate-chip .live-dot { width: 5px; height: 5px; border-radius: 50%; background: var(--green); animation: blink 2s infinite; flex-shrink: 0; }
@keyframes blink { 0%,100%{opacity:1} 50%{opacity:.3} }
.rate-chip .v { color: var(--gold); font-weight: 700; }
.ncm-chip { background: var(--bg3); border: 1px solid var(--sep2); padding: 5px 10px; border-radius: 20px; font-size: 12px; font-weight: 600; color: var(--t3); display: flex; align-items: center; gap: 5px; }
.ncm-chip .cnt { color: var(--green); font-weight: 700; }
.hdr-btn {
  height: 34px; padding: 0 12px; border-radius: var(--r-xs); background: var(--bg3);
  border: 1px solid var(--sep2); color: var(--t2); font-size: 13px; font-weight: 600;
  display: flex; align-items: center; gap: 5px; transition: all .15s;
}
.hdr-btn:hover { background: var(--bg4); color: var(--t1); }
.hdr-btn.lang { gap: 4px; }
.hdr-btn svg { flex-shrink: 0; }
.hdr-btn.spin svg { animation: spin .8s linear infinite; }
@keyframes spin { to { transform: rotate(360deg); } }

/* Sync + User */
.sync-chip {
  height: 34px; padding: 0 12px; border-radius: var(--r-xs);
  display: flex; align-items: center; gap: 6px;
  font-size: 13px; font-weight: 600; border: 1px solid;
  transition: all .2s; cursor: pointer;
}
.sync-chip.idle   { background: var(--green3); border-color: rgba(48,209,88,.25); color: var(--green); }
.sync-chip.syncing{ background: var(--blue3); border-color: rgba(10,132,255,.25); color: var(--blue); animation: blink .8s infinite; }
.sync-chip.error  { background: var(--red3); border-color: rgba(255,69,58,.25); color: var(--red); }
.user-chip {
  display: none; height: 34px; padding: 0 12px; border-radius: var(--r-xs);
  background: var(--bg3); border: 1px solid var(--sep2);
  align-items: center; gap: 7px; font-size: 13px; font-weight: 600; cursor: pointer;
}
.avatar-ring { width: 24px; height: 24px; border-radius: 50%; background: var(--blue); display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: 800; color: #000; flex-shrink: 0; }
.avatar-img  { width: 24px; height: 24px; border-radius: 50%; object-fit: cover; }

/* ‚ïê‚ïê‚ïê USER MENU ‚ïê‚ïê‚ïê */
.user-menu {
  position: fixed; top: 64px; right: 12px;
  background: rgba(28,28,30,.98); backdrop-filter: blur(20px);
  border: 1px solid var(--sep); border-radius: var(--r-sm);
  min-width: 200px; z-index: 300;
  box-shadow: 0 20px 60px rgba(0,0,0,.6); display: none;
}
.user-menu.open { display: block; animation: fadeDown .15s ease; }
@keyframes fadeDown { from { opacity:0; transform:translateY(-8px); } to { opacity:1; transform:none; } }
.um-hdr { padding: 14px 16px; border-bottom: 1px solid var(--sep2); }
.um-name  { font-size: 15px; font-weight: 600; }
.um-email { font-size: 12px; color: var(--t3); margin-top: 2px; }
.um-item  { padding: 11px 16px; font-size: 15px; font-weight: 500; color: var(--t1); display: flex; align-items: center; gap: 10px; transition: background .1s; }
.um-item:hover { background: var(--bg3); }
.um-item.danger { color: var(--red); }
.um-sep { height: 1px; background: var(--sep2); }

/* ‚ïê‚ïê‚ïê STEP TABS ‚ïê‚ïê‚ïê */
.tabs {
  display: flex; background: var(--bg1); border-bottom: 1px solid var(--sep2);
  overflow-x: auto; scrollbar-width: none; -webkit-overflow-scrolling: touch;
  gap: 0;
}
.tabs::-webkit-scrollbar { display: none; }
.tab {
  flex: 1; min-width: 60px; display: flex; flex-direction: column; align-items: center;
  padding: 9px 8px; cursor: pointer; position: relative; transition: all .2s;
  border-bottom: 2px solid transparent; gap: 3px;
}
.tab.active { border-bottom-color: var(--blue); }
.tab.done   { border-bottom-color: var(--green); }
.tab-num {
  width: 26px; height: 26px; border-radius: 50%;
  display: flex; align-items: center; justify-content: center;
  font-size: 13px; font-weight: 700;
  background: var(--bg3); color: var(--t3); border: 1.5px solid var(--sep2);
  transition: all .2s;
}
.tab.active .tab-num { background: var(--blue); color: #fff; border-color: var(--blue); box-shadow: 0 0 0 3px rgba(10,132,255,.2); }
.tab.done   .tab-num { background: var(--green3); color: var(--green); border-color: rgba(48,209,88,.4); font-size: 14px; }
.tab-label { font-size: 10px; font-weight: 600; color: var(--t3); text-transform: uppercase; letter-spacing: .04em; white-space: nowrap; transition: all .2s; }
.tab.active .tab-label { color: var(--blue); }
.tab.done   .tab-label { color: var(--green); }

/* ‚ïê‚ïê‚ïê PAGES ‚ïê‚ïê‚ïê */
.page { display: none; padding-bottom: calc(80px + var(--sab)); }
.page.active { display: block; animation: pageIn .2s ease; }
@keyframes pageIn { from { opacity:0; transform:translateY(4px); } to { opacity:1; transform:none; } }

/* ‚ïê‚ïê‚ïê SECTIONS / CARDS ‚ïê‚ïê‚ïê */
.section { margin: 12px; }
.section + .section { margin-top: 8px; }
.card {
  background: var(--bg2); border: 1px solid var(--sep2);
  border-radius: var(--r); overflow: visible;
}
.card-hdr {
  padding: 14px 16px 0;
  font-size: 12px; font-weight: 700; letter-spacing: .06em;
  text-transform: uppercase; color: var(--t3);
  display: flex; align-items: center; gap: 8px;
}
.card-hdr-dot { width: 6px; height: 6px; border-radius: 50%; flex-shrink: 0; }
.card-hdr-dot.blue  { background: var(--blue); }
.card-hdr-dot.green { background: var(--green); }
.card-hdr-dot.gold  { background: var(--gold); }
.card-hdr-dot.red   { background: var(--red); }

/* ‚ïê‚ïê‚ïê FORM FIELDS ‚ïê‚ïê‚ïê */
.fields { padding: 14px 16px; display: flex; flex-direction: column; gap: 12px; }
.field-group { display: flex; flex-direction: column; gap: 5px; }
.field-label {
  font-size: 13px; font-weight: 600; color: var(--t2);
  display: flex; align-items: center; justify-content: space-between;
}
.field-hint { font-size: 11px; color: var(--t3); font-weight: 400; }
.field-input {
  width: 100%; padding: 13px 14px;
  background: var(--bg3); border: 1.5px solid var(--sep2);
  border-radius: var(--r-xs); color: var(--t1);
  font-family: var(--f); font-size: 17px; font-weight: 500;
  outline: none; transition: border-color .15s, box-shadow .15s;
  -webkit-appearance: none; appearance: none;
}
.field-input:focus { border-color: var(--blue); box-shadow: 0 0 0 3px rgba(10,132,255,.15); }
.field-input::placeholder { color: var(--t4); font-size: 15px; font-weight: 400; }
.field-input[disabled] { color: var(--t3); cursor: default; opacity: .6; }
.field-input.mono { font-family: 'SF Mono', 'Fira Mono', monospace; }
.g2 { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
.g3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; }

/* ‚ïê‚ïê‚ïê PRODUCT HEADER ROW ‚ïê‚ïê‚ïê */
.prod-row { display: flex; gap: 12px; align-items: flex-start; }
.photo-slot {
  width: 76px; height: 76px; flex-shrink: 0;
  border-radius: var(--r-sm); border: 1.5px dashed var(--sep);
  background: var(--bg3); display: flex; flex-direction: column;
  align-items: center; justify-content: center; cursor: pointer;
  overflow: hidden; position: relative; transition: all .2s;
}
.photo-slot:hover, .photo-slot:active { border-color: var(--blue); background: var(--blue3); }
.photo-slot img { width: 100%; height: 100%; object-fit: cover; display: none; }
.photo-slot-idle { display: flex; flex-direction: column; align-items: center; gap: 3px; }
.photo-slot-idle .ico { font-size: 22px; }
.photo-slot-idle .lbl { font-size: 10px; font-weight: 600; color: var(--t3); }
.photo-slot-hover { position: absolute; inset: 0; background: rgba(0,0,0,.6); display: none; align-items: center; justify-content: center; font-size: 11px; font-weight: 700; color: #fff; }
.photo-slot:hover .photo-slot-hover { display: flex; }
.prod-name-col { flex: 1; display: flex; flex-direction: column; gap: 5px; }
.prod-name-col .field-label { font-size: 13px; }

/* ‚ïê‚ïê‚ïê NCM SEARCH ‚ïê‚ïê‚ïê */
.search-wrap { position: relative; }
.search-input {
  width: 100%; padding: 14px 44px 14px 16px;
  background: var(--bg3); border: 1.5px solid var(--sep2);
  border-radius: var(--r-xs); color: var(--t1);
  font-size: 17px; font-weight: 500; outline: none;
  transition: border-color .15s, box-shadow .15s; -webkit-appearance: none;
}
.search-input:focus { border-color: var(--blue); box-shadow: 0 0 0 3px rgba(10,132,255,.15); }
.search-input::placeholder { color: var(--t4); font-size: 15px; font-weight: 400; }
.search-icon { position: absolute; right: 14px; top: 50%; transform: translateY(-50%); color: var(--t3); font-size: 18px; pointer-events: none; }
.ncm-status-row { display: flex; align-items: center; gap: 8px; padding: 8px 0 0; font-size: 13px; color: var(--t3); }
.ncm-dot { width: 7px; height: 7px; border-radius: 50%; background: var(--t4); flex-shrink: 0; }
.ncm-dot.loading { background: var(--gold); animation: blink 1s infinite; }
.ncm-dot.ok      { background: var(--green); }
.ncm-dot.error   { background: var(--red); }
.search-status-bar { display: flex; align-items: center; gap: 7px; padding-top: 6px; font-size: 12px; color: var(--t3); min-height: 16px; }
.search-status-dot { font-size: 9px; flex-shrink: 0; color: var(--t4); }
.search-status-dot.ready    { color: var(--green); }
.search-status-dot.scanning { color: var(--gold); animation: blink 1s infinite; }

/* Autocomplete dropdown */
.ac-drop {
  position: absolute; top: calc(100% + 6px); left: 0; right: 0;
  background: rgba(28,28,30,.98); backdrop-filter: blur(20px);
  border: 1px solid var(--sep); border-radius: var(--r-sm);
  max-height: 300px; overflow-y: auto; z-index: 500; display: none;
  box-shadow: 0 20px 60px rgba(0,0,0,.7);
}
.ac-drop.open { display: block; }
.ac-group-label { padding: 8px 14px 4px; font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: .08em; color: var(--t3); border-bottom: 1px solid var(--sep2); }
.ac-item { padding: 12px 14px; cursor: pointer; border-bottom: 1px solid var(--sep2); display: flex; align-items: center; gap: 10px; transition: background .1s; }
.ac-item:last-child { border-bottom: none; }
.ac-item:hover, .ac-item.focused { background: var(--bg3); }
.ac-ncm { font-family: 'SF Mono', monospace; font-size: 11px; background: var(--bg4); color: var(--t3); padding: 3px 7px; border-radius: 5px; flex-shrink: 0; white-space: nowrap; }
.ac-desc-wrap { flex: 1; min-width: 0; }
.ac-desc { font-size: 15px; font-weight: 500; color: var(--t1); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.ac-sub  { font-size: 12px; color: var(--t3); margin-top: 2px; }
.ac-badge { font-size: 9px; font-weight: 700; background: linear-gradient(135deg,#7c3aed,#2563eb); color: #fff; padding: 2px 6px; border-radius: 4px; text-transform: uppercase; flex-shrink: 0; }

/* Product chip */
.product-chip {
  background: var(--green3); border: 1px solid rgba(48,209,88,.2);
  border-radius: var(--r-xs); padding: 12px 14px;
  margin-top: 10px; display: none; align-items: center; gap: 10px;
}
.product-chip.show { display: flex; }
.chip-icon { font-size: 20px; flex-shrink: 0; }
.chip-info { flex: 1; min-width: 0; }
.chip-name  { font-size: 15px; font-weight: 600; color: var(--green); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.chip-codes { font-size: 12px; color: var(--t3); margin-top: 2px; }
.chip-clear { background: transparent; border: none; color: var(--t3); font-size: 20px; line-height: 1; padding: 2px; transition: color .1s; }
.chip-clear:hover { color: var(--red); }

/* ‚ïê‚ïê‚ïê CAMERA ‚ïê‚ïê‚ïê */
.cam-card {
  background: var(--bg2); border: 1px solid var(--sep2); border-radius: var(--r);
  overflow: hidden;
}
.cam-idle {
  display: flex; align-items: center; gap: 14px; padding: 16px;
  cursor: pointer; transition: background .15s;
}
.cam-idle:hover { background: var(--bg3); }
.cam-idle-icon { font-size: 22px; width: 44px; height: 44px; border-radius: 11px; background: var(--bg3); border: 1px solid var(--sep2); display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
.cam-idle-body { flex: 1; }
.cam-idle-title { font-size: 16px; font-weight: 600; color: var(--t1); }
.cam-idle-sub   { font-size: 13px; color: var(--t3); margin-top: 2px; }
.cam-idle-arr   { color: var(--t3); font-size: 20px; }
.cam-preview { display: none; flex-direction: column; gap: 12px; padding: 16px; }
.cam-preview img { width: 100%; max-height: 220px; object-fit: cover; border-radius: var(--r-xs); }
.cam-spinner { width: 28px; height: 28px; border: 3px solid var(--gold3); border-top-color: var(--gold); border-radius: 50%; animation: spin .8s linear infinite; display: none; margin: 0 auto; }
.cam-spinner.active { display: block; }
.cam-result { display: none; background: var(--bg3); border: 1px solid var(--sep2); border-radius: var(--r-xs); padding: 12px 14px; font-size: 14px; color: var(--t2); line-height: 1.5; }
.cam-result.show { display: block; }
.cr-name { color: var(--gold); font-size: 16px; font-weight: 600; margin-bottom: 4px; }
.cr-ncm  { font-size: 13px; color: var(--t3); }
.cam-clear-btn { background: var(--bg3); border: 1px solid var(--sep2); color: var(--t2); padding: 8px 14px; border-radius: var(--r-xs); font-size: 14px; font-weight: 600; }

/* ‚ïê‚ïê‚ïê CURRENCY ROW ‚ïê‚ïê‚ïê */
.currency-row { display: flex; gap: 8px; }
.currency-badge {
  flex: 1; background: var(--bg3); border: 1px solid var(--sep2);
  border-radius: var(--r-xs); padding: 10px 12px; text-align: center;
}
.currency-badge.primary { border-color: rgba(10,132,255,.3); background: var(--blue3); }
.currency-badge .cb-label { font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: .05em; color: var(--t3); margin-bottom: 3px; }
.currency-badge .cb-val   { font-size: 16px; font-weight: 700; color: var(--t1); font-variant-numeric: tabular-nums; }
.currency-badge.primary .cb-val { color: var(--blue); }

/* ‚ïê‚ïê‚ïê DEST TABS ‚ïê‚ïê‚ïê */
.dest-row {
  display: flex; background: var(--bg3); border-radius: var(--r-xs);
  padding: 3px; gap: 3px;
}
.dest-btn {
  flex: 1; padding: 10px 8px; border-radius: calc(var(--r-xs) - 2px);
  background: transparent; border: none; color: var(--t3);
  font-size: 15px; font-weight: 600; transition: all .2s;
  display: flex; align-items: center; justify-content: center; gap: 5px;
}
.dest-btn:hover { color: var(--t2); background: var(--bg4); }
.dest-btn.br.active { background: var(--green); color: #000; }
.dest-btn.us.active { background: var(--blue); color: #fff; }
.dest-btn.both.active { background: var(--gold); color: #000; }

/* ‚ïê‚ïê‚ïê TOGGLE ‚ïê‚ïê‚ïê */
.toggle-row { display: flex; align-items: center; gap: 12px; padding: 4px 0; }
.toggle { position: relative; width: 44px; height: 26px; flex-shrink: 0; }
.toggle input { opacity: 0; width: 0; height: 0; }
.toggle-track { position: absolute; inset: 0; background: var(--bg4); border-radius: 13px; cursor: pointer; transition: background .25s; }
.toggle-track::before { content:''; position:absolute; width:20px; height:20px; left:3px; bottom:3px; background:#fff; border-radius:50%; transition:.25s; box-shadow:0 2px 6px rgba(0,0,0,.3); }
.toggle input:checked + .toggle-track { background: var(--green); }
.toggle input:checked + .toggle-track::before { transform: translateX(18px); }
.toggle-label { font-size: 15px; font-weight: 500; color: var(--t2); flex: 1; line-height: 1.4; }

/* ‚ïê‚ïê‚ïê SECTION COLLAPSE ‚ïê‚ïê‚ïê */
.collapsible { border-top: 1px solid var(--sep2); }
.collapsible-trigger {
  display: flex; align-items: center; justify-content: space-between;
  padding: 13px 16px; cursor: pointer; font-size: 14px; font-weight: 600; color: var(--t2);
  transition: background .1s;
}
.collapsible-trigger:hover { background: rgba(255,255,255,.03); }
.collapsible-trigger .arr { font-size: 12px; color: var(--t3); transition: transform .2s; }
.collapsible.open .collapsible-trigger .arr { transform: rotate(90deg); }
.collapsible-body { display: none; padding: 0 16px 16px; }
.collapsible.open .collapsible-body { display: block; }

/* ‚ïê‚ïê‚ïê MARKET INPUTS ‚ïê‚ïê‚ïê */
.mkt-input-block { background: var(--bg3); border: 1px solid var(--sep2); border-radius: var(--r-xs); padding: 14px; margin-bottom: 10px; }
.mkt-input-top { display: flex; align-items: center; gap: 12px; margin-bottom: 10px; }
.mkt-flag { font-size: 22px; }
.mkt-label-col { flex: 1; }
.mkt-platform { font-size: 13px; font-weight: 700; color: var(--t2); margin-bottom: 4px; }
.mkt-price-input { width: 100%; background: transparent; border: none; color: var(--t1); font-size: 28px; font-weight: 700; outline: none; font-variant-numeric: tabular-nums; }
.mkt-price-input::placeholder { color: var(--t4); font-size: 22px; font-weight: 400; }
.mkt-fees-row { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
.mkt-fee-field { display: flex; flex-direction: column; gap: 3px; }
.mkt-fee-label { font-size: 11px; font-weight: 600; color: var(--t3); text-transform: uppercase; letter-spacing: .04em; }
.mkt-fee-input { background: var(--bg4); border: 1px solid var(--sep2); border-radius: var(--r-xs); padding: 9px 11px; color: var(--t1); font-size: 15px; font-weight: 600; width: 100%; outline: none; transition: border-color .15s; }
.mkt-fee-input:focus { border-color: var(--blue); }

/* Auto price button */
.btn-auto-price {
  width: 100%; padding: 14px; border-radius: var(--r-xs);
  background: linear-gradient(135deg, rgba(10,132,255,.12), rgba(48,209,88,.08));
  border: 1px solid rgba(10,132,255,.3); color: var(--blue);
  font-size: 15px; font-weight: 700; display: flex; align-items: center; justify-content: center; gap: 9px;
  transition: all .2s;
}
.btn-auto-price:hover { background: rgba(10,132,255,.2); }
.btn-auto-price:disabled { opacity:.5; pointer-events:none; }
.btn-auto-price.loading { color: var(--gold); border-color: rgba(255,214,10,.3); background: var(--gold3); }
.btn-auto-price.success { color: var(--green); border-color: rgba(48,209,88,.3); background: var(--green3); }

.auto-price-status { background: var(--blue3); border: 1px solid rgba(10,132,255,.2); border-radius: var(--r-xs); padding: 12px 14px; display: flex; align-items: center; gap: 10px; font-size: 14px; color: var(--blue); }
.aps-spin { width: 16px; height: 16px; border: 2px solid rgba(10,132,255,.2); border-top-color: var(--blue); border-radius: 50%; animation: spin .7s linear infinite; flex-shrink: 0; }
.aps-step { font-size: 12px; color: var(--t3); margin-top: 2px; }
.auto-price-result { background: var(--green3); border: 1px solid rgba(48,209,88,.2); border-radius: var(--r-xs); padding: 13px 14px; }
.apr-title { font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: .07em; color: var(--green); margin-bottom: 10px; display: flex; align-items: center; gap: 6px; }
.apr-row { display: flex; justify-content: space-between; align-items: center; padding: 6px 0; border-bottom: 1px solid rgba(255,255,255,.06); }
.apr-row:last-of-type { border-bottom: none; }
.apr-k { font-size: 14px; color: var(--t2); }
.apr-v { display: flex; align-items: center; gap: 7px; }
.apr-price { font-size: 16px; font-weight: 700; color: var(--green); font-variant-numeric: tabular-nums; }
.apr-tag { font-size: 11px; background: var(--green3); color: var(--green); border: 1px solid rgba(48,209,88,.3); padding: 2px 6px; border-radius: 4px; }
.apr-use-btn { font-size: 12px; padding: 4px 10px; border-radius: 5px; background: var(--green2); border: 1px solid rgba(48,209,88,.3); color: var(--green); font-weight: 700; transition: all .12s; }
.apr-use-btn:hover { background: rgba(48,209,88,.3); }
.apr-source { font-size: 12px; color: var(--t3); margin-top: 9px; padding-top: 9px; border-top: 1px solid rgba(255,255,255,.06); display: flex; align-items: center; gap: 6px; }
.apr-source-dot { width: 5px; height: 5px; border-radius: 50%; background: var(--green); flex-shrink: 0; }

/* Market links */
.mkt-links { display: flex; gap: 8px; flex-wrap: wrap; }
.mkt-link-btn { flex: 1; min-width: 100px; padding: 11px 10px; background: var(--bg3); border: 1px solid var(--sep2); border-radius: var(--r-xs); color: var(--t2); font-size: 14px; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 6px; transition: all .15s; }
.mkt-link-btn:hover { border-color: var(--blue); color: var(--blue); background: var(--blue3); }

/* ‚ïê‚ïê‚ïê RESULTS ‚ïê‚ïê‚ïê */
.result-grid { display: flex; flex-direction: column; gap: 12px; padding: 12px; }

.r-card { border-radius: var(--r); padding: 20px; position: relative; overflow: hidden; }
.r-card.br { background: linear-gradient(135deg, rgba(48,209,88,.08), rgba(48,209,88,.03)); border: 1px solid rgba(48,209,88,.2); }
.r-card.us { background: linear-gradient(135deg, rgba(10,132,255,.08), rgba(10,132,255,.03)); border: 1px solid rgba(10,132,255,.2); }
.r-card-glow { position: absolute; top: -40px; right: -40px; width: 120px; height: 120px; border-radius: 50%; opacity: .06; pointer-events: none; }
.r-card.br .r-card-glow { background: var(--green); }
.r-card.us .r-card-glow { background: var(--blue); }

.r-flag { font-size: 28px; margin-bottom: 6px; display: block; }
.r-title { font-size: 20px; font-weight: 700; letter-spacing: -.3px; margin-bottom: 2px; }
.r-sub { font-size: 13px; color: var(--t3); margin-bottom: 16px; }

.cost-tbl { width: 100%; border-collapse: collapse; margin-bottom: 14px; }
.cost-tbl tr { border-bottom: 1px solid rgba(255,255,255,.05); }
.cost-tbl tr:last-child { border-bottom: none; }
.cost-tbl td { padding: 9px 0; font-size: 15px; }
.cost-tbl td.k { color: var(--t2); }
.cost-tbl td.v { text-align: right; font-weight: 600; font-variant-numeric: tabular-nums; }
.cost-tbl tr.total td { font-size: 17px; font-weight: 700; padding-top: 13px; border-top: 1.5px solid rgba(255,255,255,.1); border-bottom: none; }

.unit-cost-block { background: rgba(0,0,0,.3); border-radius: var(--r-xs); padding: 14px 16px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
.ucb-label { font-size: 13px; color: var(--t3); font-weight: 600; text-transform: uppercase; letter-spacing: .04em; }
.ucb-val   { font-size: 28px; font-weight: 700; font-variant-numeric: tabular-nums; letter-spacing: -.5px; }
.ucb-val.green { color: var(--green); }
.ucb-val.blue  { color: var(--blue); }

.profit-block { border-top: 1px solid rgba(255,255,255,.07); padding-top: 14px; }
.pb-row { display: flex; justify-content: space-between; align-items: center; padding: 7px 0; border-bottom: 1px solid rgba(255,255,255,.04); }
.pb-row:last-child { border-bottom: none; }
.pb-k { font-size: 15px; color: var(--t2); }
.pb-v { font-size: 15px; font-weight: 700; font-variant-numeric: tabular-nums; }

.verdict { border-radius: var(--r-xs); padding: 16px; text-align: center; margin-top: 16px; }
.verdict.win  { background: rgba(48,209,88,.12); border: 1px solid rgba(48,209,88,.25); }
.verdict.ok   { background: rgba(255,214,10,.10); border: 1px solid rgba(255,214,10,.25); }
.verdict.bad  { background: var(--red3); border: 1px solid rgba(255,69,58,.25); }
.verdict.none { background: var(--bg3); border: 1px solid var(--sep2); }
.verdict .em  { font-size: 28px; display: block; margin-bottom: 6px; }
.verdict .lb  { font-size: 17px; font-weight: 700; margin-bottom: 4px; }
.verdict .mg  { font-size: 36px; font-weight: 800; letter-spacing: -1px; font-variant-numeric: tabular-nums; line-height: 1; }
.verdict .sb  { font-size: 13px; color: var(--t3); margin-top: 4px; }
.v-green { color: var(--green); }
.v-yellow{ color: var(--gold); }
.v-red   { color: var(--red); }
.v-blue  { color: var(--blue); }
.v-muted { color: var(--t3); }

.cmp-card { background: var(--bg2); border: 1px solid var(--sep2); border-radius: var(--r); padding: 18px; }
.cmp-title { font-size: 12px; font-weight: 700; text-transform: uppercase; letter-spacing: .07em; color: var(--t3); margin-bottom: 14px; }
.cmp-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 12px; }
.cmp-box { background: var(--bg3); border: 1px solid var(--sep2); border-radius: var(--r-xs); padding: 14px; text-align: center; }
.cmp-box .lbl { font-size: 13px; color: var(--t3); margin-bottom: 6px; font-weight: 600; }
.cmp-box .big { font-size: 32px; font-weight: 800; letter-spacing: -1px; font-variant-numeric: tabular-nums; line-height: 1; }
.cmp-box .sub { font-size: 13px; color: var(--t3); margin-top: 5px; }
.winner-banner { background: rgba(255,214,10,.08); border: 1px solid rgba(255,214,10,.25); border-radius: var(--r-xs); padding: 14px 16px; text-align: center; }
.winner-banner .wt { font-size: 17px; font-weight: 800; color: var(--gold); }
.winner-banner .ws { font-size: 13px; color: var(--t3); margin-top: 3px; }
.flags-section { margin-top: 14px; padding-top: 14px; border-top: 1px solid var(--sep2); }
.flags-title { font-size: 12px; font-weight: 700; text-transform: uppercase; letter-spacing: .07em; color: var(--t3); margin-bottom: 8px; }
.flag-item { font-size: 14px; padding: 3px 0; color: var(--t2); }
.empty-state { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 60px 20px; text-align: center; gap: 10px; }
.empty-icon { font-size: 48px; opacity: .3; }
.empty-text { font-size: 16px; color: var(--t3); max-width: 260px; line-height: 1.5; font-weight: 500; }

/* ‚ïê‚ïê‚ïê ACTION BUTTONS ‚ïê‚ïê‚ïê */
.btn-row { display: flex; gap: 10px; padding: 12px; }
.btn-primary {
  flex: 1; padding: 15px; border-radius: var(--r-xs);
  background: var(--blue); color: #fff; border: none;
  font-size: 16px; font-weight: 700; transition: all .2s;
  display: flex; align-items: center; justify-content: center; gap: 7px;
  box-shadow: 0 4px 16px rgba(10,132,255,.35);
}
.btn-primary:hover { background: #1a8fff; }
.btn-primary.green { background: var(--green); color: #000; box-shadow: 0 4px 16px rgba(48,209,88,.3); }
.btn-primary.green:hover { background: #40e46b; }
.btn-primary.wa { background: var(--wa); box-shadow: 0 4px 16px rgba(37,211,102,.3); }
.btn-secondary {
  padding: 15px 18px; border-radius: var(--r-xs);
  background: var(--bg3); border: 1px solid var(--sep2); color: var(--t2);
  font-size: 16px; font-weight: 600; transition: all .2s;
  display: flex; align-items: center; gap: 6px;
}
.btn-secondary:hover { border-color: var(--sep); color: var(--t1); }
.btn-save-full { width: calc(100% - 24px); margin: 0 12px; padding: 16px; border-radius: var(--r-xs); background: var(--green); color: #000; border: none; font-size: 17px; font-weight: 700; display: flex; align-items: center; justify-content: center; gap: 8px; box-shadow: 0 4px 16px rgba(48,209,88,.25); transition: all .2s; }
.btn-save-full:hover { background: #40e46b; }
.btn-wa-full { width: calc(100% - 24px); margin: 8px 12px 0; padding: 16px; border-radius: var(--r-xs); background: var(--wa); color: #fff; border: none; font-size: 17px; font-weight: 700; display: flex; align-items: center; justify-content: center; gap: 8px; transition: opacity .2s; }
.btn-wa-full:hover { opacity: .9; }
.btn-reset-full { width: calc(100% - 24px); margin: 8px 12px 0; padding: 15px; border-radius: var(--r-xs); background: transparent; border: 1px solid var(--sep2); color: var(--t2); font-size: 16px; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 7px; transition: all .2s; }
.btn-reset-full:hover { border-color: var(--sep); color: var(--t1); }

/* ‚ïê‚ïê‚ïê BOTTOM NAV ‚ïê‚ïê‚ïê */
.page-nav {
  position: sticky; bottom: 0;
  background: linear-gradient(to top, var(--bg) 70%, transparent);
  padding: 12px 12px calc(12px + var(--sab));
  display: flex; gap: 10px;
}
.nav-next { flex: 1; padding: 16px; border-radius: var(--r-sm); background: var(--blue); color: #fff; border: none; font-size: 17px; font-weight: 700; transition: all .2s; box-shadow: 0 4px 16px rgba(10,132,255,.35); }
.nav-next:hover { background: #1a8fff; }
.nav-next.green { background: var(--green); color: #000; box-shadow: 0 4px 16px rgba(48,209,88,.3); }
.nav-back { padding: 16px 18px; border-radius: var(--r-sm); background: var(--bg3); border: 1px solid var(--sep2); color: var(--t2); font-size: 16px; font-weight: 600; transition: all .2s; }
.nav-back:hover { border-color: var(--sep); color: var(--t1); }

/* ‚ïê‚ïê‚ïê SAVED LIST ‚ïê‚ïê‚ïê */
.saved-container { margin: 12px; background: var(--bg2); border: 1px solid var(--sep2); border-radius: var(--r); overflow: hidden; }
.saved-header { display: flex; align-items: center; justify-content: space-between; padding: 14px 16px; border-bottom: 1px solid var(--sep2); }
.saved-header-left { display: flex; align-items: center; gap: 10px; }
.saved-title { font-size: 17px; font-weight: 700; }
.saved-badge { background: var(--gold); color: #000; font-size: 12px; font-weight: 800; padding: 3px 8px; border-radius: 12px; min-width: 22px; text-align: center; }
.saved-actions { display: flex; gap: 7px; flex-wrap: wrap; }
.btn-action-sm { background: var(--bg3); border: 1px solid var(--sep2); color: var(--t2); padding: 7px 12px; border-radius: var(--r-xs); font-size: 13px; font-weight: 600; transition: all .12s; white-space: nowrap; }
.btn-action-sm:hover { border-color: var(--sep); color: var(--t1); }
.saved-search-wrap { padding: 10px 12px; border-bottom: 1px solid var(--sep2); }
.saved-search-input {
  width: 100%; padding: 11px 14px 11px 38px; background: var(--bg3); border: 1px solid var(--sep2);
  border-radius: var(--r-xs); color: var(--t1); font-size: 15px; outline: none; transition: border-color .15s;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='rgba(255,255,255,.3)' viewBox='0 0 24 24'%3E%3Cpath d='M15.5 14h-.79l-.28-.27A6.47 6.47 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z'/%3E%3C/svg%3E");
  background-repeat: no-repeat; background-position: 12px center;
}
.saved-search-input:focus { border-color: var(--blue); }
.saved-list { max-height: 500px; overflow-y: auto; }
.saved-item { display: flex; align-items: flex-start; gap: 12px; padding: 14px 16px; border-bottom: 1px solid var(--sep2); transition: background .1s; }
.saved-item:last-child { border-bottom: none; }
.saved-item:hover { background: rgba(255,255,255,.02); }
.si-body { flex: 1; min-width: 0; }
.si-name { font-size: 16px; font-weight: 600; color: var(--t1); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-bottom: 6px; }
.si-chips { display: flex; flex-wrap: wrap; gap: 4px; margin-bottom: 6px; }
.si-chip { font-size: 12px; font-weight: 700; padding: 3px 8px; border-radius: 6px; border: 1px solid; font-variant-numeric: tabular-nums; }
.si-chip.gold   { background: var(--gold3); border-color: rgba(255,214,10,.3); color: var(--gold); }
.si-chip.green  { background: var(--green3); border-color: rgba(48,209,88,.3); color: var(--green); }
.si-chip.blue   { background: var(--blue3); border-color: rgba(10,132,255,.3); color: var(--blue); }
.si-chip.red    { background: var(--red3); border-color: rgba(255,69,58,.3); color: var(--red); }
.si-chip.muted  { background: var(--bg4); border-color: var(--sep2); color: var(--t3); }
.si-meta { font-size: 12px; color: var(--t3); }
.si-notes { font-size: 13px; color: var(--t3); margin-top: 4px; font-style: italic; }
.si-actions { display: flex; flex-direction: column; gap: 5px; flex-shrink: 0; }
.btn-si { background: var(--bg3); border: 1px solid var(--sep2); color: var(--t2); padding: 7px 10px; border-radius: var(--r-xs); font-size: 13px; font-weight: 600; transition: all .12s; white-space: nowrap; }
.btn-si.load { border-color: rgba(10,132,255,.3); color: var(--blue); }
.btn-si.load:hover { background: var(--blue3); }
.btn-si.wa { border-color: rgba(37,211,102,.3); color: var(--wa); }
.btn-si.wa:hover { background: rgba(37,211,102,.1); }
.btn-si.copy { color:#30d158; }
  .btn-si.del:hover { border-color: var(--red); color: var(--red); }
.saved-empty { padding: 40px 20px; text-align: center; color: var(--t3); }

/* ‚ïê‚ïê‚ïê MODALS ‚ïê‚ïê‚ïê */
.modal-overlay {
  position: fixed; inset: 0; z-index: 900;
  background: rgba(0,0,0,.75); backdrop-filter: blur(8px);
  display: none; align-items: flex-end; justify-content: center;
}
.modal-overlay.open { display: flex; }
.modal-sheet {
  background: rgba(28,28,30,.99); backdrop-filter: blur(20px);
  border-radius: var(--r-xl) var(--r-xl) 0 0; width: 100%; max-width: 600px;
  max-height: 92vh; overflow-y: auto;
  animation: sheetUp .28s cubic-bezier(.4,0,.2,1);
  border-top: 1px solid var(--sep);
}
@keyframes sheetUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
.modal-handle { width: 36px; height: 4px; background: rgba(255,255,255,.2); border-radius: 2px; margin: 10px auto 0; }
.modal-header { display: flex; align-items: flex-start; justify-content: space-between; padding: 20px 20px 0; gap: 12px; }
.modal-title { font-size: 20px; font-weight: 700; letter-spacing: -.3px; }
.modal-sub { font-size: 14px; color: var(--t3); margin-top: 4px; }
.modal-x { background: var(--bg3); border: none; color: var(--t2); width: 30px; height: 30px; border-radius: 50%; font-size: 16px; display: flex; align-items: center; justify-content: center; cursor: pointer; flex-shrink: 0; }
.modal-body { padding: 18px 20px; display: flex; flex-direction: column; gap: 14px; }
.modal-footer { padding: 12px 20px calc(20px + var(--sab)); display: flex; gap: 10px; border-top: 1px solid var(--sep2); }
.modal-label { font-size: 13px; font-weight: 600; color: var(--t2); margin-bottom: 6px; display: block; }
.modal-input { width: 100%; padding: 13px 14px; background: var(--bg3); border: 1.5px solid var(--sep2); border-radius: var(--r-xs); color: var(--t1); font-size: 16px; outline: none; transition: border-color .15s; -webkit-appearance: none; }
.modal-input:focus { border-color: var(--blue); }
.modal-select { width: 100%; padding: 13px 14px; background: var(--bg3); border: 1.5px solid var(--sep2); border-radius: var(--r-xs); color: var(--t1); font-size: 16px; outline: none; -webkit-appearance: none; }
.modal-textarea { width: 100%; padding: 13px 14px; background: var(--bg3); border: 1.5px solid var(--sep2); border-radius: var(--r-xs); color: var(--t2); font-size: 14px; height: 160px; resize: none; outline: none; line-height: 1.5; }
.who-badge { display: flex; align-items: center; gap: 12px; background: var(--bg3); border: 1px solid var(--sep2); border-radius: var(--r-xs); padding: 12px 14px; }
.wb-name  { font-size: 16px; font-weight: 600; }
.wb-email { font-size: 13px; color: var(--t3); margin-top: 2px; }
.trip-suggestions { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 8px; }
.trip-sug { background: var(--gold3); border: 1px solid rgba(255,214,10,.25); color: var(--gold); border-radius: 20px; padding: 5px 12px; font-size: 13px; font-weight: 600; cursor: pointer; }
.modal-footer .btn-cancel { padding: 14px 20px; background: var(--bg3); border: 1px solid var(--sep2); border-radius: var(--r-xs); color: var(--t2); font-size: 16px; font-weight: 600; }
.modal-footer .btn-confirm { flex: 1; padding: 14px; background: var(--green); color: #000; border: none; border-radius: var(--r-xs); font-size: 16px; font-weight: 700; }
.wa-note { display: flex; align-items: center; gap: 8px; font-size: 13px; color: var(--t3); }
.wa-dot  { width: 6px; height: 6px; border-radius: 50%; background: var(--wa); flex-shrink: 0; }
.btn-wa-send { flex: 1; padding: 14px; background: var(--wa); color: #fff; border: none; border-radius: var(--r-xs); font-size: 16px; font-weight: 700; display: flex; align-items: center; justify-content: center; gap: 8px; }
.btn-wa-copy { padding: 14px 18px; background: var(--bg3); border: 1px solid var(--sep2); border-radius: var(--r-xs); color: var(--t2); font-size: 16px; font-weight: 600; }

/* Save modal also uses .save-modal-overlay etc for compat with base JS */
.save-modal-overlay { position: fixed; inset: 0; z-index: 900; background: rgba(0,0,0,.75); backdrop-filter: blur(8px); display: none; align-items: flex-end; justify-content: center; }
.save-modal-overlay.open { display: flex; }
.save-modal-box { background: rgba(28,28,30,.99); border-radius: var(--r-xl) var(--r-xl) 0 0; width: 100%; max-width: 600px; max-height: 90vh; overflow-y: auto; animation: sheetUp .28s cubic-bezier(.4,0,.2,1); border-top: 1px solid var(--sep); }
.save-modal-hdr { display: flex; align-items: flex-start; justify-content: space-between; padding: 20px 20px 0; gap: 12px; }
.save-modal-title { font-size: 20px; font-weight: 700; }
.save-modal-sub   { font-size: 14px; color: var(--t3); margin-top: 4px; }
.save-modal-body  { padding: 18px 20px; display: flex; flex-direction: column; gap: 14px; }
.save-modal-footer{ padding: 12px 20px calc(20px + var(--sab)); display: flex; gap: 10px; border-top: 1px solid var(--sep2); }
.modal-close-x { background: var(--bg3); border: none; color: var(--t2); width: 30px; height: 30px; border-radius: 50%; font-size: 16px; display: flex; align-items: center; justify-content: center; cursor: pointer; }
.modal-label { font-size: 13px; font-weight: 600; color: var(--t2); margin-bottom: 6px; display: block; }
.modal-input { width: 100%; padding: 13px 14px; background: var(--bg3); border: 1.5px solid var(--sep2); border-radius: var(--r-xs); color: var(--t1); font-size: 16px; outline: none; transition: border-color .15s; }
.modal-input:focus { border-color: var(--blue); }

/* ‚ïê‚ïê‚ïê UTILITY ‚ïê‚ïê‚ïê */
.hidden { display: none !important; }
.fade-in { animation: pageIn .3s ease; }
.field-fetching input { background: linear-gradient(90deg, var(--bg3) 25%, var(--bg4) 50%, var(--bg3) 75%); background-size: 200% 100%; animation: shimmer 1.2s infinite; color: var(--t3); }
@keyframes shimmer { 0% { background-position: -200% 0; } 100% { background-position: 200% 0; } }
.section-title { font-size: 13px; font-weight: 700; color: var(--t3); text-transform: uppercase; letter-spacing: .07em; padding: 14px 16px 8px; }

  input[type=number]::-webkit-outer-spin-button,
  input[type=number]::-webkit-inner-spin-button { -webkit-appearance:none; margin:0; }
  input[type=number] { -moz-appearance:textfield; }
</style>
</head>
<body>

<!-- NCM bar -->
<div id="ncmStatus"></div>
<!-- Toast -->
<div id="toast"></div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê LOGIN ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="loginScreen">
  <div class="login-card">
    <span class="login-icon">üöÄ</span>
    <div class="login-title">Mavericks Import <span>Hunter</span></div>
    <div class="login-sub">Quem est√° usando agora?</div>
    <select id="userDropdown" style="width:100%;padding:14px;border-radius:12px;background:var(--bg3);border:1px solid var(--sep);color:var(--t1);font-size:16px;margin-bottom:16px;cursor:pointer">
      <option value="">‚Äî Selecionar usu√°rio ‚Äî</option>
    </select>
    <button onclick="confirmUserSelect()"
      style="width:100%;padding:14px;background:var(--green);color:#000;border:none;border-radius:12px;font-size:16px;font-weight:700;cursor:pointer">
      Entrar ‚Üí
    </button>
    <div class="login-note" style="margin-top:14px">Usu√°rios gerenciados em ‚öôÔ∏è Configura√ß√µes</div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê USER MENU ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="user-menu" id="userMenu">
  <div class="um-hdr"><div class="um-name" id="umName">‚Äî</div><div class="um-email" id="umEmail">‚Äî</div></div>
  <div class="um-sep"></div>
  <div class="um-item" onclick="openSheetConfig()">üìä Ver planilha Google Sheets</div>
  
  <div class="um-item" onclick="exportSaved()">‚¨áÔ∏è Exportar CSV</div>
  <div class="um-sep"></div>
  <div class="um-item danger" onclick="signOut()">‚éã Sair</div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SAVE MODAL (IDs must match base JS exactly) ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="save-modal-overlay" id="saveOverlay" onclick="onSaveOverlayClick(event)">
  <div class="save-modal-box">
    <div class="modal-handle"></div>
    <div class="save-modal-hdr">
      <div><div class="save-modal-title">‚≠ê Salvar Produto</div><div class="save-modal-sub">Salvo local + Google Sheets da equipe</div></div>
      <button class="modal-close-x" onclick="closeSaveModal()">√ó</button>
    </div>
    <div class="save-modal-body">
      <div>
        <label class="modal-label">Quem est√° salvando</label>
        <div class="who-badge">
          <div id="saveWhoAvatar" class="avatar-ring">?</div>
          <div><div class="wb-name" id="saveWhoName">‚Äî</div><div class="wb-email" id="saveWhoEmail">‚Äî</div></div>
        </div>
      </div>
      <div>
        <label class="modal-label">üìç Feira / Viagem</label>
        <input class="modal-input" type="text" id="tripTagInput" placeholder="Ex: Canton Fair 2026, Yiwu Mar/26‚Ä¶">
        <div class="trip-suggestions" id="tripSuggestions"></div>
      </div>
      <div>
        <label class="modal-label">üìù Observa√ß√µes</label>
        <input class="modal-input" type="text" id="saveNotesInput" placeholder="Ex: MOQ 100un, fornecedor confi√°vel‚Ä¶">
      </div>
    </div>
    <div class="save-modal-footer">
      <button class="btn-cancel" onclick="closeSaveModal()">Cancelar</button>
      <button class="btn-confirm" onclick="confirmSaveProduct()">‚úÖ Salvar</button>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SHEET CONFIG MODAL ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="save-modal-overlay" id="sheetConfigOverlay" onclick="onSheetConfigOverlayClick(event)">
  <div class="save-modal-box">
    <div class="modal-handle"></div>
    <div class="save-modal-hdr">
      <div><div class="save-modal-title">üìä Google Sheets</div></div>
      <button class="modal-close-x" onclick="closeSheetConfig()">√ó</button>
    </div>
    <div class="save-modal-body">
      <div style="background:var(--green3);border:1px solid rgba(48,209,88,.2);border-radius:var(--r-xs);padding:14px 16px;display:flex;justify-content:space-between;align-items:center">
        <span style="font-size:16px;font-weight:600;color:var(--green)">‚úì Mavericks Import Hunter</span>
        <a href="https://docs.google.com/spreadsheets/d/1-5T0nmavcCSDWYPC_uHwESKoGGaHSbZg_HJuO2eVpH8/edit" target="_blank" style="font-size:14px;color:var(--blue);text-decoration:none;font-weight:600">Abrir ‚Üó</a>
      </div>
    </div>
    <div class="save-modal-footer">
      <button class="btn-cancel" onclick="closeSheetConfig()">Fechar</button>
      
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê WA MODAL ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="modal-overlay" id="waOverlay" onclick="onOverlayClick(event)">
  <div class="modal-sheet">
    <div class="modal-handle"></div>
    <div class="modal-header">
      <div><div class="modal-title">üí¨ Compartilhar via WhatsApp</div><div class="modal-sub">Relat√≥rio profissional para parceiros</div></div>
      <button class="modal-x" onclick="closeWAModal()">√ó</button>
    </div>
    <div class="modal-body">
      <div>
        <label class="modal-label">Produtos a incluir</label>
        <select class="modal-select" id="waFilter" onchange="buildWAMessage()">
          <option value="current">üì¶ Este produto (atual)</option>
          <option value="all">Todos os salvos</option>
          <option value="viable">Vi√°veis (margem ‚â• 25%)</option>
          <option value="winners">Vencedores (margem ‚â• 35%)</option>
          <option value="today">Hoje</option>
          <option value="week">Esta semana</option>
          <option value="winners_today">üèÜ Vencedores de hoje</option>
          <option value="winners_week">üèÜ Vencedores desta semana</option>
        </select>
      </div>
      <div>
        <label class="modal-label">Contexto (opcional)</label>
        <input class="modal-input" type="text" id="waContext" placeholder="Ex: Canton Fair 2026 ‚Äî oportunidades Q3" oninput="buildWAMessage()">
      </div>
      <div>
        <label class="modal-label">N√∫mero WhatsApp destino (opcional)</label>
        <input class="modal-input" type="tel" id="waPhone" placeholder="+55 11 9 8765-4321">
      </div>
      <div>
        <label class="modal-label">Pr√©-visualiza√ß√£o</label>
        <textarea class="modal-textarea" id="waPreview" readonly></textarea>
      </div>
      <div class="wa-note"><span class="wa-dot"></span><span>Abre no WhatsApp Web ou app. Revise antes de enviar.</span></div>
    </div>
    <div class="modal-footer">
      <button class="btn-wa-send" onclick="openWhatsApp()">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/></svg>
        Abrir WhatsApp
      </button>
      <button class="btn-wa-copy" onclick="copyWAMessage()">üìã Copiar</button>
    </div>
  </div>
</div>

<!-- HIDDEN INPUTS -->
<input type="file" id="imgInput" accept="image/*" style="display:none" onchange="onPhotoSelected(event)">
<input type="file" id="photoUploadInput" accept="image/*" style="display:none" onchange="onProductPhotoSelected(event)">

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     HEADER
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<header class="hdr">
  <div class="hdr-icon">üöÄ</div>
  <div class="hdr-name">Mavericks Hunter</div>
  <div class="hdr-right">
    <div class="rate-chip">
      <span class="live-dot"></span>
      <span id="rBRL" class="v">‚Äì</span>
      <span style="opacity:.4">¬∑</span>
      <span id="rCNY" class="v">‚Äì</span>
      <span style="opacity:.3;font-size:11px" id="rateUpdated"></span>
    </div>
    <div class="ncm-chip"><span id="ncmPillText">NCM</span><span class="cnt" id="ncmCount">‚Äì</span></div>
    <button class="hdr-btn lang" id="btnLang" onclick="toggleLang()">
      <span id="langFlag">üá∫üá∏</span><span id="langLabel">EN</span>
    </button>
    
    <button onclick="window.open('https://docs.google.com/spreadsheets/d/1-5T0nmavcCSDWYPC_uHwESKoGGaHSbZg_HJuO2eVpH8/edit','_blank')" style="background:var(--bg2);border:1px solid var(--sep);border-radius:8px;padding:6px 10px;color:var(--t2);font-size:13px;cursor:pointer" title="Abrir planilha">üìä</button>
    <button id="settingsBtn" onclick="openSettings()" style="background:var(--bg2);border:1px solid var(--sep);border-radius:8px;padding:6px 10px;color:var(--t2);font-size:16px;cursor:pointer" title="Configura√ß√µes">‚öôÔ∏è</button>
    <div class="user-chip" id="userPill" onclick="toggleUserMenu()">
      <div class="avatar-ring" id="userAvatarFallback">?</div>
      <img id="userAvatarImg" class="avatar-img" src="" alt="" style="display:none">
      <span id="userNameLabel">‚Äî</span>
    </div>
    <button class="hdr-btn" id="btnRefresh" onclick="refreshAll()">
      <svg id="refreshSvg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M23 4v6h-6"/><path d="M1 20v-6h6"/><path d="M3.51 9a9 9 0 0114.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0020.49 15"/></svg>
      <span data-i18n="refresh">C√¢mbio</span>
    </button>
  </div>
</header>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê STEP TABS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="tabs">
  <div class="tab active" id="stab1" onclick="goToStep(1)"><div class="tab-num" id="sc1">1</div><div class="tab-label" id="sl1">Produto</div></div>
  <div class="tab"        id="stab2" onclick="goToStep(2)"><div class="tab-num" id="sc2">2</div><div class="tab-label" id="sl2">Pre√ßo</div></div>
  <div class="tab"        id="stab3" onclick="goToStep(3)"><div class="tab-num" id="sc3">3</div><div class="tab-label" id="sl3">Mercado</div></div>
  <div class="tab"        id="stab4" onclick="goToStep(4)"><div class="tab-num" id="sc4">4</div><div class="tab-label" id="sl4">Resultado</div></div>
  <div class="tab"        id="stab5" onclick="goToStep(5)"><div class="tab-num" id="sc5">5</div><div class="tab-label" id="sl5">Salvos</div></div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     PAGE 1: PRODUTO
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="page active" id="page1">

  <div class="section">
    <div class="card">
      <div class="card-hdr"><span class="card-hdr-dot blue"></span><span data-i18n="p1Title">Identifica√ß√£o do Produto</span></div>
      <div class="fields">
        <div class="prod-row">
          <div class="photo-slot" onclick="document.getElementById('photoUploadInput').click()" title="Adicionar foto">
            <img id="productPhotoImg" src="" alt="">
            <div class="photo-slot-idle" id="photoSlotIdle"><span class="ico">üì∑</span><span class="lbl">Foto</span></div>
            <div class="photo-slot-hover">Trocar</div>
          </div>
          <div class="prod-name-col">
            <div class="field-label"><span data-i18n="prodNameLabel">Nome do produto</span></div>
            <input type="text" class="field-input" id="prodNameInput"
              data-i18n-ph="prodNamePh"
              placeholder="Ex: √ìculos solar, drone, t√™nis‚Ä¶"
              oninput="onProdNameInput()" autocomplete="off">
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- NCM Search -->
  <div class="section">
    <div class="card">
      <div class="card-hdr"><span class="card-hdr-dot blue"></span><span data-i18n="searchLabel">Buscar NCM (11.000+ c√≥digos)</span></div>
      <div class="fields">
        <div class="search-wrap">
          <input type="text" class="search-input" id="srchInput"
            data-i18n-ph="searchPh"
            placeholder="Digite o produto (m√≠n. 2 letras)‚Ä¶"
            oninput="onSearch()" autocomplete="off" onkeydown="onKeyNav(event)">
          <span class="search-icon" id="srchIcon">‚åï</span>
          <div class="ac-drop" id="acDrop"></div>
        </div>
        <div class="ncm-status-row"><span class="ncm-dot" id="ncmDot"></span><span id="ncmMsg">Carregando base NCM‚Ä¶</span></div>
        <div class="search-status-bar"><span class="search-status-dot" id="searchStatusDot">‚óè</span><span id="searchStatusText"></span></div>
        <div class="product-chip" id="prodChip">
          <span class="chip-icon" id="chipIcon">üì¶</span>
          <div class="chip-info">
            <div class="chip-name" id="chipName">‚Äì</div>
            <div class="chip-codes" id="chipCodes">NCM ‚Äì | HTS ‚Äì</div>
          </div>
          <button class="chip-clear" onclick="clearProduct()">√ó</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Quick tags (hidden by default ‚Äî buildQuickTags() populates) -->
  <div class="quick-tags" id="quickTags" style="padding:0 12px 4px;display:flex;flex-wrap:wrap;gap:6px"></div>

  <!-- Camera AI -->
  <div class="section">
    <div class="cam-card">
      <div class="cam-idle" id="cameraIdle" onclick="document.getElementById('imgInput').click()">
        <div class="cam-idle-icon">üì∑</div>
        <div class="cam-idle-body">
          <div class="cam-idle-title" data-i18n="camTitle">Fotografar para identificar NCM (IA)</div>
          <div class="cam-idle-sub" data-i18n="camSub">IA analisa e sugere classifica√ß√£o aduaneira</div>
        </div>
        <span class="cam-idle-arr">‚Ä∫</span>
      </div>
      <div class="cam-preview" id="cameraPreview">
        <img id="previewImg" src="" alt="">
        <div class="cam-spinner" id="camSpinner"></div>
        <div class="cam-result" id="camResult"></div>
        <button class="cam-clear-btn" onclick="clearCamera()">‚Üê Nova foto</button>
      </div>
    </div>
  </div>

  <div class="page-nav">
    <button class="nav-next" onclick="goToStep(2)" data-i18n="btnNext1">Pr√≥ximo: Pre√ßo e Custos ‚Üí</button>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     PAGE 2: PRE√áO + LOG√çSTICA + IMPOSTOS
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="page" id="page2">

  <!-- Destination -->
  <div class="section">
    <div class="card">
      <div class="card-hdr"><span class="card-hdr-dot gold"></span><span data-i18n="destLabel">Destino de Importa√ß√£o</span></div>
      <div class="fields">
        <div class="dest-row">
          <button class="dest-btn br" id="dBR" onclick="setDest(0)">üáßüá∑ <span data-i18n="tabBR">Brasil</span></button>
          <button class="dest-btn both active" id="dBoth" onclick="setDest(2)">‚öñÔ∏è <span data-i18n="tabBoth">Ambos</span></button>
          <button class="dest-btn us" id="dUS" onclick="setDest(1)">üá∫üá∏ USA</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Price -->
  <div class="section">
    <div class="card">
      <div class="card-hdr"><span class="card-hdr-dot gold"></span><span data-i18n="pricingTitle">Pre√ßo China + Convers√£o em Tempo Real</span></div>
      <div class="fields">
        <!-- Live conversion display -->
        <div class="currency-row" id="priceDualDisplay" style="display:none">
          <div class="currency-badge primary"><div class="cb-label">USD</div><div class="cb-val" id="pdUSD">‚Äî</div></div>
          <div class="currency-badge"><div class="cb-label">R$ BRL</div><div class="cb-val" id="pdBRL">‚Äî</div></div>
          <div class="currency-badge"><div class="cb-label">¬• CNY</div><div class="cb-val" id="pdCNY">‚Äî</div></div>
        </div>
        <!-- BRL preview (original ID) -->
        <div id="brlPreview" style="display:none;background:var(--green3);border:1px solid rgba(48,209,88,.2);border-radius:var(--r-xs);padding:11px 14px;justify-content:space-between;align-items:center">
          <span style="font-size:13px;font-weight:600;color:var(--t3);text-transform:uppercase;letter-spacing:.04em">‚âà BRL</span>
          <span id="brlPreviewVal" style="font-size:18px;font-weight:700;color:var(--green);font-variant-numeric:tabular-nums">R$ ‚Äî</span>
        </div>
        <div class="g2">
          <div class="field-group">
            <div class="field-label" data-i18n="lblUSD">Pre√ßo USD / un</div>
            <input type="number" step="0.01" class="field-input mono" id="priceUSD" placeholder="0.00" oninput="onUSD()">
          </div>
          <div class="field-group">
            <div class="field-label" data-i18n="lblRMB">‚âà RMB / un</div>
            <input type="number" step="0.01" class="field-input mono" id="priceRMB" placeholder="0.00" oninput="onRMB()">
          </div>
        </div>
        <div class="field-group">
          <div class="field-label" data-i18n="lblQty">Quantidade (unidades)</div>
          <input type="number" step="1" class="field-input mono" id="qty" placeholder="100" oninput="calc()">
        </div>
        <!-- Exchange rates collapsible -->
        <div class="collapsible" id="exRateSection">
          <div class="collapsible-trigger" onclick="this.parentElement.classList.toggle('open')">
            <span>üí± <span data-i18n="exRateLabel">C√¢mbio (toque para ajustar)</span></span>
            <span class="arr">‚Ä∫</span>
          </div>
          <div class="collapsible-body">
            <div class="g2" style="margin-top:4px">
              <div class="field-group"><div class="field-label">USD ‚Üí BRL</div><input type="number" step="0.01" class="field-input mono" id="exBRL" placeholder="5.22" oninput="calc()"></div>
              <div class="field-group"><div class="field-label">CNY ‚Üí USD</div><input type="number" step="0.0001" class="field-input mono" id="exCNY" placeholder="0.1447" oninput="calc()"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Logistics -->
  <div class="section">
    <div class="card">
      <div class="card-hdr"><span class="card-hdr-dot blue"></span><span data-i18n="logisticsTitle">Log√≠stica Internacional</span></div>
      <div class="fields">
        <div class="g2">
          <div class="field-group"><div class="field-label" data-i18n="freightLabel">Frete Internacional USD</div><input type="number" step="10" class="field-input mono" id="freight" placeholder="800" oninput="calc()"></div>
          <div class="field-group"><div class="field-label" data-i18n="insuranceLabel">Seguro USD</div><input type="number" step="10" class="field-input mono" id="insurance" placeholder="50" oninput="calc()"></div>
        </div>
        <div class="g3">
          <div class="field-group">
            <div class="field-label" data-i18n="shipModeLabel">Modal</div>
            <select class="field-input" id="shipMode" onchange="calc()">
              <option value="0">üö¢ Mar√≠timo</option>
              <option value="1">‚úàÔ∏è A√©reo</option>
            </select>
          </div>
          <div class="field-group">
            <div class="field-label" data-i18n="contTypeLabel">Container</div>
            <select class="field-input" id="contType" onchange="calc()">
              <option value="0">FCL 20'</option>
              <option value="500">LCL</option>
              <option value="1200">FCL 40'</option>
            </select>
          </div>
          <div class="field-group">
            <div class="field-label" data-i18n="portLabel">Porto</div>
            <select class="field-input" id="portDest" onchange="calc()">
              <option value="santos">Santos SP</option>
              <option value="paranagua">Paranagu√° PR</option>
              <option value="itajai">Itaja√≠ SC</option>
              <option value="la">LA/Long Beach</option>
              <option value="ny">New York</option>
            </select>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- BR Taxes -->
  <div class="section" id="brTax">
    <div class="card">
      <div class="card-hdr"><span class="card-hdr-dot green"></span><span data-i18n="brTaxTitle">üáßüá∑ Impostos Brasil (auto pelo NCM)</span></div>
      <div class="fields">
        <div class="toggle-row">
          <label class="toggle"><input type="checkbox" id="simplified" onchange="calc()"><span class="toggle-track"></span></label>
          <span class="toggle-label" data-i18n="simplifiedLabel">Modo Simplificado ‚Äî China Gate / ‚â§ US$50 / Shopee</span>
        </div>
        <div class="g3">
          <div class="field-group"><div class="field-label">II %</div><input type="number" step="0.5" class="field-input mono" id="brII" placeholder="20" value="20" readonly style="cursor:not-allowed;opacity:.7" oninput="calc()"></div>
          <div class="field-group"><div class="field-label">IPI %</div><input type="number" step="0.5" class="field-input mono" id="brIPI" placeholder="0" value="15" readonly style="cursor:not-allowed;opacity:.7" oninput="calc()"></div>
          <div class="field-group"><div class="field-label">ICMS %</div><input type="number" step="0.5" class="field-input mono" id="brICMS" placeholder="18" value="18" readonly style="cursor:not-allowed;opacity:.7" oninput="calc()"></div>
        </div>
        <div class="g3">
          <div class="field-group"><div class="field-label">PIS %</div><input type="number" step="0.1" class="field-input mono" id="brPIS" placeholder="1.65" value="1.65" readonly style="cursor:not-allowed;opacity:.7" oninput="calc()"></div>
          <div class="field-group"><div class="field-label">COFINS %</div><input type="number" step="0.1" class="field-input mono" id="brCOFINS" placeholder="7.6" value="7.6" readonly style="cursor:not-allowed;opacity:.7" oninput="calc()"></div>
          <div class="field-group"><div class="field-label" data-i18n="fixedLabel">Fixos R$</div><input type="number" step="50" class="field-input mono" id="brFixed" placeholder="1164" oninput="calc()"></div>
        </div>
        <div style="font-size:13px;color:var(--t3);line-height:1.5;padding:4px 0">
          Impostos preenchidos automaticamente ao selecionar o NCM. II + IPI + ICMS + PIS/COFINS + AFRMM (fretes mar√≠timos) + Siscomex.
        </div>
      </div>
    </div>
  </div>

  <!-- US Taxes -->
  <div class="section" id="usTax">
    <div class="card">
      <div class="card-hdr"><span class="card-hdr-dot blue"></span><span data-i18n="usTaxTitle">üá∫üá∏ Impostos USA (Tarifas 2026)</span></div>
      <div class="fields">
        <div class="g2">
          <div class="field-group"><div class="field-label">HTS Base Duty %</div><input type="number" step="0.5" class="field-input mono" id="usDuty" placeholder="0" oninput="calc()"></div>
          <div class="field-group">
            <div class="field-label">Section 301 Tariff</div>
            <select class="field-input" id="us301" onchange="calc()">
              <option value="25">25% (padr√£o 2026)</option>
              <option value="7.5">7.5% (reduzido)</option>
              <option value="0">0% (isento)</option>
              <option value="100">100% (m√°x)</option>
            </select>
          </div>
        </div>
        <div class="g2">
          <div class="field-group"><div class="field-label">Broker + Fixos USD</div><input type="number" step="50" class="field-input mono" id="usFixed" placeholder="250" oninput="calc()"></div>
          <div class="field-group"><div class="field-label">MPF (auto)</div><input type="text" class="field-input mono" id="usMPF" placeholder="auto" disabled></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Margin target -->
  <div class="section">
    <div class="card">
      <div class="card-hdr"><span class="card-hdr-dot gold"></span><span data-i18n="marginTitle">Meta de Margem</span></div>
      <div class="fields">
        <div class="field-group">
          <div class="field-label" style="justify-content:space-between">
            <span data-i18n="minMarginLabel">Margem m√≠nima desejada</span>
            <span class="field-hint">‚Üí calcula pre√ßo sugerido</span>
          </div>
          <input type="number" step="1" class="field-input mono" id="minMargin" placeholder="25" oninput="calc()">
        </div>
      </div>
    </div>
  </div>

  <div class="page-nav">
    <button class="nav-back" onclick="goToStep(1)">‚Üê</button>
    <button class="nav-next" onclick="goToStep(3)" data-i18n="btnNext2">Mercado de Venda ‚Üí</button>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     PAGE 3: MERCADO
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="page" id="page3">

  <div class="section">
    <div class="card">
      <div class="card-hdr"><span class="card-hdr-dot gold"></span><span data-i18n="mktTitle">Pre√ßo dos Concorrentes</span></div>
      <div class="fields">
        <div style="font-size:14px;color:var(--t3);line-height:1.5">
          Insira o pre√ßo praticado pelos concorrentes. O sistema calcula sua margem real ap√≥s as taxas.
        </div>

        <!-- BR market ‚Äî id=fML for JS compat -->
        <div id="fML" class="mkt-input-block">
          <div class="mkt-input-top">
            <span class="mkt-flag">üáßüá∑</span>
            <div class="mkt-label-col">
              <div class="mkt-platform">Mercado Livre / Brasil</div>
              <input type="number" class="mkt-price-input" id="mlPrice" step="0.01" placeholder="R$ 0,00" oninput="calc()">
            </div>
          </div>
          <div id="fMLFee" class="mkt-fees-row">
            <div class="mkt-fee-field"><div class="mkt-fee-label">Taxa ML % <span style="color:var(--t4)">padr√£o 15,5%</span></div><input type="number" step="0.5" class="mkt-fee-input" id="mlFee" placeholder="15.5" oninput="calc()"></div>
            <div class="mkt-fee-field"><div class="mkt-fee-label">Frete/Envio BR R$</div><input type="number" step="1" class="mkt-fee-input" id="mlShip" placeholder="0" oninput="calc()"></div>
          </div>
        </div>

        <!-- US market ‚Äî id=fAMZ -->
        <div id="fAMZ" class="mkt-input-block">
          <div class="mkt-input-top">
            <span class="mkt-flag">üá∫üá∏</span>
            <div class="mkt-label-col">
              <div class="mkt-platform">Amazon USA</div>
              <input type="number" class="mkt-price-input" id="amzPrice" step="0.01" placeholder="$ 0.00" oninput="calc()">
            </div>
          </div>
          <div id="fAMZFee" class="mkt-fees-row">
            <div class="mkt-fee-field"><div class="mkt-fee-label">Taxa Amazon % <span style="color:var(--t4)">padr√£o 15%</span></div><input type="number" step="0.5" class="mkt-fee-input" id="amzFee" placeholder="15" oninput="calc()"></div>
            <div class="mkt-fee-field"><div class="mkt-fee-label">FBA / Envio USD</div><input type="number" step="0.5" class="mkt-fee-input" id="amzShip" placeholder="3.50" oninput="calc()"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Research links + auto price -->
  <div class="section">
    <div class="card">
      <div class="card-hdr"><span class="card-hdr-dot blue"></span><span data-i18n="researchTitle">Pesquisar Pre√ßos Online</span></div>
      <div class="fields">
        <div class="mkt-links">
          <button class="mkt-link-btn" onclick="openML()">üõí Mercado Livre</button>
          <button class="mkt-link-btn" onclick="openAMZbr()">üì¶ Amazon BR</button>
          <button class="mkt-link-btn" onclick="openAMZus()">üì¶ Amazon US</button>
          <button class="mkt-link-btn" onclick="openTrends()">üìà Trends</button>
        </div>
        <button class="btn-auto-price" id="btnAutoPrice" onclick="fetchMarketPrices()">
          <span id="apBtnIcon">ü§ñ</span>
          <span id="apBtnText" data-i18n="autoPriceBtn">Buscar Pre√ßos Automaticamente (IA)</span>
        </button>
        <div class="auto-price-status" id="apStatus" style="display:none">
          <div class="aps-spin"></div>
          <div><div id="apStatusMsg">Buscando‚Ä¶</div><div class="aps-step" id="apStatusStep"></div></div>
        </div>
        <div id="apResult"></div>
      </div>
    </div>
  </div>

  <div class="page-nav">
    <button class="nav-back" onclick="goToStep(2)">‚Üê</button>
    <button class="nav-next green" onclick="goToStep(4)" data-i18n="btnCalc">Calcular Resultado ‚Üí</button>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     PAGE 4: RESULTADO
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="page" id="page4">

  <div class="result-grid" id="resultsArea">
    <div class="empty-state">
      <div class="empty-icon">‚ö°</div>
      <div class="empty-text">Preencha produto e pre√ßo nas etapas anteriores para ver o resultado.</div>
    </div>
  </div>

  <button class="btn-save-full" onclick="openSaveModal()">‚òÖ <span data-i18n="btnSave">Salvar Produto</span></button>
  <button class="btn-wa-full" onclick="openWAModal()">
    <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/></svg>
    <span data-i18n="btnWA">Compartilhar via WhatsApp</span>
  </button>
  <button class="btn-reset-full" onclick="resetAll()">‚Ü∫ <span data-i18n="btnReset">Nova Busca</span></button>

  <div class="page-nav">
    <button class="nav-back" onclick="goToStep(3)">‚Üê</button>
    <button class="nav-next" onclick="goToStep(5)" data-i18n="btnSavedNav">üìã Produtos Salvos ‚Üí</button>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     PAGE 5: SALVOS
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="page" id="page5">
  <div class="saved-container">
    <div class="saved-header">
      <div class="saved-header-left">
        <div class="saved-title" data-i18n="savedTitle">üì¶ Produtos Salvos</div>
        <div class="saved-badge" id="savedCount">0</div>
      </div>
      <div class="saved-actions">
        <button class="btn-action-sm" onclick="openWAModal()">üí¨ WA</button>
        <button class="btn-action-sm" onclick="exportSaved()">‚¨á CSV</button>
        
        <button class="btn-action-sm" onclick="clearAllSaved()" style="color:var(--red)">Limpar</button>
      </div>
    </div>
    <div class="saved-filters" style="display:flex;gap:8px;flex-wrap:wrap;padding:0 16px 12px">
      <input type="text" class="saved-search-input" id="savedSearchInput" placeholder="üîç Buscar nome, NCM‚Ä¶" oninput="applyFilter()" style="flex:1;min-width:140px">
      <select id="filterMargin" onchange="applyFilter()" style="background:var(--bg2);border:1px solid var(--sep);color:var(--t1);border-radius:8px;padding:8px;font-size:13px">
        <option value="all">üìä Todas margens</option>
        <option value="winners">üèÜ Vencedores ‚â•35%</option>
        <option value="viable">‚úÖ Vi√°veis ‚â•25%</option>
        <option value="bad">‚ùå N√£o vi√°veis</option>
      </select>
      <select id="filterDate" onchange="applyFilter()" style="background:var(--bg2);border:1px solid var(--sep);color:var(--t1);border-radius:8px;padding:8px;font-size:13px">
        <option value="all">üìÖ Todas datas</option>
        <option value="today">Hoje</option>
        <option value="week">Esta semana</option>
      </select>
    </div>
    <div class="saved-list" id="savedList">
      <div class="saved-empty">üì≠ Nenhum produto salvo ainda.</div>
    </div>
  </div>

  <div class="page-nav">
    <button class="nav-next" onclick="goToStep(1)" data-i18n="btnNewProduct">+ Analisar Novo Produto</button>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     SCRIPT 1 ‚Äî WIZARD + EXTRA FUNCTIONS
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->


<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     SCRIPT 2 ‚Äî BASE JS (v99c patched)
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<script>
'use strict';

// ‚îÄ‚îÄ WIZARD ‚îÄ‚îÄ
let currentStep = 1;

function goToStep(n) {
  const total = 5;
  if (n < 1 || n > total) return;
  for (let i = 1; i <= total; i++) {
    const pg  = document.getElementById('page' + i);
    const tab = document.getElementById('stab' + i);
    const sc  = document.getElementById('sc' + i);
    const sl  = document.getElementById('sl' + i);
    if (pg)  pg.style.display = (i === n) ? 'block' : 'none';
    if (!tab) continue;
    tab.className = 'tab' + (i < n ? ' done' : i === n ? ' active' : '');
    if (sc) { sc.className = 'tab-num' + (i < n ? ' done' : i === n ? ' active' : ''); sc.textContent = i < n ? '‚úì' : String(i); }
    if (sl) { sl.className = 'tab-label' + (i < n ? ' done' : i === n ? ' active' : ''); }
  }
  const bd = document.getElementById('brTax');
  const ud = document.getElementById('usTax');
  if (bd) bd.style.display = (typeof currentDest === 'undefined' || currentDest === 0 || currentDest === 2) ? 'block' : 'none';
  if (ud) ud.style.display = (typeof currentDest === 'undefined' || currentDest === 1 || currentDest === 2) ? 'block' : 'none';
  if (n === 4) setTimeout(() => { try { calc(); } catch(e){} }, 80);
  if (n === 5) { try { renderSaved(); } catch(e){} }
  currentStep = n;
  window.scrollTo(0, 0);
}

// ‚îÄ‚îÄ PRODUCT PHOTO ‚îÄ‚îÄ
window._productPhoto = '';

function onProductPhotoSelected(event) {
  const file = event.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = e => {
    window._productPhoto = e.target.result;
    const img  = document.getElementById('productPhotoImg');
    const idle = document.getElementById('photoSlotIdle');
    if (img)  { img.src = e.target.result; img.style.display = 'block'; }
    if (idle) idle.style.display = 'none';
    showToast('üì∑ Foto salva!');
  };
  reader.readAsDataURL(file);
  event.target.value = '';
}

// ‚îÄ‚îÄ PROD NAME ‚Üí NCM search bridge ‚îÄ‚îÄ
function onProdNameInput() {
  const name = (document.getElementById('prodNameInput').value || '').trim();
  const srch = document.getElementById('srchInput');
  if (srch && name.length >= 2 && !srch.value.trim()) {
    srch.value = name;
    if (typeof onSearch === 'function') onSearch();
  }
}

// ‚îÄ‚îÄ CURRENCY DUAL DISPLAY ‚îÄ‚îÄ
function updatePriceDual() {
  const usd = parseFloat(document.getElementById('priceUSD')?.value) || 0;
  const dd  = document.getElementById('priceDualDisplay');
  if (!usd || !dd) return;
  const exB = parseFloat(document.getElementById('exBRL')?.value) || (typeof usdBRL !== 'undefined' ? usdBRL : 5.22);
  const exC = parseFloat(document.getElementById('exCNY')?.value) || (typeof cnyUSD !== 'undefined' ? cnyUSD : 0.1447);
  dd.style.display = 'flex';
  const u = document.getElementById('pdUSD'); if(u) u.textContent = 'US$ ' + usd.toFixed(2);
  const b = document.getElementById('pdBRL'); if(b) b.textContent = 'R$ ' + (usd * exB).toLocaleString('pt-BR', {minimumFractionDigits:2, maximumFractionDigits:2});
  const c = document.getElementById('pdCNY'); if(c) c.textContent = '¬• ' + (usd / (exC||.1447)).toFixed(0);
}

// ‚îÄ‚îÄ SAVED SEARCH FILTER ‚îÄ‚îÄ
function applyFilter() {
  var q      = (document.getElementById("savedSearchInput")?.value||"").toLowerCase().trim();
  var margin = document.getElementById("filterMargin")?.value||"all";
  var dateF  = document.getElementById("filterDate")?.value||"all";
  var today  = new Date().toLocaleDateString("pt-BR");
  var weekAgo= Date.now()-7*24*60*60*1000;
  var visible=0;
  savedProducts.forEach(function(p,i){
    var el=document.querySelector('[data-idx="'+i+'"]');
    if(!el) return;
    var show=true;
    if(q && !(p.name||"").toLowerCase().includes(q) && !(p.ncm||"").includes(q)) show=false;
    var best=Math.max(p.brMargin??-999,p.usMargin??-999);
    if(margin==="winners"&&best<35) show=false;
    if(margin==="viable"&&best<25) show=false;
    if(margin==="bad"&&best>=25) show=false;
    if(dateF==="today"){var isT=(p.savedDate===today)||(p.id&&new Date(p.id).toLocaleDateString("pt-BR")===today);if(!isT)show=false;}
    if(dateF==="week"){var ts=p.id?(typeof p.id==="number"?p.id:new Date(p.id).getTime()):0;if(ts<weekAgo)show=false;}
    el.style.display=show?"":"none";
    if(show)visible++;
  });
  var badge=document.getElementById("savedCount");
  if(badge) badge.textContent=visible+"/"+savedProducts.length;
}

// ‚îÄ‚îÄ SHARE SINGLE PRODUCT VIA WA ‚îÄ‚îÄ
function shareOneProduct(i) {
  const p = (typeof savedProducts !== 'undefined' ? savedProducts : [])[i];
  if (!p) return;
  const isEN = typeof lang !== 'undefined' && lang === 'en';
  const f2 = v => parseFloat(v||0).toFixed(2);
  const lines = [
    'üöÄ *MAVERICKS IMPORT HUNTER*',
    '',
    `üì¶ *${p.name}*`,
    p.ncm && p.ncm !== '‚Äì' ? `NCM: \`${p.ncm}\`` : '',
    p.priceUSD ? `üí∞ ${isEN?'Purchase':'Compra'}: US$ ${f2(p.priceUSD)}${p.priceRMB ? ' / ¬•' + f2(p.priceRMB) : ''}` : '',
    p.qty ? `üì¶ ${isEN?'Qty':'Qtd'}: ${parseInt(p.qty).toLocaleString()} ${isEN?'units':'un'}` : '',
    ''
  ];
  if (p.brUnitCost != null) {
    lines.push('üáßüá∑ *Brasil*');
    lines.push(`   ${isEN?'Unit cost':'Custo unit√°rio'}: R$ ${f2(p.brUnitCost)}`);
    if (p.mlPrice) lines.push(`   ${isEN?'Sale price (ML)':'Venda (ML)'}: R$ ${f2(p.mlPrice)}`);
    if (p.brMargin != null) lines.push(`   ${isEN?'Margin':'Margem'}: *${p.brMargin.toFixed(1)}%* ${p.brMargin>=35?'üèÜ':p.brMargin>=25?'‚úÖ':p.brMargin>=10?'‚ö†Ô∏è':'‚ùå'}`);
    if (p.brSuggest) lines.push(`   ${isEN?'Suggested price':'Pre√ßo sugerido'}: R$ ${f2(p.brSuggest)}`);
    lines.push('');
  }
  if (p.usUnitCost != null) {
    lines.push('üá∫üá∏ *USA*');
    lines.push(`   ${isEN?'Unit cost':'Custo unit√°rio'}: US$ ${f2(p.usUnitCost)}`);
    if (p.amzPrice) lines.push(`   ${isEN?'Sale price (AMZ)':'Venda (AMZ)'}: US$ ${f2(p.amzPrice)}`);
    if (p.usMargin != null) lines.push(`   ${isEN?'Margin':'Margem'}: *${p.usMargin.toFixed(1)}%* ${p.usMargin>=35?'üèÜ':p.usMargin>=25?'‚úÖ':p.usMargin>=10?'‚ö†Ô∏è':'‚ùå'}`);
    if (p.usSuggest) lines.push(`   ${isEN?'Suggested price':'Pre√ßo sugerido'}: US$ ${f2(p.usSuggest)}`);
    lines.push('');
  }
  if (p.trip) lines.push(`üìç ${p.trip}`);
  if (p.notes) lines.push(`üìù ${p.notes}`);
  if (p.userName) lines.push(`üë§ ${p.userName}`);
  lines.push('');
  lines.push('_Mavericks Import Hunter_');
  const msg = lines.filter(l => l !== null && l !== undefined).join('\n');
  const url = 'https://wa.me/?text=' + encodeURIComponent(msg);
  window.open(url, '_blank');
}

'use strict';

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// I18N ‚Äî BILINGUAL SYSTEM
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let lang = localStorage.getItem('mavLang') || 'pt';

const STRINGS = {
  pt: {
    // Header
    refresh: 'Atualizar',
    hdrSub: 'Custo Real Desembarcado ‚Ä¢ China ‚Üí BR / USA ‚Ä¢ v96',
    // Tabs
    tabBR: 'Brasil', tabBoth: 'Comparar Ambos',
    // NCM pill
    ncmCodes: 'c√≥digos NCM',
    // Search
    searchLabel: 'Produto (busca em toda base NCM)',
    searchPh: 'Ex: √≥culos, c√¢mera, drone, perfume‚Ä¶',
    ncmLoadingMsg: 'Carregando base NCM completa do governo federal...',
    ncmOkMsg: 'c√≥digos NCM oficiais carregados',
    ncmCacheMsg: 'c√≥digos NCM carregados (cache local)',
    ncmErrMsg: 'Usando base local. Verifique a conex√£o.',
    ncmUpdating: 'Atualizando...',
    acGroupBuiltin: '‚ö° Produtos com taxas padr√£o',
    acGroupAll: 'üìã Todos NCM oficiais',
    selected: 'selecionado',
    // Pricing
    pricingTitle: 'Pre√ßo China + Quantidade',
    lblUSD: 'Pre√ßo China USD/un',
    lblRMB: '‚âà RMB/un (auto)',
    lblBRLPreview: '‚âà Custo China em R$',
    lblQty: 'Quantidade (unid.)',
    lblMonthly: 'Vendas/m√™s (unid.)',
    // Logistics
    logisticsTitle: 'Log√≠stica Internacional',
    lblFreight: 'Frete Internacional USD',
    lblInsurance: 'Seguro USD',
    lblModal: 'Modal',
    optSea: 'üö¢ Mar√≠timo',
    optAir: '‚úàÔ∏è A√©reo',
    lblContainer: 'Container',
    lblPort: 'Destino Porto',
    // Market
    marketTitle: 'Pesquisa de Mercado',
    lblMLPrice: 'Pre√ßo ML / Amazon BR (R$)',
    lblAMZPrice: 'Pre√ßo Amazon USA (USD)',
    lblMLFee: 'Taxa Marketplace BR %',
    lblAMZFee: 'Taxa Amazon USA %',
    lblMinMargin: 'Margem m√≠nima desejada %',
    // BR Taxes
    brTaxTitle: 'Impostos Brasil',
    simplifiedLabel: 'Modo Simplificado ‚Äî China Gate / Shopee / Importa√ß√£o pessoal ‚â§ US$50',
    lblBRFixed: 'Desp. Fixas R$',
    lblExBRL: 'C√¢mbio USD‚ÜíBRL (live)',
    lblExCNY: 'C√¢mbio CNY‚ÜíUSD (live)',
    // US Taxes
    usTaxTitle: 'Impostos USA',
    lblBaseDuty: 'Base Duty (HTS) %',
    lblSect301: 'Section 301 Tariff (China) %',
    opt301a: '25% ‚Äî padr√£o 2026',
    opt301c: '0% ‚Äî isento',
    lblUSFixed: 'Broker + Fixos (USD)',
    lblMPF: 'MPF (auto-calculado)',
    // Empty state
    emptyState: 'Selecione um produto e preencha os valores para ver o c√°lculo completo de custo e viabilidade.',
    // Results ‚Äî BR
    brTitle: 'Brasil ‚Äî Custo Desembarcado',
    brSub: 'Santos + Impostos + Despachante',
    cifLabel: 'CIF (USD √ó c√¢mbio)',
    iiLabel: 'Imposto Importa√ß√£o',
    ipiLabel: 'IPI',
    pisCofLabel: 'PIS + COFINS',
    icmsLabel: 'ICMS',
    fixedLabel: 'Despesas Fixas',
    totalLotLabel: 'üí∞ Total Lote',
    unitCostLabel: 'üì¶ Custo Unit√°rio',
    suggestLabel: 'üí° PRE√áO SUGERIDO',
    suggestSuffix: 'margem',
    mlPriceLabel: 'Pre√ßo Mercado Livre',
    netRecLabel: 'Recebido l√≠quido',
    profitUnitLabel: 'Lucro/unidade',
    roiLabel: 'ROI',
    monthlyProfitLabel: 'Lucro mensal',
    insertMLPrice: 'Insira o pre√ßo Mercado Livre',
    toSeeViability: 'para ver a viabilidade',
    // Results ‚Äî US
    usTitle: 'USA ‚Äî True Landed Cost',
    usSub: 'LA / NY + Duties + Broker',
    cifUSLabel: 'CIF (goods + freight + insurance)',
    dutyLabel: 'Base Duty + Sect.301',
    mpfLabel: 'Merchandise Processing Fee',
    brokerLabel: 'Broker + Fixed Fees',
    totalLandedLabel: 'üí∞ Total Landed',
    unitLandedLabel: 'üì¶ Unit Landed Cost',
    suggestUSLabel: 'üí° SUGGESTED PRICE',
    amzPriceLabel: 'Amazon Price',
    netAfterLabel: 'Net after Amazon fee',
    profitUnitUSLabel: 'Profit/unit',
    monthlyProfitUSLabel: 'Monthly profit',
    enterAMZPrice: 'Enter Amazon price',
    toSeeViabilityEN: 'to see viability',
    verdictSub: 'margem l√≠quida ap√≥s comiss√£o marketplace',
    monthlyEst: 'Lucro mensal estimado',
    // Verdict labels
    v_winner: 'PRODUTO VENCEDOR!',
    v_good: 'BOM PARA IMPORTAR',
    v_marginal: 'MARGINAL ‚Äî CUIDADO',
    v_bad: 'N√ÉO VI√ÅVEL',
    // Compare
    cmpTitle: '‚öñÔ∏è Comparativo de Mercados',
    cmpBRLabel: 'üáßüá∑ Brasil ‚Äî Margem',
    cmpUSLabel: 'üá∫üá∏ USA ‚Äî Margin',
    cmpSuggestBR: 'Pre√ßo sugerido',
    cmpSuggestUS: 'Suggested',
    brWinner: 'üáßüá∑ Brasil √© a melhor oportunidade',
    usWinner: 'üá∫üá∏ USA √© a melhor oportunidade',
    brWinSub: 'pp de vantagem de margem no Brasil',
    usWinSub: 'pp margin advantage in USA',
    riskTitle: 'üö¶ An√°lise de Risco',
    flagBRLow: 'BR: margem abaixo do m√≠nimo desejado de',
    flagUSLow: 'USA: margem abaixo do m√≠nimo desejado de',
    flagBRHigh: 'BR: margem excepcional ‚Äî produto vencedor!',
    flagUSHigh: 'USA: margem excepcional ‚Äî winner product!',
    flagBRCost: 'BR: custo unit√°rio representa mais de 80% do pre√ßo de venda',
    flagUSCost: 'USA: unit cost exceeds 85% of sale price',
    flagNone: 'Nenhum alerta ‚Äî adicione pre√ßos de mercado para an√°lise completa',
    // Toasts
    toastRefreshed: '‚úÖ Cota√ß√µes e base NCM atualizadas!',
    toastSelectSuffix: 'selecionado',
    unitAbbr: 'un',
    btnReset: 'Nova Busca',
    btnSave: 'Salvar Produto',
    savedTitle: 'Produtos Salvos',
    btnClearAll: 'Limpar Tudo',
    savedEmpty: 'Nenhum produto salvo ainda. Calcule um produto e clique em "Salvar".',
    toastSaved: 'Produto salvo!',
    toastAlreadySaved: 'Produto j√° foi salvo.',
    toastNoProduct: 'Selecione um produto antes de salvar.',
    toastReset: 'Campos limpos ‚Äî pronto para nova busca.',
    toastDeleted: 'Produto removido.',
    toastCleared: 'Lista de salvos limpa.',
    toastExported: 'CSV exportado!',
    siLoadBtn: 'Carregar',
    siDelBtn: 'Remover',
    siSavedAt: 'Salvo √†s',
    siPrice: 'Pre√ßo CN',
    cameraLabel: 'Fotografar produto',
    cameraSub: 'IA identifica e busca nos marketplaces',
    searchStatusNoProduct: 'Selecione ou fotografe um produto para buscar',
    searchStatusReady: 'Buscando por:',
    cameraScanning: 'Analisando imagem com IA...',
    cameraFound: 'Produto identificado:',
    cameraNotFound: 'N√£o consegui identificar. Tente outra foto.',
    cameraError: 'Erro ao analisar. Verifique a conex√£o.',
    // Auto-price
    btnAutoPrice: 'Buscar Pre√ßos Automaticamente',
    apSearchingML: 'Buscando pre√ßos no Mercado Livre‚Ä¶',
    apSearchingAMZ: 'Buscando pre√ßos na Amazon‚Ä¶',
    apFound: '‚úÖ Pre√ßos encontrados e aplicados!',
    apPartial: '‚ö†Ô∏è Apenas alguns pre√ßos encontrados.',
    apFailed: '‚ö†Ô∏è N√£o foi poss√≠vel buscar. Preencha manualmente.',
    apNeedProduct: '‚ö†Ô∏è Selecione um produto antes de buscar.',
    apMLLabel: 'Mercado Livre / Amazon BR',
    apAMZLabel: 'Amazon USA',
    apSourceNote: 'Fonte: busca web em tempo real ‚Ä¢ Valores m√©dios aproximados ‚Ä¢ Verifique antes de usar',
    apUseBtn: 'Usar',
    // WhatsApp modal
    waModalTitle: 'üí¨ Compartilhar Relat√≥rio',
    waModalSub: 'Relat√≥rio profissional para seus parceiros de neg√≥cio',
    waFilterLabel: 'Quais produtos incluir',
    waFilterAll: 'Todos os produtos salvos',
    waFilterViable: 'Somente vi√°veis (margem ‚â• 25%)',
    waFilterWinners: 'Somente vencedores (margem ‚â• 35%)',
    waContextLabel: 'Contexto / mensagem de abertura (opcional)',
    waPhoneLabel: 'N√∫mero WhatsApp destino (opcional)',
    waPreviewLabel: 'Pr√©-visualiza√ß√£o da mensagem',
    waNote: 'Abre no WhatsApp Web ou app. Revise antes de enviar.',
    waOpenBtn: 'Abrir WhatsApp',
    waCopyBtn: 'Copiar Mensagem',
    waCopied: 'üìã Mensagem copiada!',
    waOpened: '‚úÖ WhatsApp aberto!',
    waNoProducts: '‚ö†Ô∏è Nenhum produto salvo ainda.',
  },
  en: {
    refresh: 'Refresh',
    hdrSub: 'True Landed Cost ‚Ä¢ China ‚Üí BR / USA ‚Ä¢ v96',
    tabBR: 'Brazil', tabBoth: 'Compare Both',
    ncmCodes: 'NCM codes',
    searchLabel: 'Product (search full NCM database)',
    searchPh: 'e.g. sunglasses, camera, drone, perfume‚Ä¶',
    ncmLoadingMsg: 'Loading official NCM database from Brazilian government...',
    ncmOkMsg: 'official NCM codes loaded',
    ncmCacheMsg: 'NCM codes loaded (local cache)',
    ncmErrMsg: 'Using local database. Check your connection.',
    ncmUpdating: 'Updating...',
    acGroupBuiltin: '‚ö° Products with default tax rates',
    acGroupAll: 'üìã All official NCM codes',
    selected: 'selected',
    pricingTitle: 'China Price + Quantity',
    lblUSD: 'China Price USD/unit',
    lblRMB: '‚âà RMB/unit (auto)',
    lblBRLPreview: '‚âà China Cost in R$',
    lblQty: 'Quantity (units)',
    lblMonthly: 'Sales/month (units)',
    logisticsTitle: 'International Logistics',
    lblFreight: 'International Freight USD',
    lblInsurance: 'Insurance USD',
    lblModal: 'Shipping Mode',
    optSea: 'üö¢ Sea Freight',
    optAir: '‚úàÔ∏è Air Freight',
    lblContainer: 'Container',
    lblPort: 'Destination Port',
    marketTitle: 'Market Research',
    lblMLPrice: 'Avg Price Mercado Livre / Amazon BR (R$)',
    lblAMZPrice: 'Avg Amazon USA Price (USD)',
    lblMLFee: 'BR Marketplace Fee %',
    lblAMZFee: 'Amazon USA Fee %',
    lblMinMargin: 'Minimum desired margin %',
    brTaxTitle: 'Brazil Import Taxes',
    simplifiedLabel: 'Simplified Mode ‚Äî China Gate / Shopee / Personal import ‚â§ US$50',
    lblBRFixed: 'Fixed Customs Fees R$',
    lblExBRL: 'Exchange Rate USD‚ÜíBRL (live)',
    lblExCNY: 'Exchange Rate CNY‚ÜíUSD (live)',
    usTaxTitle: 'USA Import Taxes',
    lblBaseDuty: 'Base Duty (HTS) %',
    lblSect301: 'Section 301 Tariff (China) %',
    opt301a: '25% ‚Äî default 2026',
    opt301c: '0% ‚Äî exempt',
    lblUSFixed: 'Broker + Fixed Fees (USD)',
    lblMPF: 'MPF (auto-calculated)',
    emptyState: 'Select a product and fill in the values to see the full cost and viability calculation.',
    brTitle: 'Brazil ‚Äî True Landed Cost',
    brSub: 'Port of Santos + Taxes + Broker',
    cifLabel: 'CIF (USD √ó exchange rate)',
    iiLabel: 'Import Tax (II)',
    ipiLabel: 'IPI',
    pisCofLabel: 'PIS + COFINS',
    icmsLabel: 'ICMS',
    fixedLabel: 'Fixed Customs Fees',
    totalLotLabel: 'üí∞ Total Batch Cost',
    unitCostLabel: 'üì¶ Unit Cost',
    suggestLabel: 'üí° SUGGESTED PRICE',
    suggestSuffix: 'margin',
    mlPriceLabel: 'Mercado Livre Price',
    netRecLabel: 'Net received',
    profitUnitLabel: 'Profit/unit',
    roiLabel: 'ROI',
    monthlyProfitLabel: 'Monthly profit',
    insertMLPrice: 'Enter Mercado Livre price',
    toSeeViability: 'to see viability',
    usTitle: 'USA ‚Äî True Landed Cost',
    usSub: 'LA / NY + Duties + Broker',
    cifUSLabel: 'CIF (goods + freight + insurance)',
    dutyLabel: 'Base Duty + Sect.301',
    mpfLabel: 'Merchandise Processing Fee',
    brokerLabel: 'Broker + Fixed Fees',
    totalLandedLabel: 'üí∞ Total Landed Cost',
    unitLandedLabel: 'üì¶ Unit Landed Cost',
    suggestUSLabel: 'üí° SUGGESTED PRICE',
    amzPriceLabel: 'Amazon Price',
    netAfterLabel: 'Net after Amazon fee',
    profitUnitUSLabel: 'Profit/unit',
    monthlyProfitUSLabel: 'Monthly profit',
    enterAMZPrice: 'Enter Amazon price',
    toSeeViabilityEN: 'to see viability',
    verdictSub: 'net margin after marketplace commission',
    monthlyEst: 'Estimated monthly profit',
    v_winner: 'WINNER PRODUCT!',
    v_good: 'GOOD TO IMPORT',
    v_marginal: 'MARGINAL ‚Äî BE CAREFUL',
    v_bad: 'NOT VIABLE',
    cmpTitle: '‚öñÔ∏è Market Comparison',
    cmpBRLabel: 'üáßüá∑ Brazil ‚Äî Margin',
    cmpUSLabel: 'üá∫üá∏ USA ‚Äî Margin',
    cmpSuggestBR: 'Suggested price',
    cmpSuggestUS: 'Suggested',
    brWinner: 'üáßüá∑ Brazil is the best opportunity',
    usWinner: 'üá∫üá∏ USA is the best opportunity',
    brWinSub: 'pp margin advantage in Brazil',
    usWinSub: 'pp margin advantage in USA',
    riskTitle: 'üö¶ Risk Analysis',
    flagBRLow: 'BR: margin below desired minimum of',
    flagUSLow: 'USA: margin below desired minimum of',
    flagBRHigh: 'BR: exceptional margin ‚Äî winner product!',
    flagUSHigh: 'USA: exceptional margin ‚Äî winner product!',
    flagBRCost: 'BR: unit cost is over 80% of sale price',
    flagUSCost: 'USA: unit cost exceeds 85% of sale price',
    flagNone: 'No alerts ‚Äî add market prices for full viability analysis',
    toastRefreshed: '‚úÖ Rates and NCM database updated!',
    toastSelectSuffix: 'selected',
    unitAbbr: 'units',
    btnReset: 'New Search',
    btnSave: 'Save Product',
    savedTitle: 'Saved Products',
    btnClearAll: 'Clear All',
    savedEmpty: 'No products saved yet. Calculate a product and click "Save".',
    toastSaved: 'Product saved!',
    toastAlreadySaved: 'Product already saved.',
    toastNoProduct: 'Select a product before saving.',
    toastReset: 'Fields cleared ‚Äî ready for new search.',
    toastDeleted: 'Product removed.',
    toastCleared: 'Saved list cleared.',
    toastExported: 'CSV exported!',
    siLoadBtn: 'Load',
    siDelBtn: 'Remove',
    siSavedAt: 'Saved at',
    siPrice: 'CN Price',
    cameraLabel: 'Photo search product',
    cameraSub: 'AI identifies and searches marketplaces',
    searchStatusNoProduct: 'Select or photograph a product to search',
    searchStatusReady: 'Search for:',
    cameraScanning: 'Analyzing image...',
    cameraFound: 'Product identified:',
    cameraNotFound: 'Could not identify. Try another photo.',
    cameraError: 'Analysis error. Check your connection.',
    // Auto-price
    btnAutoPrice: 'Auto-Fetch Market Prices',
    apSearchingML: 'Searching Mercado Livre prices‚Ä¶',
    apSearchingAMZ: 'Searching Amazon prices‚Ä¶',
    apFound: '‚úÖ Prices found and applied!',
    apPartial: '‚ö†Ô∏è Only some prices were found.',
    apFailed: '‚ö†Ô∏è Could not fetch prices. Fill in manually.',
    apNeedProduct: '‚ö†Ô∏è Select a product before fetching.',
    apMLLabel: 'Mercado Livre / Amazon BR',
    apAMZLabel: 'Amazon USA',
    apSourceNote: 'Source: real-time web search ‚Ä¢ Approximate average prices ‚Ä¢ Verify before using',
    apUseBtn: 'Use',
    // WhatsApp modal
    waModalTitle: 'üí¨ Share Report',
    waModalSub: 'Professional business report for your partners',
    waFilterLabel: 'Which products to include',
    waFilterAll: 'All saved products',
    waFilterViable: 'Viable only (margin ‚â• 25%)',
    waFilterWinners: 'Winners only (margin ‚â• 35%)',
    waContextLabel: 'Context / opening message (optional)',
    waPhoneLabel: 'WhatsApp destination number (optional)',
    waPreviewLabel: 'Message preview',
    waNote: 'Opens in WhatsApp Web or app. Review before sending.',
    waOpenBtn: 'Open WhatsApp',
    waCopyBtn: 'Copy Message',
    waCopied: 'üìã Message copied!',
    waOpened: '‚úÖ WhatsApp opened!',
    waNoProducts: '‚ö†Ô∏è No products saved yet.',
  }
};

function T(key) { return STRINGS[lang][key] || STRINGS['pt'][key] || key; }

function toggleLang() {
  lang = lang === 'pt' ? 'en' : 'pt';
  localStorage.setItem('mavLang', lang);
  applyLang();
  renderSaved();
  calc();
}

function applyLang() {
  const isEN = lang === 'en';
  var _lf=document.getElementById('langFlag'); if(_lf) _lf.textContent=isEN?'üáßüá∑':'üá∫üá∏';
  var _ll=document.getElementById('langLabel'); if(_ll) _ll.textContent=isEN?'PT':'EN';
  document.documentElement.lang = lang;

  // Translate all data-i18n elements
  document.querySelectorAll('[data-i18n]').forEach(el => {
    const key = el.getAttribute('data-i18n');
    if (STRINGS[lang][key]) el.textContent = STRINGS[lang][key];
  });

  // Translate placeholder attributes
  document.querySelectorAll('[data-i18n-ph]').forEach(el => {
    const key = el.getAttribute('data-i18n-ph');
    if (STRINGS[lang][key]) el.placeholder = STRINGS[lang][key];
  });

  // Update header subtitle
  const _hs=document.querySelector('.hdr-sub'); if(_hs) _hs.textContent=T('hdrSub');

  // Translate select options
  document.querySelectorAll('[data-i18n]').forEach(el => {
    if (el.tagName === 'OPTION') {
      const key = el.getAttribute('data-i18n');
      if (STRINGS[lang][key]) el.textContent = STRINGS[lang][key];
    }
  });

  // Re-apply shipMode text since select options need special handling
  const shipMode = document.getElementById('shipMode');
  if (shipMode) {
    shipMode.options[0].text = T('optSea');
    shipMode.options[1].text = T('optAir');
  }
  const us301 = document.getElementById('us301');
  if (us301) {
    us301.options[0].text = T('opt301a');
    us301.options[2].text = T('opt301c');
  }

  // NCM pill prefix stays as-is (icon + label)
  const ncmPillText = document.getElementById('ncmPillText');
  if (ncmPillText) ncmPillText.textContent = 'üì¶ NCM ';
}

// Built-in products with tax defaults (fallback + fast popular search)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let usdBRL = 5.22, cnyUSD = 0.1447;
let currentDest = 2;  // 0=BR 1=US 2=Both
let ncmDB = [];
let selectedProduct = null;
let acFocusIdx = -1;
let usdEdited = false;
let savedProducts = JSON.parse(localStorage.getItem('mavSaved') || '[]');
let lastCalcResult = { br: null, us: null };

const BUILTIN = [
  {n:"√ìculos de Sol",        ncm:"90041000", hts:"9004100000", brII:20, brIPI:10, usDuty:2.5, us301:25},
  {n:"√ìculos de Grau",       ncm:"90049090", hts:"9004900000", brII:20, brIPI:0,  usDuty:2.5, us301:0},
  {n:"Smartphone Android",   ncm:"85171300", hts:"8517130000", brII:0,  brIPI:15, usDuty:0,   us301:25},
  {n:"Tablet",               ncm:"84713012", hts:"8471300100", brII:0,  brIPI:15, usDuty:0,   us301:25},
  {n:"Notebook / Laptop",    ncm:"84713019", hts:"8471300100", brII:0,  brIPI:13, usDuty:0,   us301:0},
  {n:"Fone Bluetooth",       ncm:"85183000", hts:"8518302000", brII:16, brIPI:15, usDuty:0,   us301:25},
  {n:"Caixa de Som BT",      ncm:"85182200", hts:"8518220000", brII:20, brIPI:15, usDuty:0,   us301:25},
  {n:"Smartwatch",           ncm:"91021200", hts:"9102120000", brII:20, brIPI:15, usDuty:0,   us301:25},
  {n:"C√¢mera Digital",       ncm:"85258920", hts:"8525892000", brII:16, brIPI:15, usDuty:0,   us301:25},
  {n:"C√¢mera Seguran√ßa IP",  ncm:"85258929", hts:"8525892900", brII:16, brIPI:15, usDuty:0,   us301:25},
  {n:"Drone",                ncm:"88062100", hts:"8806210000", brII:20, brIPI:15, usDuty:0,   us301:25},
  {n:"Projetor LED",         ncm:"90072100", hts:"9007210000", brII:16, brIPI:13, usDuty:0,   us301:25},
  {n:"Monitor LED",          ncm:"85285220", hts:"8528521000", brII:16, brIPI:13, usDuty:0,   us301:25},
  {n:"TV LED",               ncm:"85287229", hts:"8528726400", brII:20, brIPI:15, usDuty:0,   us301:25},
  {n:"Carregador USB-C",     ncm:"85044090", hts:"8504409500", brII:0,  brIPI:15, usDuty:0,   us301:25},
  {n:"Power Bank",           ncm:"85076000", hts:"8507600000", brII:16, brIPI:15, usDuty:3.4, us301:25},
  {n:"Teclado Mec√¢nico",     ncm:"84716052", hts:"8471602000", brII:16, brIPI:10, usDuty:0,   us301:25},
  {n:"Mouse Gamer",          ncm:"84716052", hts:"8471602000", brII:16, brIPI:10, usDuty:0,   us301:25},
  {n:"Joystick / Controle",  ncm:"95045000", hts:"9504500000", brII:20, brIPI:10, usDuty:0,   us301:25},
  {n:"Lumin√°ria LED",        ncm:"94051500", hts:"9405150000", brII:20, brIPI:10, usDuty:3.9, us301:25},
  {n:"Air Fryer",            ncm:"85166000", hts:"8516604000", brII:20, brIPI:15, usDuty:0,   us301:25},
  {n:"Panela El√©trica",      ncm:"85166000", hts:"8516604000", brII:20, brIPI:15, usDuty:0,   us301:25},
  {n:"Cafeteira",            ncm:"85167100", hts:"8516710000", brII:20, brIPI:15, usDuty:0,   us301:25},
  {n:"Liquidificador",       ncm:"85094000", hts:"8509400000", brII:20, brIPI:15, usDuty:0,   us301:25},
  {n:"Camiseta Algod√£o",     ncm:"61091000", hts:"6109100000", brII:35, brIPI:0,  usDuty:16.5,us301:0},
  {n:"Cal√ßa Jeans",          ncm:"62034200", hts:"6203424000", brII:35, brIPI:0,  usDuty:16.6,us301:0},
  {n:"T√™nis / Sneaker",      ncm:"64029990", hts:"6402999000", brII:35, brIPI:0,  usDuty:9,   us301:0},
  {n:"Bolsa Feminina",       ncm:"42022220", hts:"4202221500", brII:18, brIPI:0,  usDuty:20,  us301:25},
  {n:"Mala de Viagem",       ncm:"42021210", hts:"4202122000", brII:18, brIPI:5,  usDuty:20,  us301:0},
  {n:"Mochila",              ncm:"42029220", hts:"4202923300", brII:18, brIPI:0,  usDuty:17.6,us301:0},
  {n:"Rel√≥gio de Pulso",     ncm:"91021200", hts:"9102120000", brII:20, brIPI:15, usDuty:0.5, us301:0},
  {n:"Brinquedo Pl√°stico",   ncm:"95030091", hts:"9503000000", brII:20, brIPI:10, usDuty:0,   us301:0},
  {n:"Patinete El√©trico",    ncm:"87341090", hts:"8714998000", brII:20, brIPI:10, usDuty:0,   us301:25},
  {n:"Bicicleta",            ncm:"87120090", hts:"8712001500", brII:35, brIPI:5,  usDuty:11,  us301:25},
  {n:"Halteres / Anilhas",   ncm:"95069100", hts:"9506910000", brII:20, brIPI:5,  usDuty:4.4, us301:25},
  {n:"Tapete de Yoga",       ncm:"95069100", hts:"9506910000", brII:20, brIPI:5,  usDuty:4,   us301:25},
  {n:"Impressora 3D",        ncm:"84433221", hts:"8443321000", brII:0,  brIPI:15, usDuty:0,   us301:25},
  {n:"Painel Solar",         ncm:"85414300", hts:"8541406000", brII:0,  brIPI:0,  usDuty:0.1, us301:25},
  {n:"Perfume",              ncm:"33030020", hts:"3303003000", brII:20, brIPI:365,usDuty:0,   us301:0},
  {n:"Cosm√©ticos / Maquiagem",ncm:"33049990",hts:"3304990000", brII:20, brIPI:0, usDuty:0,   us301:0},
  {n:"Vitaminas / Suplemento",ncm:"21069090",hts:"2106909900", brII:16, brIPI:0, usDuty:0,   us301:0},
  {n:"Ferramenta Manual",    ncm:"82060000", hts:"8206000000", brII:18, brIPI:5,  usDuty:9,   us301:25},
  {n:"Furadeira El√©trica",   ncm:"84672100", hts:"8467210000", brII:18, brIPI:15, usDuty:0,   us301:25},
];

const POPULAR = ["√ìculos de Sol","Smartphone Android","Drone","Fone Bluetooth","Smartwatch","C√¢mera Seguran√ßa IP","Air Fryer","T√™nis / Sneaker","Mochila","Patinete El√©trico","Halteres / Anilhas","Painel Solar"];

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚îÄ‚îÄ User color + initials helpers ‚îÄ‚îÄ
const USER_COLORS = ['#00e676','#448aff','#ffd740','#b388ff','#ff7043','#26c6da','#ec407a','#66bb6a'];
function userColor(email) {
  if (!email) return '#6b7394';
  let h = 0; for (let c of email) h = (h * 31 + c.charCodeAt(0)) & 0xfffffff;
  return USER_COLORS[h % USER_COLORS.length];
}
function userInitials(name) {
  if (!name) return '?';
  return name.split(' ').map(w => w[0]).join('').toUpperCase().slice(0,2);
}

window.onload = async () => {
  try {
    goToStep(1);
    applyLang();
    populateUserDropdown();
    buildQuickTags();
    setDest(2);
    bindInputs();
    renderSaved();
    updateSearchStatus();
    ncmDB = BUILTIN.map(b => ({ code: b.ncm, desc: b.n.toUpperCase(), raw: b }));
    setNcmStatus('loading', T('ncmLoadingMsg'));
    document.getElementById('ncmStatus').classList.add('loading');
    await Promise.all([refreshRates(), loadNCM()]);
    document.getElementById('ncmStatus').classList.remove('loading');
    document.getElementById('ncmStatus').classList.add('done');
    calc();

    // Init Google API + try restore session
    if (typeof gapi !== 'undefined') onGapiLoaded();
    else window.onGapiLoaded = onGapiLoaded;
    tryRestoreSession();

  } catch(e) {
    console.warn('Init error:', e);
    calc();
    tryRestoreSession();
  }
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// LOAD FULL NCM VIA CORS PROXY
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function loadNCM() {
  const SISCOMEX_URL = 'https://portalunico.siscomex.gov.br/classif/api/publico/nomenclatura/download/json';
  const PROXIES = [
    `https://corsproxy.io/?${encodeURIComponent(SISCOMEX_URL)}`,
    `https://api.allorigins.win/raw?url=${encodeURIComponent(SISCOMEX_URL)}`,
  ];

  // Safari-compatible timeout helper (AbortSignal.timeout not supported in Safari)
  function fetchWithTimeout(url, ms) {
    const ctrl = new AbortController();
    const id = setTimeout(() => ctrl.abort(), ms);
    return fetch(url, { signal: ctrl.signal, mode: 'cors' })
      .finally(() => clearTimeout(id));
  }

  // Check sessionStorage cache first (valid 6 hours)
  try {
    const cached = sessionStorage.getItem('ncmCache');
    if (cached) {
      const { ts, data } = JSON.parse(cached);
      if (Date.now() - ts < 6 * 3600 * 1000 && Array.isArray(data) && data.length > 100) {
        ncmDB = data;
        setNcmStatus('ok', `${ncmDB.length.toLocaleString()} ${T('ncmCacheMsg')}`);
        document.getElementById('ncmCount').textContent = ncmDB.length.toLocaleString();
        return;
      }
    }
  } catch(e) { /* ignore cache errors */ }

  // Try each proxy with individual try/catch so one failure doesn't kill the loop
  for (const proxyUrl of PROXIES) {
    let res, raw;
    try { res = await fetchWithTimeout(proxyUrl, 12000); } catch(e) { continue; }
    if (!res || !res.ok) continue;
    try { raw = await res.json(); } catch(e) { continue; }

    const list = raw.Nomenclaturas || raw.nomenclaturas || (Array.isArray(raw) ? raw : null);
    if (!list || list.length < 100) continue;

    const built = list
      .filter(i => {
        const c = String(i.Codigo || i.codigo || '').replace(/\D/g,'');
        return c.length === 8;
      })
      .map(i => {
        const code = String(i.Codigo || i.codigo || '').replace(/\D/g,'');
        const desc = String(i.Descricao || i.descricao || '').toUpperCase();
        const builtin = BUILTIN.find(b => b.ncm === code);
        return { code, desc, raw: builtin || null };
      });

    if (built.length < 100) continue;

    ncmDB = built;
    setNcmStatus('ok', `‚úÖ ${ncmDB.length.toLocaleString()} ${T('ncmOkMsg')}`);
    document.getElementById('ncmCount').textContent = ncmDB.length.toLocaleString();

    try { sessionStorage.setItem('ncmCache', JSON.stringify({ ts: Date.now(), data: ncmDB })); } catch(e){}
    return;
  }

  // All proxies failed ‚Äî silently use built-in, no error toast (normal for offline/fair use)
  setNcmStatus('ok', `${ncmDB.length.toLocaleString()} ${T('ncmCacheMsg')}`);
  document.getElementById('ncmCount').textContent = ncmDB.length.toLocaleString();
}

function setNcmStatus(state, msg) {
  const dot = document.getElementById('ncmDot');
  dot.className = 'dot ' + state;
  document.getElementById('ncmMsg').textContent = msg;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// EXCHANGE RATES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function refreshRates() {
  try {
    const res = await fetch('https://api.exchangerate-api.com/v4/latest/USD');
    const data = await res.json();
    usdBRL = data.rates.BRL || 5.22;
    cnyUSD = 1 / (data.rates.CNY || 6.91);
    document.getElementById('exBRL').value = usdBRL.toFixed(3);
    document.getElementById('exCNY').value = cnyUSD.toFixed(4);
    document.getElementById('rBRL').textContent = usdBRL.toFixed(2);
    document.getElementById('rCNY').textContent = cnyUSD.toFixed(4);
    // Show last-updated time
    const now = new Date();
    const hhmm = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    const el = document.getElementById('rateUpdated');
    if (el) el.textContent = hhmm;
    calc();
  } catch(e) {
    document.getElementById('rBRL').textContent = '‚Äì';
    document.getElementById('rCNY').textContent = '‚Äì';
  }
}

// Auto-refresh rates every 30 minutes silently
setInterval(async () => {
  await refreshRates();
}, 30 * 60 * 1000);

async function refreshAll() {
  const svg = document.getElementById('refreshSvg');
  svg.closest('.btn-hdr').classList.add('spin');
  setNcmStatus('loading', T('ncmUpdating'));
  sessionStorage.removeItem('ncmCache');
  await Promise.all([refreshRates(), loadNCM()]);
  svg.closest('.btn-hdr').classList.remove('spin');
  calc();
  showToast(T('toastRefreshed'));
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// QUICK TAGS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function buildQuickTags() {
  const wrap = document.getElementById('quickTags');
  if (!wrap) return;
  POPULAR.forEach(name => {
    const t = document.createElement('button');
    t.className = 'qtag';
    t.textContent = name;
    t.onclick = () => {
      const p = BUILTIN.find(b => b.n === name);
      if (p) pickProduct(p.ncm, p.n, p);
    };
    wrap.appendChild(t);
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SEARCH & AUTOCOMPLETE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function onSearch() {
  const q = document.getElementById('srchInput').value.trim();
  const drop = document.getElementById('acDrop');
  drop.innerHTML = '';
  acFocusIdx = -1;

  if (q.length < 2) { drop.classList.remove('open'); return; }

  const term = q.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'');

  // Score and sort results
  const results = ncmDB
    .map(item => {
      const d = item.desc.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'');
      let score = 0;
      if (d.startsWith(term)) score = 100;
      else if (d.includes(' ' + term)) score = 80;
      else if (d.includes(term)) score = 60;
      else if (item.code.includes(term)) score = 50;
      return { item, score };
    })
    .filter(r => r.score > 0)
    .sort((a,b) => b.score - a.score)
    .slice(0, 20);

  if (!results.length) { drop.classList.remove('open'); return; }

  // Group: built-in first, then full NCM
  const withDefaults = results.filter(r => r.item.raw);
  const ncmOnly      = results.filter(r => !r.item.raw);

  if (withDefaults.length) {
    const lbl = document.createElement('div');
    lbl.className = 'ac-group-label';
    lbl.textContent = T('acGroupBuiltin');
    drop.appendChild(lbl);
    withDefaults.forEach(r => drop.appendChild(makeAcItem(r.item, true)));
  }
  if (ncmOnly.length) {
    const lbl = document.createElement('div');
    lbl.className = 'ac-group-label';
    lbl.textContent = T('acGroupAll');
    drop.appendChild(lbl);
    ncmOnly.forEach(r => drop.appendChild(makeAcItem(r.item, false)));
  }

  drop.classList.add('open');
}

function makeAcItem(item, hasDefaults) {
  const div = document.createElement('div');
  div.className = 'ac-item';
  div.innerHTML = `
    <span class="ncm-tag">${item.code.replace(/(\d{4})(\d{2})(\d{2})/,'$1.$2.$3')}</span>
    <div class="desc-wrap">
      <div class="desc">${item.desc}</div>
    </div>
    ${hasDefaults ? '<span class="ai-badge">taxas</span>' : ''}
  `;
  div.onmousedown = (e) => {
    e.preventDefault(); // prevent input blur from firing before we handle the click
    const drop = document.getElementById('acDrop');
    const input = document.getElementById('srchInput');
    drop.classList.remove('open');
    input.value = '';
    pickProduct(item.code, item.desc, item.raw);
  };
  return div;
}

function onKeyNav(e) {
  const drop = document.getElementById('acDrop');
  const items = drop.querySelectorAll('.ac-item');
  if (!items.length) return;
  if (e.key === 'ArrowDown') { e.preventDefault(); acFocusIdx = Math.min(acFocusIdx+1, items.length-1); highlightAc(items); }
  else if (e.key === 'ArrowUp') { e.preventDefault(); acFocusIdx = Math.max(acFocusIdx-1, 0); highlightAc(items); }
  else if (e.key === 'Enter' && acFocusIdx >= 0) { items[acFocusIdx].click(); }
  else if (e.key === 'Escape') { drop.classList.remove('open'); }
}
function highlightAc(items) {
  items.forEach((el,i) => el.classList.toggle('focused', i === acFocusIdx));
  if (items[acFocusIdx]) items[acFocusIdx].scrollIntoView({ block:'nearest' });
}

document.addEventListener('click', e => {
  if (!e.target.closest('#srchInput') && !e.target.closest('#acDrop'))
    document.getElementById('acDrop').classList.remove('open');
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PRODUCT SELECTION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function pickProduct(code, desc, defaults) {
  // Format NCM
  const fmtNCM = code.replace(/(\d{4})(\d{2})(\d{2})/,'$1.$2.$3');
  // Best-guess HTS: same as NCM (first 6 digits same, user can adjust)
  const fmtHTS = defaults?.hts ? defaults.hts : code;

  selectedProduct = { code, desc, fmtNCM, fmtHTS, defaults };

  // Show chip
  const chip = document.getElementById('prodChip');
  chip.classList.add('show');
  document.getElementById('chipName').textContent = cap(desc);
  document.getElementById('chipCodes').textContent = `NCM ${fmtNCM}  |  HTS ${fmtHTS}`;

  // Fill tax defaults if available
  if (defaults) {
    v('brII',    defaults.brII ?? 20);
    v('brIPI',   defaults.brIPI ?? 15);
    v('usDuty',  defaults.usDuty ?? 2.5);
    v('us301',   defaults.us301 ?? 25);
  }

  showToast('üì¶ ' + cap(desc).slice(0,40) + ' ' + T('toastSelectSuffix'));
  updateSearchStatus();
  calc();
}

function clearProduct() {
  selectedProduct = null;
  document.getElementById('prodChip').classList.remove('show');
  document.getElementById('srchInput').value = '';
  updateSearchStatus();
  calc();
}

function cap(s) {
  return s.charAt(0).toUpperCase() + s.slice(1).toLowerCase();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DESTINATION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function setDest(mode) {
  currentDest = mode;
  ['dBR','dUS','dBoth'].forEach((id,i) => {
    document.getElementById(id).classList.toggle('active', i === mode);
  });
  const showBR = mode === 0 || mode === 2;
  const showUS = mode === 1 || mode === 2;
  document.getElementById('brTax').classList.toggle('hidden', !showBR);
  document.getElementById('usTax').classList.toggle('hidden', !showUS);
  document.getElementById('fML').classList.toggle('hidden', !showBR);
  document.getElementById('fMLFee').classList.toggle('hidden', !showBR);
  document.getElementById('fAMZ').classList.toggle('hidden', !showUS);
  document.getElementById('fAMZFee').classList.toggle('hidden', !showUS);
  calc();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PRICE SYNC USD ‚Üî RMB  (USD is now primary)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function onUSD() {
  usdEdited = true;
  const cny = parseFloat(g('exCNY')) || 0.1447;
  const usd = parseFloat(g('priceUSD')) || 0;
  // Auto-fill RMB with 2 decimals
  if (usd > 0) {
    document.getElementById('priceRMB').value = (usd / cny).toFixed(2);
  } else {
    document.getElementById('priceRMB').value = '';
  }
  updateBRLPreview(usd);
  calc();
}

function onRMB() {
  usdEdited = false;
  const cny = parseFloat(g('exCNY')) || 0.1447;
  const rmb = parseFloat(g('priceRMB')) || 0;
  // Auto-fill USD with 2 decimals
  if (rmb > 0) {
    const usd = rmb * cny;
    document.getElementById('priceUSD').value = usd.toFixed(2);
    updateBRLPreview(usd);
  } else {
    document.getElementById('priceUSD').value = '';
    updateBRLPreview(0);
  }
  calc();
}

function updateBRLPreview(usdPerUnit) {
  const ex  = parseFloat(g('exBRL')) || 5.22;
  const preview = document.getElementById('brlPreview');
  const valEl   = document.getElementById('brlPreviewVal');
  if (usdPerUnit > 0) {
    const brl = usdPerUnit * ex;
    valEl.textContent = 'R$ ' + brl.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    preview.style.display = 'flex';
  } else {
    preview.style.display = 'none';
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MAIN CALCULATION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function calc() {
  const ex  = parseFloat(g('exBRL'))  || 5.22;
  const cny = parseFloat(g('exCNY'))  || 0.1447;
  const qty = Math.max(1, parseInt(g('qty')) || 1);
  const mon = parseInt(g('monthly'))  || 0;
  const minM= parseFloat(g('minMargin')) || 25;

  // Unit USD ‚Äî USD is now primary input
  let unitUSD;
  if (usdEdited || g('priceUSD')) {
    unitUSD = parseFloat(g('priceUSD')) || 0;
    // Keep RMB in sync (2 decimals only)
    if (unitUSD > 0 && cny > 0) {
      const rmbEl = document.getElementById('priceRMB');
      if (!rmbEl.matches(':focus')) rmbEl.value = (unitUSD / cny).toFixed(2);
    }
  } else {
    const rmb = parseFloat(g('priceRMB')) || 0;
    unitUSD = rmb * cny;
    const usdEl = document.getElementById('priceUSD');
    if (!usdEl.matches(':focus') && unitUSD > 0) usdEl.value = unitUSD.toFixed(2);
  }
  // Update BRL preview
  updateBRLPreview(unitUSD);

  const freightUSD = parseFloat(g('freight'))  || 0;
  const insUSD     = parseFloat(g('insurance')) || 0;
  const contUSD    = parseFloat(g('contType'))  || 0;

  const goodsUSD = unitUSD * qty;
  const cifUSD   = goodsUSD + freightUSD + insUSD + contUSD;
  const cifBRL   = cifUSD * ex;

  let brR = null, usR = null;

  // ‚îÄ‚îÄ BRAZIL ‚îÄ‚îÄ
  if (currentDest === 0 || currentDest === 2) {
    const simp   = document.getElementById('simplified').checked;
    const iiR    = (parseFloat(g('brII'))     || 0) / 100;
    const ipiR   = (parseFloat(g('brIPI'))    || 0) / 100;
    const pisR   = (parseFloat(g('brPIS'))    || 0) / 100;
    const cofR   = (parseFloat(g('brCOFINS')) || 0) / 100;
    const icmsR  = (parseFloat(g('brICMS'))   || 0) / 100;
    const fixBRL = parseFloat(g('brFixed'))   || 1164;

    let ii=0, ipi=0, piscof=0, icms=0;
    if (simp) {
      ii    = cifBRL * 0.20;
      icms  = (cifBRL + ii) * icmsR / (1 - icmsR);
    } else {
      ii     = cifBRL * iiR;
      ipi    = (cifBRL + ii) * ipiR;
      piscof = cifBRL * (pisR + cofR);
      const baseICMS = cifBRL + ii + ipi + piscof + fixBRL;
      icms   = baseICMS * icmsR / (1 - icmsR);
    }

    const totalBRL = cifBRL + ii + ipi + piscof + icms + fixBRL;
    const unitBRL  = totalBRL / qty;

    const mlP  = parseFloat(g('mlPrice')) || 0;
    const mlFR = (parseFloat(g('mlFee'))  || 15.5) / 100;
    const netML = mlP * (1 - mlFR);
    const profBR = mlP > 0 ? netML - unitBRL : null;
    const margBR = (profBR !== null && netML > 0) ? profBR / netML * 100 : null;
    const monProfBR = profBR !== null ? profBR * mon : null;
    const roiBR = (profBR !== null && unitBRL > 0) ? profBR / unitBRL * 100 : null;
    const suggestBR = (mlP === 0 && unitBRL > 0) ? suggestPrice(unitBRL, mlFR, minM) : null;

    brR = { cifBRL, ii, ipi, piscof, icms, fixBRL, totalBRL, unitBRL, mlP, netML, profBR, margBR, monProfBR, roiBR, suggestBR, simp };
  }

  // ‚îÄ‚îÄ USA ‚îÄ‚îÄ
  if (currentDest === 1 || currentDest === 2) {
    const baseR  = (parseFloat(g('usDuty'))  || 0) / 100;
    const s301R  = (parseFloat(g('us301'))   || 0) / 100;
    const fixUSD = parseFloat(g('usFixed'))  || 250;

    const totDutyR = baseR + s301R;
    const dutyUSD  = cifUSD * totDutyR;
    const mpfUSD   = Math.min(Math.max(cifUSD * 0.003464, 27.75), 538.40);
    document.getElementById('usMPF').value = `US$ ${mpfUSD.toFixed(2)}`;

    const totalUS = cifUSD + dutyUSD + mpfUSD + fixUSD;
    const unitUS  = totalUS / qty;

    const amzP  = parseFloat(g('amzPrice')) || 0;
    const amzFR = (parseFloat(g('amzFee'))  || 15) / 100;
    const netAMZ = amzP * (1 - amzFR);
    const profUS = amzP > 0 ? netAMZ - unitUS : null;
    const margUS = (profUS !== null && netAMZ > 0) ? profUS / netAMZ * 100 : null;
    const monProfUS = profUS !== null ? profUS * mon : null;
    const roiUS = (profUS !== null && unitUS > 0) ? profUS / unitUS * 100 : null;
    const suggestUS = (amzP === 0 && unitUS > 0) ? suggestPrice(unitUS, amzFR, minM) : null;

    usR = { cifUSD, dutyUSD, totDutyR, mpfUSD, fixUSD, totalUS, unitUS, amzP, netAMZ, profUS, margUS, monProfUS, roiUS, suggestUS };
  }

  lastCalcResult = { br: brR, us: usR, minM };
  render(brR, usR, minM);
}

function suggestPrice(unitCost, feeRate, desiredMargin) {
  // Solve: (P * (1-fee) - cost) / (P * (1-fee)) = margin
  // ‚Üí P = cost / ((1-fee) * (1 - margin/100))
  const netFactor = (1 - feeRate) * (1 - desiredMargin / 100);
  if (netFactor <= 0) return null;
  return unitCost / netFactor;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// RENDER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function render(br, us, minM) {
  const area = document.getElementById('resultsArea');
  let html = '';

  if (currentDest === 2) {
    // Both: side by side
    html = `<div class="result-grid">`;
    if (br) html += renderBR(br, minM);
    if (us) html += renderUS(us, minM);
    html += `</div>`;
    if (br && us) html += renderCompare(br, us, minM);
  } else if (currentDest === 0 && br) {
    html = renderBR(br, minM);
  } else if (currentDest === 1 && us) {
    html = renderUS(us, minM);
  } else {
    html = `<div class="empty-state"><div class="empty-icon">‚ö°</div><div class="empty-text">${T('emptyState')}</div></div>`;
  }

  area.innerHTML = html;
  area.className = 'fade-in';
}

function renderBR(r, minM) {
  const v = verdict(r.margBR, minM);
  return `<div class="r-card br">
    <div class="r-flag">üáßüá∑</div>
    <div class="r-title">${T('brTitle')}</div>
    <div class="r-sub">${T('brSub')}</div>

    <table class="cost-tbl" style="margin-top:16px">
      <tr><td>${T('cifLabel')}</td><td class="t-muted">R$ ${f2(r.cifBRL)}</td></tr>
      <tr><td>${T('iiLabel')}${r.simp?' <span style="font-size:0.7em;color:var(--gold)">(simplif.)</span>':''}</td><td>R$ ${f2(r.ii)}</td></tr>
      <tr><td>${T('ipiLabel')}</td><td>R$ ${f2(r.ipi)}</td></tr>
      <tr><td>${T('pisCofLabel')}</td><td>R$ ${f2(r.piscof)}</td></tr>
      <tr><td>${T('icmsLabel')}</td><td>R$ ${f2(r.icms)}</td></tr>
      <tr><td class="t-muted">${T('fixedLabel')}</td><td class="t-muted">R$ ${f2(r.fixBRL)}</td></tr>
      <tr class="t-total"><td>${T('totalLotLabel')}</td><td style="color:var(--green)">R$ ${f2(r.totalBRL)}</td></tr>
    </table>

    <div class="unit-cost-display">
      <div><div class="ucd-label">${T('unitCostLabel')}</div></div>
      <div class="ucd-val green">R$ ${f2(r.unitBRL)}</div>
    </div>

    ${r.suggestBR !== null ? `
    <div style="background:rgba(255,215,64,0.07);border:1px solid rgba(255,215,64,0.2);border-radius:8px;padding:10px 14px;margin-bottom:10px;display:flex;justify-content:space-between;align-items:center">
      <span style="font-size:0.72rem;color:var(--gold);font-weight:700">${T('suggestLabel')} (${minM}% ${T('suggestSuffix')})</span>
      <span style="font-family:'IBM Plex Mono',monospace;font-size:1rem;font-weight:700;color:var(--gold)">R$ ${f2(r.suggestBR)}</span>
    </div>` : ''}

    ${r.mlP > 0 ? `
    <div class="profit-block">
      <div class="pb-row"><span class="k">${T('mlPriceLabel')}</span><span class="v">R$ ${f2(r.mlP)}</span></div>
      <div class="pb-row"><span class="k">${T('netRecLabel')}</span><span class="v">R$ ${f2(r.netML)}</span></div>
      <div class="pb-row"><span class="k">${T('profitUnitLabel')}</span><span class="v" style="color:${r.profBR>=0?'var(--green)':'var(--red)'}">R$ ${f2(r.profBR)}</span></div>
      <div class="pb-row"><span class="k">${T('roiLabel')}</span><span class="v" style="color:${r.roiBR>=0?'var(--green)':'var(--red)'}">${r.roiBR!==null?r.roiBR.toFixed(1)+'%':'‚Äì'}</span></div>
      <div class="pb-row"><span class="k">${T('monthlyProfitLabel')} (${g('monthly')} ${T('unitAbbr')})</span><span class="v" style="color:${r.monProfBR>=0?'var(--green)':'var(--red)'}">R$ ${r.monProfBR!==null?Math.round(r.monProfBR).toLocaleString('pt-BR'):'‚Äì'}</span></div>
    </div>` : ''}

    ${r.margBR !== null ? renderVerdict(v, r.margBR, r.monProfBR, 'R$') :
      `<div class="verdict none"><span class="em">üîç</span><div class="lb v-muted">${T('insertMLPrice')}</div><div class="sb">${T('toSeeViability')}</div></div>`}
  </div>`;
}

function renderUS(r, minM) {
  const v = verdict(r.margUS, minM);
  return `<div class="r-card us">
    <div class="r-flag">üá∫üá∏</div>
    <div class="r-title">${T('usTitle')}</div>
    <div class="r-sub">${T('usSub')}</div>

    <table class="cost-tbl" style="margin-top:16px">
      <tr><td>${T('cifUSLabel')}</td><td class="t-muted">US$ ${f2(r.cifUSD)}</td></tr>
      <tr><td>${T('dutyLabel')} (${(r.totDutyR*100).toFixed(1)}%)</td><td>US$ ${f2(r.dutyUSD)}</td></tr>
      <tr><td>${T('mpfLabel')}</td><td>US$ ${f2(r.mpfUSD)}</td></tr>
      <tr><td class="t-muted">${T('brokerLabel')}</td><td class="t-muted">US$ ${f2(r.fixUSD)}</td></tr>
      <tr class="t-total"><td>${T('totalLandedLabel')}</td><td style="color:var(--blue)">US$ ${f2(r.totalUS)}</td></tr>
    </table>

    <div class="unit-cost-display">
      <div><div class="ucd-label">${T('unitLandedLabel')}</div></div>
      <div class="ucd-val blue">US$ ${f2(r.unitUS)}</div>
    </div>

    ${r.suggestUS !== null ? `
    <div style="background:rgba(255,215,64,0.07);border:1px solid rgba(255,215,64,0.2);border-radius:8px;padding:10px 14px;margin-bottom:10px;display:flex;justify-content:space-between;align-items:center">
      <span style="font-size:0.72rem;color:var(--gold);font-weight:700">${T('suggestUSLabel')} (${minM}% ${T('suggestSuffix')})</span>
      <span style="font-family:'IBM Plex Mono',monospace;font-size:1rem;font-weight:700;color:var(--gold)">US$ ${f2(r.suggestUS)}</span>
    </div>` : ''}

    ${r.amzP > 0 ? `
    <div class="profit-block">
      <div class="pb-row"><span class="k">${T('amzPriceLabel')}</span><span class="v">US$ ${f2(r.amzP)}</span></div>
      <div class="pb-row"><span class="k">${T('netAfterLabel')}</span><span class="v">US$ ${f2(r.netAMZ)}</span></div>
      <div class="pb-row"><span class="k">${T('profitUnitUSLabel')}</span><span class="v" style="color:${r.profUS>=0?'var(--blue)':'var(--red)'}">US$ ${f2(r.profUS)}</span></div>
      <div class="pb-row"><span class="k">${T('roiLabel')}</span><span class="v" style="color:${r.roiUS>=0?'var(--blue)':'var(--red)'}">${r.roiUS!==null?r.roiUS.toFixed(1)+'%':'‚Äì'}</span></div>
      <div class="pb-row"><span class="k">${T('monthlyProfitUSLabel')} (${g('monthly')} ${T('unitAbbr')})</span><span class="v" style="color:${r.monProfUS>=0?'var(--blue)':'var(--red)'}">US$ ${r.monProfUS!==null?Math.round(r.monProfUS).toLocaleString():'‚Äì'}</span></div>
    </div>` : ''}

    ${r.margUS !== null ? renderVerdict(v, r.margUS, r.monProfUS, 'US$') :
      `<div class="verdict none"><span class="em">üîç</span><div class="lb v-muted">${T('enterAMZPrice')}</div><div class="sb">${T('toSeeViabilityEN')}</div></div>`}
  </div>`;
}

function renderVerdict(v, margin, monthly, cur) {
  return `<div class="verdict ${v.cls}">
    <span class="em">${v.em}</span>
    <div class="lb ${v.col}">${v.label}</div>
    <div class="mg ${v.col}">${margin.toFixed(1)}%</div>
    <div class="sb">${T('verdictSub')}</div>
    ${monthly !== null ? `<div style="font-size:0.78rem;margin-top:6px;color:var(--muted)">${T('monthlyEst')}: <strong class="${v.col}">${cur} ${Math.round(monthly).toLocaleString()}</strong></div>` : ''}
  </div>`;
}

function renderCompare(br, us, minM) {
  const brWin = br.margBR !== null && us.margUS !== null && br.margBR > us.margUS;
  const usWin = br.margBR !== null && us.margUS !== null && us.margUS > br.margBR;

  const flags = [];
  if (br.margBR !== null && br.margBR < minM) flags.push(`<div class="flag-item" style="color:var(--red)">‚ùå ${T('flagBRLow')} ${minM}% (${br.margBR.toFixed(1)}%)</div>`);
  if (us.margUS !== null && us.margUS < minM) flags.push(`<div class="flag-item" style="color:var(--red)">‚ùå ${T('flagUSLow')} ${minM}% (${us.margUS.toFixed(1)}%)</div>`);
  if (br.margBR !== null && br.margBR > 40) flags.push(`<div class="flag-item" style="color:var(--green)">üèÜ ${T('flagBRHigh')}</div>`);
  if (us.margUS !== null && us.margUS > 35) flags.push(`<div class="flag-item" style="color:var(--blue)">üèÜ ${T('flagUSHigh')}</div>`);
  if (br.unitBRL > 0 && br.mlP > 0 && br.unitBRL > br.mlP * 0.80) flags.push(`<div class="flag-item" style="color:var(--red)">‚ö†Ô∏è ${T('flagBRCost')}</div>`);
  if (us.unitUS  > 0 && us.amzP  > 0 && us.unitUS  > us.amzP  * 0.85) flags.push(`<div class="flag-item" style="color:var(--red)">‚ö†Ô∏è ${T('flagUSCost')}</div>`);
  if (!flags.length) flags.push(`<div class="flag-item" style="color:var(--muted)">${T('flagNone')}</div>`);

  return `<div class="cmp-card fade-in">
    <div class="cmp-title">${T('cmpTitle')}</div>
    <div class="cmp-grid">
      <div class="cmp-box">
        <div class="label">${T('cmpBRLabel')}</div>
        <div class="big ${br.margBR!==null?(br.margBR>=minM?'v-green':'v-red'):'v-muted'}">${br.margBR!==null?br.margBR.toFixed(1)+'%':'‚Äì'}</div>
        <div class="sub">${T('unitCostLabel')}: R$ ${f2(br.unitBRL)}</div>
        ${br.suggestBR?`<div style="font-size:0.7rem;color:var(--gold);margin-top:4px">${T('cmpSuggestBR')}: R$ ${f2(br.suggestBR)}</div>`:''}
      </div>
      <div class="cmp-box">
        <div class="label">${T('cmpUSLabel')}</div>
        <div class="big ${us.margUS!==null?(us.margUS>=minM?'v-blue':'v-red'):'v-muted'}">${us.margUS!==null?us.margUS.toFixed(1)+'%':'‚Äì'}</div>
        <div class="sub">${T('unitLandedLabel')}: US$ ${f2(us.unitUS)}</div>
        ${us.suggestUS?`<div style="font-size:0.7rem;color:var(--gold);margin-top:4px">${T('cmpSuggestUS')}: US$ ${f2(us.suggestUS)}</div>`:''}
      </div>
    </div>

    ${(brWin || usWin) ? `<div class="winner-banner" style="margin-bottom:12px">
      <div class="wt">${brWin ? T('brWinner') : T('usWinner')}</div>
      <div class="ws">${brWin ? `${(br.margBR-us.margUS).toFixed(1)}pp ${T('brWinSub')}` : `${(us.margUS-br.margBR).toFixed(1)}pp ${T('usWinSub')}`}</div>
    </div>` : ''}

    <div class="flags-section">
      <div class="flags-title">${T('riskTitle')}</div>
      ${flags.join('')}
    </div>
  </div>`;
}

function verdict(margin, minM) {
  if (margin === null) return { cls:'none', em:'üîç', label:'‚Äì', col:'v-muted' };
  if (margin >= 40)   return { cls:'win', em:'üèÜ', label: T('v_winner'),   col:'v-green' };
  if (margin >= minM) return { cls:'win', em:'‚úÖ', label: T('v_good'),     col:'v-green' };
  if (margin >= 10)   return { cls:'ok',  em:'‚ö†Ô∏è', label: T('v_marginal'), col:'v-yellow' };
  return               { cls:'bad', em:'‚ùå', label: T('v_bad'),      col:'v-red' };
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MARKET LINKS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openML()     { openMarket(`https://lista.mercadolivre.com.br/${enc()}`); }
function openAMZbr()  { openMarket(`https://www.amazon.com.br/s?k=${enc()}`); }
function openAMZus()  { openMarket(`https://www.amazon.com/s?k=${enc()}`); }
function openTrends() {
  const q = enc();
  openMarket(`https://trends.google.com/trends/explore?geo=BR&q=${q}`);
  setTimeout(() => openMarket(`https://trends.google.com/trends/explore?geo=US&q=${q}`), 300);
}
function openMarket(url) { window.open(url, '_blank'); }

function enc() {
  // Priority: selected product > camera-identified product > search input
  const name = selectedProduct?.desc || cameraProductName || document.getElementById('srchInput').value || '';
  return encodeURIComponent(name);
}

function updateSearchStatus() {
  const dot  = document.getElementById('searchStatusDot');
  const text = document.getElementById('searchStatusText');
  const name = selectedProduct?.desc || cameraProductName || document.getElementById('srchInput').value || '';
  if (name.trim()) {
    dot.className = 'search-status-dot ready';
    const display = name.charAt(0).toUpperCase() + name.slice(1).toLowerCase();
    text.textContent = T('searchStatusReady') + ' ' + display.slice(0, 45);
  } else {
    dot.className = 'search-status-dot';
    text.textContent = T('searchStatusNoProduct');
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CAMERA / PHOTO PRODUCT IDENTIFICATION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let cameraProductName = '';
let cameraImageBase64 = '';

async function onPhotoSelected(event) {
  const file = event.target.files[0];
  if (!file) return;

  // Show preview
  const reader = new FileReader();
  reader.onload = async (e) => {
    const dataUrl = e.target.result;
    cameraImageBase64 = dataUrl.split(',')[1]; // base64 only

    document.getElementById('cameraIdle').style.display = 'none';
    document.getElementById('cameraPreview').style.display = 'flex';
    document.getElementById('previewImg').src = dataUrl;

    // Show spinner
    const spinner = document.getElementById('camSpinner');
    const result  = document.getElementById('camResult');
    spinner.classList.add('active');
    result.className = 'cam-result';
    result.innerHTML = '';

    // Update search status to scanning
    const dot = document.getElementById('searchStatusDot');
    dot.className = 'search-status-dot scanning';
    document.getElementById('searchStatusText').textContent = T('cameraScanning');

    try {
      const identified = await identifyProductWithAI(cameraImageBase64);
      spinner.classList.remove('active');

      if (identified) {
        window._camIdentified = identified;
        cameraProductName = identified.name;
        const ncmFmt = identified.ncm ? identified.ncm.replace(/(\d{4})(\d{2})(\d{2})/,'$1.$2.$3') : null;
        const ncmInDB = identified.ncm ? ncmDB.find(n => n.code === identified.ncm.replace(/\D/g,'')) : null;
        result.className = 'cam-result show';
        result.innerHTML =
          '<div style="font-weight:700;font-size:15px;color:var(--t1)">üì∑ ' + identified.name + '</div>' +
          (identified.desc ? '<div style="font-size:12px;color:var(--t3);margin-top:2px">' + identified.desc + '</div>' : '') +
          (ncmFmt ? '<div style="font-size:12px;color:var(--blue);font-weight:600;margin-top:4px;font-family:monospace">NCM ' + ncmFmt + (ncmInDB ? ' ‚úì' : ' (sugerido)') + '</div>' : '') +
          '<button onclick="acceptCameraProduct()" style="width:100%;margin-top:10px;padding:12px;border-radius:12px;background:var(--blue);color:#fff;border:none;font-size:14px;font-weight:700;cursor:pointer">Usar este produto ‚Üí</button>' +
          '<button onclick="clearCamera()" style="width:100%;margin-top:6px;padding:8px;border-radius:10px;background:none;color:var(--t3);border:1px solid var(--sep);font-size:13px;cursor:pointer">‚úï Tentar outra foto</button>';
        updateSearchStatus();
        showToast('üì∑ Produto identificado ‚Äî clique Usar');
      } else {
        spinner.classList.remove('active');
        result.className = 'cam-result show';
        result.innerHTML = `<div style="color:var(--red)">${T('cameraNotFound')}</div>`;
        updateSearchStatus();
      }
    } catch(err) {
      spinner.classList.remove('active');
      result.className = 'cam-result show';
      result.innerHTML = `<div style="color:var(--red)">${T('cameraError')}</div>`;
      console.warn('Camera AI error:', err);
      updateSearchStatus();
    }
  };
  reader.readAsDataURL(file);
  // Reset file input so same photo can be retried
  event.target.value = '';
}


function getProxyUrl() {
  return localStorage.getItem('mavericks_proxy_url') || 'https://mavericksimporter.sergiocarreno1.workers.dev';
}
async function callClaude(body) {
  const res = await fetch(getProxyUrl(), {
    method: 'POST', headers: {'Content-Type': 'application/json'},
    body: JSON.stringify(body)
  });
  if (!res.ok) {
    const t = await res.text().catch(() => '');
    throw new Error('Worker ' + res.status + ': ' + t.slice(0, 120));
  }
  return res.json();
}

async function identifyProductWithAI(base64Image) {
  const data = await callClaude({
    model: 'claude-sonnet-4-20250514', max_tokens: 300,
    messages: [{ role: 'user', content: [
      { type: 'image', source: { type: 'base64', media_type: 'image/jpeg', data: base64Image }},
      { type: 'text', text: 'You are an import specialist. Analyze this product image.\nRespond ONLY with JSON, no markdown:\n{"name":"<product name in Portuguese 2-4 words>","ncm":"<8-digit NCM digits only or null>","desc":"<one sentence>","brand":"<brand if visible or null>"}\nIf unclear: {"name":null,"ncm":null,"desc":null,"brand":null}' }
    ]}]
  });
  const txt = (data.content || []).map(b => b.text || '').join('').trim();
  const m = txt.replace(/```json?|```/g, '').trim().match(/\{[\s\S]*\}/);
  if (!m) return null;
  const p = JSON.parse(m[0]);
  return p.name ? p : null;
}

function acceptCameraProduct() {
  const identified = window._camIdentified;
  if (!identified) return;
  const ncmClean = identified.ncm ? identified.ncm.replace(/\D/g,'') : null;
  const dbMatch = ncmClean ? ncmDB.find(n => n.code === ncmClean) : null;
  if (dbMatch) {
    pickProduct(dbMatch.code, identified.name, dbMatch.raw);
  } else {
    const fmtNCM = ncmClean ? ncmClean.replace(/(\d{4})(\d{2})(\d{2})/,'$1.$2.$3') : '';
    selectedProduct = { code: ncmClean||'', desc: identified.name.toUpperCase(), fmtNCM, fmtHTS: '' };
    const chip = document.getElementById('prodChip');
    chip.classList.add('show');
    document.getElementById('chipName').textContent = identified.name;
    document.getElementById('chipCodes').textContent = fmtNCM ? 'NCM ' + fmtNCM + ' (sugerido)' : 'Nome identificado por IA';
  }
  goToStep(2);
  calc();
  showToast('‚úÖ ' + identified.name + ' aplicado!');
  // price fetch only on button click
}

function clearCamera() {
  cameraProductName = '';
  cameraImageBase64 = '';
  document.getElementById('cameraIdle').style.display = 'flex';
  document.getElementById('cameraPreview').style.display = 'none';
  document.getElementById('previewImg').src = '';
  document.getElementById('camResult').className = 'cam-result';
  document.getElementById('camSpinner').classList.remove('active');
  document.getElementById('imgInput').value = '';
  updateSearchStatus();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// HELPERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function g(id) { return document.getElementById(id)?.value || ''; }
function v(id, val) { const el = document.getElementById(id); if(el) el.value = val; }
function f2(n) { if(n===null||n===undefined||isNaN(n)) return '0.00'; return parseFloat(n).toLocaleString('pt-BR',{minimumFractionDigits:2,maximumFractionDigits:2}); }

function bindInputs() {
  const noPriceDefault = ['priceRMB', 'priceUSD'];
  document.querySelectorAll('input[type=number], select').forEach(el => {
    el.addEventListener('change', calc);
    if (el.type === 'number' && !noPriceDefault.includes(el.id)) {
      el.addEventListener('focus', () => { if (!parseFloat(el.value)) el.value = ''; });
      el.addEventListener('blur',  () => { if (el.value === '') el.value = '0'; });
    }
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// RESET
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function resetAll() {
  // Clear product name and photo
  const ni = document.getElementById('prodNameInput'); if(ni) ni.value='';
  window._productPhoto = '';
  const pi = document.getElementById('productPhotoImg'); if(pi){pi.src='';pi.style.display='none';}
  const ps = document.getElementById('photoSlotIdle'); if(ps) ps.style.display='flex';
  // Reset to step 1
  setTimeout(()=>goToStep(1), 100);
  // Clear user-input fields only
  ['priceRMB','priceUSD','qty','monthly','freight','insurance','mlPrice','amzPrice',
   'srchInput','prodNameInput'].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.value = '';
  });
  var nd = document.getElementById('ncmDropdown'); if(nd) nd.style.display='none';
  // Hide BRL preview
  document.getElementById('brlPreview').style.display = 'none';
  // Clear auto-price result
  const apResult = document.getElementById('apResult');
  if (apResult) apResult.style.display = 'none';
  // Reset auto-price button
  const apBtn = document.getElementById('btnAutoPrice');
  if (apBtn) {
    apBtn.classList.remove('loading','success');
    document.getElementById('apBtnIcon').textContent = 'ü§ñ';
    document.getElementById('apBtnText').textContent = T('btnAutoPrice');
  }
  // Clear product selection
  clearProduct();
  clearCamera();
  updateSearchStatus();
  // Clear results
  document.getElementById('resultsArea').innerHTML = `
    <div class="empty-state">
      <div class="empty-icon">‚ö°</div>
      <div class="empty-text">${T('emptyState')}</div>
    </div>`;
  lastCalcResult = { br: null, us: null };
  usdEdited = false;
  showToast(T('toastReset'));
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SAVE PRODUCT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function saveProduct() {
  const _hasName = document.getElementById('prodNameInput')?.value.trim() || document.getElementById('srchInput').value.trim();
  if (!selectedProduct && !_hasName) { showToast(T('toastNoProduct')); return; }
  const { br, us } = lastCalcResult;
  if (!br && !us) { showToast(T('toastNoProduct')); return; }

  const name = (document.getElementById('prodNameInput')?.value.trim()) || (selectedProduct ? selectedProduct.desc : '') || document.getElementById('srchInput').value.trim() || 'Produto sem nome';
  const ncm  = selectedProduct ? selectedProduct.fmtNCM : '‚Äì';

  // Prevent duplicate saves of same product at same price
  const rmbVal = document.getElementById('priceRMB').value;
  const usdVal = document.getElementById('priceUSD').value;
  const dup = savedProducts.find(p => p.name === name && p.priceRMB === rmbVal);
  if (dup) { showToast(T('toastAlreadySaved')); return; }


  const entry = {
    id: Date.now(),
    savedDate: new Date().toLocaleDateString('pt-BR'),
    userName: localStorage.getItem('mavUserName') || '',
    name: name.charAt(0).toUpperCase() + name.slice(1).toLowerCase(),
    ncm,
    priceRMB: rmbVal,
    priceUSD: usdVal,
    qty: document.getElementById('qty').value,
    dest: currentDest,
    savedAt: new Date().toLocaleTimeString([], { hour:'2-digit', minute:'2-digit' }),
    // Brazil results
    brUnitCost: br ? br.unitBRL : null,
    brMargin:   br ? br.margBR  : null,
    brMonthly:  br ? br.monProfBR : null,
    brSuggest:  br ? br.suggestBR : null,
    mlPrice:    br ? br.mlP     : null,
    // USA results
    usUnitCost: us ? us.unitUS  : null,
    usMargin:   us ? us.margUS  : null,
    usMonthly:  us ? us.monProfUS : null,
    usSuggest:  us ? us.suggestUS : null,
    amzPrice:   us ? us.amzP    : null,
  };

  savedProducts.push(entry);
  persistSaved();
  renderSaved();
  showToast('‚òÖ ' + T('toastSaved'));
}

function persistSaved() {
  try { localStorage.setItem('mavSaved', JSON.stringify(savedProducts)); } catch(e) {}
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// RENDER SAVED LIST
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderSaved() {
  const list = document.getElementById('savedList');
  const count = document.getElementById('savedCount');
  if (!list) return;
  if(count) count.textContent = savedProducts.length;
  if (!savedProducts.length) {
    list.innerHTML = '<div class="saved-empty"><div style="font-size:2.5rem;margin-bottom:8px">üì≠</div><div>Nenhum produto salvo ainda.</div><div style="font-size:.75rem;margin-top:6px;opacity:.6">Calcule um produto e clique em ‚òÖ Salvar</div></div>';
    return;
  }
  list.innerHTML = savedProducts.map((p, i) => {
    const chips = [];
    if (p.priceUSD) chips.push(`<span class="si-chip gold">US$${parseFloat(p.priceUSD).toFixed(2)}</span>`);
    if (p.brMargin != null) {
      const cls = p.brMargin>=35?'green':p.brMargin>=15?'blue':'red';
      chips.push(`<span class="si-chip ${cls}">üáßüá∑ ${p.brMargin.toFixed(1)}%</span>`);
    }
    if (p.usMargin != null) {
      const cls = p.usMargin>=30?'green':p.usMargin>=15?'blue':'red';
      chips.push(`<span class="si-chip ${cls}">üá∫üá∏ ${p.usMargin.toFixed(1)}%</span>`);
    }
    if (p.mlPrice)  chips.push(`<span class="si-chip green">ML R$${f2(p.mlPrice)}</span>`);
    if (p.amzPrice) chips.push(`<span class="si-chip blue">AMZ $${f2(p.amzPrice)}</span>`);
    if (p.ncm && p.ncm!=='‚Äì') chips.push(`<span class="si-chip muted">${p.ncm}</span>`);
    const photoEl = p.photoData
      ? `<img style="width:48px;height:48px;border-radius:10px;object-fit:cover;flex-shrink:0;border:1px solid rgba(255,255,255,.1)" src="${p.photoData}" alt="">`
      : `<div style="width:48px;height:48px;border-radius:10px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.1);display:flex;align-items:center;justify-content:center;font-size:1.4rem;flex-shrink:0">üì¶</div>`;
    return `<div class="saved-item" data-idx="${i}">
      ${photoEl}
      <div class="si-body">
        <div class="si-name">${p.name}</div>
        <div class="si-chips">${chips.join('')}</div>
        <div class="si-meta">${p.userName||'Usu√°rio'}${p.trip?' ¬∑ üìç'+p.trip:''} ¬∑ ${p.savedAt||''}</div>
        ${p.notes?`<div class="si-notes">${p.notes}</div>`:''}
      </div>
      <div class="si-actions">
        <button class="btn-si load" onclick="loadSaved(${i})" title="Carregar">‚Ü©</button>
        <button class="btn-si copy" onclick="copySavedRow(${i})" title="Copiar para Sheets">üìã</button>
        <button class="btn-si wa" onclick="shareOneProduct(${i})" title="WhatsApp">üí¨</button>
        <button class="btn-si del" onclick="deleteSaved(${i})" title="Deletar">‚úï</button>
      </div>
    </div>`;
  }).join('');
}

function loadSaved(i) {
  const p = savedProducts[i];
  if (!p) return;
  // Restore name
  const ni = document.getElementById('prodNameInput'); if(ni) ni.value = p.name||'';
  // Restore price
  if (p.priceUSD) { document.getElementById('priceUSD').value = parseFloat(p.priceUSD).toFixed(2); usdEdited = true; }
  if (p.priceRMB) { document.getElementById('priceRMB').value = parseFloat(p.priceRMB).toFixed(2); }
  updateBRLPreview(parseFloat(p.priceUSD)||0);
  if (p.qty)     { const el=document.getElementById('qty');     if(el) el.value=p.qty; }
  if (p.mlPrice)  { const el=document.getElementById('mlPrice');  if(el) el.value=parseFloat(p.mlPrice).toFixed(2); }
  if (p.amzPrice) { const el=document.getElementById('amzPrice'); if(el) el.value=parseFloat(p.amzPrice).toFixed(2); }
  // Restore NCM chip
  if (p.ncm && p.ncm !== '‚Äì') {
    document.getElementById('prodChip').classList.add('show');
    document.getElementById('chipName').textContent = p.name;
    document.getElementById('chipCodes').textContent = 'NCM ' + p.ncm + (p.hts ? ' | HTS ' + p.hts : '');
    selectedProduct = { code: p.ncm.replace(/\D/g,''), desc: p.name, fmtNCM: p.ncm, fmtHTS: p.hts||'' };
  }
  setDest(p.dest ?? 2);
  goToStep(2);
  calc();
  showToast('üì¶ ' + p.name + ' carregado!');
}

function deleteSaved(i) {
  savedProducts.splice(i, 1);
  persistSaved();
  renderSaved();
  showToast(T('toastDeleted'));
}

function copySavedRow(i) {
  var p = savedProducts[i];
  if (!p) return;
  var cols = [p.name||"",p.ncm||"",p.priceUSD||"",p.priceRMB||"",p.qty||"",
    p.brUnitCost!=null?p.brUnitCost.toFixed(2):"",
    p.brMargin!=null?p.brMargin.toFixed(1):"",
    p.brSuggest!=null?p.brSuggest.toFixed(2):"",
    p.mlPrice!=null?p.mlPrice.toFixed(2):"",
    p.usUnitCost!=null?p.usUnitCost.toFixed(2):"",
    p.usMargin!=null?p.usMargin.toFixed(1):"",
    p.usSuggest!=null?p.usSuggest.toFixed(2):"",
    p.amzPrice!=null?p.amzPrice.toFixed(2):"",
    p.savedAt||""];
  var row=cols.join("\t");
  navigator.clipboard.writeText(row).then(function(){showToast("Copiado! Cole no Sheets com Cmd+V");}).catch(function(){var ta=document.createElement("textarea");ta.value=row;document.body.appendChild(ta);ta.select();document.execCommand("copy");document.body.removeChild(ta);showToast("Copiado!");});
}

function copyAllSaved() {
  if (!savedProducts.length){showToast("Nenhum produto salvo");return;}
  var hdr=["Nome","NCM","USD","RMB","Qty","Custo BR","Margem BR%","Sug BR","ML Price","Custo US","Margem US%","Sug US","AMZ Price","Salvo"].join("\t");
  var lines=[hdr];
  savedProducts.forEach(function(p){lines.push([p.name||"",p.ncm||"",p.priceUSD||"",p.priceRMB||"",p.qty||"",p.brUnitCost!=null?p.brUnitCost.toFixed(2):"",p.brMargin!=null?p.brMargin.toFixed(1):"",p.brSuggest!=null?p.brSuggest.toFixed(2):"",p.mlPrice!=null?p.mlPrice.toFixed(2):"",p.usUnitCost!=null?p.usUnitCost.toFixed(2):"",p.usMargin!=null?p.usMargin.toFixed(1):"",p.usSuggest!=null?p.usSuggest.toFixed(2):"",p.amzPrice!=null?p.amzPrice.toFixed(2):"",p.savedAt||""].join("\t"));});
  var all=lines.join("\n");
  navigator.clipboard.writeText(all).then(function(){showToast(savedProducts.length+" produtos copiados! Cole com Cmd+V");}).catch(function(){var ta=document.createElement("textarea");ta.value=all;document.body.appendChild(ta);ta.select();document.execCommand("copy");document.body.removeChild(ta);showToast("Copiado!");});
}

function clearAllSaved() {
  if (!savedProducts.length) return;
  if (!confirm(lang === 'pt' ? 'Limpar todos os produtos salvos?' : 'Clear all saved products?')) return;
  savedProducts = [];
  persistSaved();
  renderSaved();
  showToast(T('toastCleared'));
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// EXPORT CSV
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function exportSaved() {
  if (!savedProducts.length) return;
  const hdr = ['#','Name','NCM','Price RMB','Price USD','Qty','BR Unit Cost R$','BR Margin %','BR Market Price R$','BR Suggested R$','BR Monthly Profit R$','US Unit Cost US$','US Margin %','AMZ Price US$','US Suggested US$','US Monthly Profit US$','Saved At'];
  const rows = savedProducts.map((p,i) => [
    i+1, p.name, p.ncm, p.priceRMB, p.priceUSD, p.qty,
    p.brUnitCost?.toFixed(2) ?? '', p.brMargin?.toFixed(1) ?? '', p.mlPrice?.toFixed(2) ?? '', p.brSuggest?.toFixed(2) ?? '', p.brMonthly?.toFixed(0) ?? '',
    p.usUnitCost?.toFixed(2) ?? '', p.usMargin?.toFixed(1) ?? '', p.amzPrice?.toFixed(2) ?? '', p.usSuggest?.toFixed(2) ?? '', p.usMonthly?.toFixed(0) ?? '',
    p.savedAt
  ]);
  const csv = [hdr, ...rows].map(r => r.map(c => `"${c}"`).join(',')).join('\n');
  const blob = new Blob([csv], { type: 'text/csv' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `mavericks_import_${new Date().toISOString().slice(0,10)}.csv`;
  a.click();
  showToast(T('toastExported'));
}
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// AUTO PRICE FETCH ‚Äî Claude API with web_search tool
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let lastFetchedPrices = { mlPrice: null, amzPrice: null };

async function fetchMarketPrices() {
  const productName = selectedProduct
    ? selectedProduct.desc
    : (cameraProductName || document.getElementById('srchInput').value.trim());

  if (!productName) { showToast(T('apNeedProduct')); return; }

  const btn = document.getElementById('btnAutoPrice');
  const statusEl = document.getElementById('apStatus');
  const resultEl = document.getElementById('apResult');

  // Set loading state
  btn.disabled = true;
  btn.classList.add('loading');
  document.getElementById('apBtnIcon').textContent = '‚è≥';
  document.getElementById('apBtnText').textContent = T('apSearchingML');
  statusEl.style.display = 'flex';
  document.getElementById('apStatusMsg').textContent = T('apSearchingML');
  document.getElementById('apStatusStep').textContent = '';
  resultEl.style.display = 'none';

  // Shimmer on price fields
  ['fML','fAMZ'].forEach(id => document.getElementById(id)?.classList.add('field-fetching'));

  try {
    const dest = currentDest; // 0=BR, 1=US, 2=both
    const searchBR = (dest === 0 || dest === 2);
    const searchUS = (dest === 1 || dest === 2);

    const prompt = buildPriceSearchPrompt(productName, searchBR, searchUS);

    document.getElementById('apStatusMsg').textContent = T('apSearchingML');
    document.getElementById('apStatusStep').textContent = productName;

    const data = await callClaude({
      model: 'claude-haiku-4-5-20251001', max_tokens: 1024,
      tools: [{ type: 'web_search_20250305', name: 'web_search' }],
      messages: [{ role: 'user', content: prompt }]
    });

    // Update step text while searching
    document.getElementById('apStatusMsg').textContent = T('apSearchingAMZ');

    // Extract text from response (may have tool_use + text blocks)
    const textContent = (data.content || [])
      .filter(b => b.type === 'text')
      .map(b => b.text).join('');

    // Parse JSON from the response
    const prices = extractPricesFromResponse(textContent);
    lastFetchedPrices = prices;

    statusEl.style.display = 'none';
    btn.classList.remove('loading');
    btn.disabled = false;
    document.getElementById('apBtnIcon').textContent = prices.mlPrice || prices.amzPrice ? '‚úÖ' : 'ü§ñ';
    document.getElementById('apBtnText').textContent = prices.mlPrice || prices.amzPrice
      ? T('apFound') : T('apFailed');
    btn.classList.add(prices.mlPrice || prices.amzPrice ? 'success' : '');

    ['fML','fAMZ'].forEach(id => document.getElementById(id)?.classList.remove('field-fetching'));

    if (prices.mlPrice || prices.amzPrice) {
      renderAutoPriceResult(prices, productName);
      showToast(T('apFound'));
      // Auto-apply prices ‚Äî USD stays primary
      if (prices.mlPrice) { document.getElementById('mlPrice').value = prices.mlPrice.toFixed(2); }
      if (prices.amzPrice) { document.getElementById('amzPrice').value = prices.amzPrice.toFixed(2); }
      calc();
    } else {
      resultEl.style.display = 'none';
      showToast(T('apFailed'));
      setTimeout(() => {
        btn.classList.remove('success');
        document.getElementById('apBtnIcon').textContent = 'ü§ñ';
        document.getElementById('apBtnText').textContent = T('btnAutoPrice');
      }, 4000);
    }
  } catch(err) {
    console.warn('Auto-price error:', err);
    statusEl.style.display = 'none';
    btn.disabled = false;
    btn.classList.remove('loading');
    document.getElementById('apBtnIcon').textContent = 'ü§ñ';
    document.getElementById('apBtnText').textContent = T('btnAutoPrice');
    ['fML','fAMZ'].forEach(id => document.getElementById(id)?.classList.remove('field-fetching'));
    showToast(T('apFailed'));
  }
}

function buildPriceSearchPrompt(productName, searchBR, searchUS) {
  const tasks = [];
  if (searchBR) tasks.push(`Search for "${productName}" on mercadolivre.com.br and return the typical selling price range in Brazilian Reais (BRL). Find at least 3 listings to calculate an average.`);
  if (searchUS) tasks.push(`Search for "${productName}" on amazon.com and return the typical selling price in USD. Find at least 3 listings to calculate an average.`);

  return `You are a market research assistant helping with import viability analysis.

${tasks.join('\n')}

After searching, respond ONLY with a JSON object (no markdown, no explanation):
{
  "mlPrice": <average BRL price as number, or null if not found/not applicable>,
  "amzPrice": <average USD price as number, or null if not found/not applicable>,
  "mlSources": "<brief note on what you found, e.g. '3 listings R$89‚ÄìR$149, avg R$119'>",
  "amzSources": "<brief note on what you found>",
  "productFound": <true or false>
}

If you cannot find reliable prices for a market, set that price to null.`;
}

function extractPricesFromResponse(text) {
  try {
    const clean = text.replace(/```json?|```/g, '').trim();
    // Find JSON object in text
    const match = clean.match(/\{[\s\S]*\}/);
    if (!match) return { mlPrice: null, amzPrice: null };
    const parsed = JSON.parse(match[0]);
    return {
      mlPrice:    parsed.mlPrice  ? parseFloat(parsed.mlPrice)  : null,
      amzPrice:   parsed.amzPrice ? parseFloat(parsed.amzPrice) : null,
      mlSources:  parsed.mlSources  || '',
      amzSources: parsed.amzSources || '',
    };
  } catch(e) {
    return { mlPrice: null, amzPrice: null };
  }
}

function renderAutoPriceResult(prices, productName) {
  const el = document.getElementById('apResult');
  const rows = [];
  if (prices.mlPrice)  rows.push(`<div class="apr-row"><span class="apr-k">${T('apMLLabel')}</span><div class="apr-v"><span class="apr-price">R$ ${f2(prices.mlPrice)}</span><span class="apr-tag">auto</span></div></div>${prices.mlSources ? `<div style="font-size:0.68rem;color:var(--muted);padding:3px 0 5px">${prices.mlSources}</div>` : ''}`);
  if (prices.amzPrice) rows.push(`<div class="apr-row"><span class="apr-k">${T('apAMZLabel')}</span><div class="apr-v"><span class="apr-price">US$ ${f2(prices.amzPrice)}</span><span class="apr-tag">auto</span></div></div>${prices.amzSources ? `<div style="font-size:0.68rem;color:var(--muted);padding:3px 0 5px">${prices.amzSources}</div>` : ''}`);
  const useBtn = (prices.mlPrice||prices.amzPrice) ? `
    <button onclick="applyFetchedPrices()" style="width:100%;margin-top:12px;padding:13px;border-radius:12px;background:var(--blue);color:#fff;border:none;font-size:14px;font-weight:700;cursor:pointer">‚úÖ Usar estes pre√ßos nos campos</button>
    <div style="font-size:11px;color:var(--t4);text-align:center;margin-top:5px">ou preencha manualmente acima</div>` : '';
  el.innerHTML = `<div class="apr-title">ü§ñ Pre√ßos encontrados: <strong>${productName}</strong></div>${rows.join('')}${useBtn}<div class="apr-source" style="margin-top:8px"><span class="apr-source-dot"></span>${T('apSourceNote')}</div>`;
  el.style.display = 'block';
}

function applyFetchedPrices() {
  if (!lastFetchedPrices) return;
  if (lastFetchedPrices.mlPrice)  { document.getElementById('mlPrice').value  = lastFetchedPrices.mlPrice.toFixed(2); }
  if (lastFetchedPrices.amzPrice) { document.getElementById('amzPrice').value = lastFetchedPrices.amzPrice.toFixed(2); }
  calc();
  showToast('‚úÖ Pre√ßos aplicados!');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// WHATSAPP MODAL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openWAModal() {
  if (!savedProducts.length) { showToast(T('waNoProducts')); return; }
  // Apply translated select options
  const sel = document.getElementById('waFilter');
  sel.options[0].text = T('waFilterAll');
  sel.options[1].text = T('waFilterViable');
  sel.options[2].text = T('waFilterWinners');
  buildWAMessage();
  document.getElementById('waOverlay').classList.add('open');
  document.body.style.overflow = 'hidden';
}

function closeWAModal() {
  document.getElementById('waOverlay').classList.remove('open');
  document.body.style.overflow = '';
}

function onOverlayClick(e) {
  if (e.target === document.getElementById('waOverlay')) closeWAModal();
}

function buildWAMessage() {
  const filter  = document.getElementById('waFilter').value;
  const context = document.getElementById('waContext').value.trim();

  const todayStr = new Date().toLocaleDateString('pt-BR');
  const weekAgo  = Date.now() - 7*24*60*60*1000;
  let products = [...savedProducts];
  if (filter === 'current') {
    const br = lastCalcResult?.br, us = lastCalcResult?.us;
    if (br || us) {
      const chipName = document.getElementById('chipName')?.textContent?.trim();
      products = [{ name: (chipName && chipName!=='‚Äì') ? chipName : 'Produto atual',
        ncm: selectedProduct?.fmtNCM||'‚Äì', priceUSD: document.getElementById('priceUSD')?.value,
        qty: document.getElementById('qty')?.value,
        brUnitCost:br?.unitBRL, brMargin:br?.margBR, brMonthly:br?.monProfBR, brSuggest:br?.suggestBR,
        mlPrice: parseFloat(document.getElementById('mlPrice')?.value)||null,
        usUnitCost:us?.unitUS, usMargin:us?.margUS, usMonthly:us?.monProfUS,
        amzPrice: parseFloat(document.getElementById('amzPrice')?.value)||null,
        userName: currentUser?.name, savedAt: new Date().toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'}) }];
    } else { products = savedProducts.length ? [savedProducts[savedProducts.length-1]] : []; }
  } else if (filter === 'viable')  { products = products.filter(p => (p.brMargin??0)>=25||(p.usMargin??0)>=25);
  } else if (filter === 'winners') { products = products.filter(p => (p.brMargin??0)>=35||(p.usMargin??0)>=35);
  } else if (filter === 'today')   { products = products.filter(p => p.savedDate===todayStr||(p.id&&new Date(p.id).toLocaleDateString('pt-BR')===todayStr));
  } else if (filter === 'week')    { products = products.filter(p => p.id&&p.id>weekAgo);
  } else if (filter === 'winners_today') { products = products.filter(p => ((p.brMargin??0)>=35||(p.usMargin??0)>=35)&&(p.savedDate===todayStr||(p.id&&new Date(p.id).toLocaleDateString('pt-BR')===todayStr)));
  } else if (filter === 'winners_week')  { products = products.filter(p => ((p.brMargin??0)>=35||(p.usMargin??0)>=35)&&p.id&&p.id>weekAgo);
  }

  const isEN = lang === 'en';
  const lines = [];

  // ‚îÄ‚îÄ Header ‚îÄ‚îÄ
  lines.push(isEN ? 'üöÄ *MAVERICKS IMPORT HUNTER*' : 'üöÄ *MAVERICKS IMPORT HUNTER*');
  lines.push(isEN ? `üìä *Opportunity Report ‚Äî ${new Date().toLocaleDateString()}*` : `üìä *Relat√≥rio de Oportunidades ‚Äî ${new Date().toLocaleDateString('pt-BR')}*`);
  if (context) lines.push(`\nüí¨ _${context}_`);
  lines.push('');
  lines.push(isEN ? `üì¶ *${products.length} product${products.length !== 1 ? 's' : ''} analyzed*` : `üì¶ *${products.length} produto${products.length !== 1 ? 's' : ''} analisado${products.length !== 1 ? 's' : ''}*`);
  lines.push('‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ');

  // ‚îÄ‚îÄ Products ‚îÄ‚îÄ
  products.forEach((p, i) => {
    const brM = p.brMargin != null ? p.brMargin.toFixed(1) : null;
    const usM = p.usMargin != null ? p.usMargin.toFixed(1) : null;

    // Verdict emoji
    const maxM = Math.max(p.brMargin ?? 0, p.usMargin ?? 0);
    const em = maxM >= 35 ? 'üèÜ' : maxM >= 25 ? '‚úÖ' : maxM >= 10 ? '‚ö†Ô∏è' : '‚ùå';

    lines.push('');
    lines.push(`${em} *${i+1}. ${p.name}*`);
    if (p.ncm && p.ncm !== '‚Äì') lines.push(`   NCM: \`${p.ncm}\``);
    if (p.userName)  lines.push(`   üë§ ${p.userName}${p.trip ? '  üìç ' + p.trip : ''}`);
    else if (p.trip) lines.push(`   üìç ${p.trip}`);

    // Price in
    if (p.priceRMB) lines.push(`   üí∞ ${isEN ? 'Purchase price' : 'Pre√ßo de compra'}: ¬•${parseFloat(p.priceRMB).toFixed(2)} / US$${parseFloat(p.priceUSD||0).toFixed(2)}`);
    if (p.qty)      lines.push(`   üì¶ ${isEN ? 'Qty' : 'Qtd'}: ${parseInt(p.qty).toLocaleString()} ${isEN ? 'units' : 'unid.'}`);

    // Brazil
    if (p.brUnitCost != null) {
      const margColor = brM >= 35 ? 'üü¢' : brM >= 25 ? 'üü°' : 'üî¥';
      lines.push(`   üáßüá∑ *Brasil*`);
      lines.push(`      ${isEN ? 'Landed cost' : 'Custo desembarcado'}: R$${f2(p.brUnitCost)}/un`);
      if (brM)    lines.push(`      ${isEN ? 'Margin' : 'Margem'}: ${margColor} *${brM}%*`);
      if (p.mlPrice) lines.push(`      ${isEN ? 'Market price (ML)' : 'Pre√ßo de mercado (ML)'}: R$${f2(p.mlPrice)}`);
      if (p.brMonthly != null) lines.push(`      ${isEN ? 'Est. monthly profit' : 'Lucro mensal est.'}: R$${f2(p.brMonthly)}`);
      if (p.brSuggest != null && !p.mlPrice) lines.push(`      ${isEN ? 'Suggested price' : 'Pre√ßo sugerido'}: R$${f2(p.brSuggest)}`);
    }

    // USA
    if (p.usUnitCost != null) {
      const margColor = usM >= 35 ? 'üü¢' : usM >= 25 ? 'üü°' : 'üî¥';
      lines.push(`   üá∫üá∏ *USA*`);
      lines.push(`      ${isEN ? 'Landed cost' : 'Custo desembarcado'}: US$${f2(p.usUnitCost)}/unit`);
      if (usM)    lines.push(`      Margin: ${margColor} *${usM}%*`);
      if (p.amzPrice) lines.push(`      ${isEN ? 'Amazon price' : 'Pre√ßo Amazon'}: US$${f2(p.amzPrice)}`);
      if (p.usMonthly != null) lines.push(`      ${isEN ? 'Est. monthly profit' : 'Lucro mensal est.'}: US$${f2(p.usMonthly)}`);
    }
  });

  // ‚îÄ‚îÄ Summary ‚îÄ‚îÄ
  lines.push('');
  lines.push('‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ');
  const viable  = savedProducts.filter(p => (p.brMargin ?? 0) >= 25 || (p.usMargin ?? 0) >= 25).length;
  const winners = savedProducts.filter(p => (p.brMargin ?? 0) >= 35 || (p.usMargin ?? 0) >= 35).length;
  lines.push(isEN ? `üìä *Summary:* ${savedProducts.length} total ¬∑ ${viable} viable ¬∑ ${winners} winners` : `üìä *Resumo:* ${savedProducts.length} total ¬∑ ${viable} vi√°veis ¬∑ ${winners} vencedores`);
  lines.push('');
  lines.push(isEN ? '_Generated by Mavericks Import Hunter v96_' : '_Gerado pelo Mavericks Import Hunter v96_');

  document.getElementById('waPreview').value = lines.join('\n');
}

function openWhatsApp() {
  const msg   = document.getElementById('waPreview').value;
  const phone = document.getElementById('waPhone').value.replace(/\D/g, '');
  const url   = phone
    ? `https://wa.me/${phone}?text=${encodeURIComponent(msg)}`
    : `https://wa.me/?text=${encodeURIComponent(msg)}`;
  window.open(url, '_blank');
  showToast(T('waOpened'));
}

function copyWAMessage() {
  const msg = document.getElementById('waPreview').value;
  navigator.clipboard?.writeText(msg)
    .then(() => showToast(T('waCopied')))
    .catch(() => {
      // Fallback for older browsers
      document.getElementById('waPreview').select();
      document.execCommand('copy');
      showToast(T('waCopied'));
    });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// v98: GOOGLE AUTH + SHEETS SYNC SYSTEM
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// ‚îÄ‚îÄ Config ‚Äî fully hardcoded, no setup needed by users ‚îÄ‚îÄ
const GSHEET_ID  = '1-5T0nmavcCSDWYPC_uHwESKoGGaHSbZg_HJuO2eVpH8';
const GCLIENT_ID = '233224120696-et8jjkj6bsetsk884krodnk6qv3r4ut5.apps.googleusercontent.com';
const GSCOPE = 'https://www.googleapis.com/auth/spreadsheets openid profile email';
const SHEET_NAME = 'Produtos';
const SHEET_COLS = ['ID','Nome','NCM','PriceUSD','PriceRMB','Qty','Destino','Trip','Notas',
                    'UserName','UserEmail','SavedAt','BRUnitCost','BRMargin','BRMonthly',
                    'BRSuggest','MLPrice','USUnitCost','USMargin','USMonthly','USSuggest','AMZPrice'];

// ‚îÄ‚îÄ Auth State ‚îÄ‚îÄ
let currentUser   = null;   // { name, email, picture, accessToken, tokenExpiry }
let gTokenClient  = null;
let gApiReady     = false;
let gTokenReady   = false;
let pendingSave   = null;
let tokenRefreshTimer = null;

// ‚îÄ‚îÄ Persist & restore full session including token ‚îÄ‚îÄ
function saveSession(user) {
  localStorage.setItem('mavSession', JSON.stringify({
    name:        user.name,
    email:       user.email,
    picture:     user.picture,
    accessToken: user.accessToken,
    tokenExpiry: user.tokenExpiry   // ms timestamp when token expires
  }));
}
function loadSession() {
  try {
    const s = localStorage.getItem('mavSession');
    if (!s) return null;
    const d = JSON.parse(s);
    // Token valid if it expires more than 2 minutes from now
    if (d.accessToken && d.tokenExpiry && d.tokenExpiry > Date.now() + 120000) {
      return d;
    }
    // Token expired but we have user info ‚Äî return without token for silent refresh
    if (d.name) return { ...d, accessToken: null, tokenExpiry: null };
    return null;
  } catch(e) { return null; }
}
function clearSession() {
  localStorage.removeItem('mavSession');
  // Keep mavUser for backwards compat display only
  localStorage.removeItem('mavUser');
}

// ‚îÄ‚îÄ Recent trips (for suggestions) ‚îÄ‚îÄ
function getRecentTrips() {
  try { return JSON.parse(localStorage.getItem('mavTrips') || '[]'); } catch(e) { return []; }
}
function addRecentTrip(trip) {
  if (!trip) return;
  const trips = getRecentTrips().filter(t => t !== trip);
  trips.unshift(trip);
  localStorage.setItem('mavTrips', JSON.stringify(trips.slice(0, 8)));
}

// ‚îÄ‚îÄ Google API loading ‚îÄ‚îÄ
function onGapiLoaded() { /* Google removed */ }
// Called by google gsi script onload
window.onGapiLoaded = onGapiLoaded;

// ‚îÄ‚îÄ Start login ‚îÄ‚îÄ
function startGoogleLogin() { /* Google removed */ }

// ‚îÄ‚îÄ User management ‚îÄ‚îÄ
function getUsers() {
  var stored = localStorage.getItem('mavUsers');
  if (stored) return JSON.parse(stored);
  var defaults = [{"name": "Sergio", "wa": "13054872000"}, {"name": "Barbara", "wa": "13059013000"}, {"name": "Ana Claudia", "wa": "5548999063778"}, {"name": "Marcus", "wa": "5548988434906"}, {"name": "Julia", "wa": "5548999286247"}];
  localStorage.setItem('mavUsers', JSON.stringify(defaults));
  return defaults;
}

function saveUsers(users) {
  localStorage.setItem('mavUsers', JSON.stringify(users));
}

function populateUserDropdown() {
  var sel = document.getElementById('userDropdown');
  if (!sel) return;
  var users = getUsers();
  sel.innerHTML = '<option value="">‚Äî Selecionar usu√°rio ‚Äî</option>';
  users.forEach(function(u, i) {
    var opt = document.createElement('option');
    opt.value = i;
    opt.textContent = u.name;
    sel.appendChild(opt);
  });
  // Pre-select last used
  var lastIdx = localStorage.getItem('mavLastUserIdx');
  if (lastIdx !== null) sel.value = lastIdx;
}

function confirmUserSelect() {
  var sel = document.getElementById('userDropdown');
  if (!sel || sel.value === '') { alert('Por favor selecione um usu√°rio'); return; }
  var users = getUsers();
  var u = users[parseInt(sel.value)];
  if (!u) return;
  localStorage.setItem('mavLastUserIdx', sel.value);
  selectUser(u.name, u.wa);
}

function selectUser(name, wa) {
  if (!name || !name.trim()) return;
  currentUser = { name: name.trim(), wa: wa || '' };
  localStorage.setItem('mavUserName', name.trim());
  if (wa) localStorage.setItem('mavUserWA', wa);
  var ls = document.getElementById('loginScreen');
  if (ls) ls.style.display = 'none';
  var uc = document.querySelector('.user-chip');
  if (uc) uc.style.display = 'flex';
  var un = document.getElementById('userChipName');
  if (un) un.textContent = name.trim();
  showToast('üëã Bem-vindo, ' + name.trim() + '!');
}

function renderUserListEditor() {
  var container = document.getElementById('userListEditor');
  if (!container) return;
  var users = getUsers();
  container.innerHTML = '';
  users.forEach(function(u, i) {
    var row = document.createElement('div');
    row.style.cssText = 'display:grid;grid-template-columns:1fr 1fr auto;gap:6px;align-items:center';
    row.innerHTML = '<input type="text" value="' + u.name + '" onchange="updateUser(' + i + ',\'name\',this.value)" style="padding:7px;border-radius:8px;background:var(--bg3);border:1px solid var(--sep);color:var(--t1);font-size:12px">'
      + '<input type="text" value="' + (u.wa||"") + '" onchange="updateUser(' + i + ',\'wa\',this.value)" placeholder="WhatsApp" style="padding:7px;border-radius:8px;background:var(--bg3);border:1px solid var(--sep);color:var(--t1);font-size:12px">'
      + '<button onclick="removeUser(' + i + ')" style="padding:7px 10px;background:var(--bg3);border:1px solid var(--red);color:var(--red);border-radius:8px;cursor:pointer;font-size:13px">‚úï</button>';
    container.appendChild(row);
  });
}

function addUserToList() {
  var name = document.getElementById('newUserName').value.trim();
  var wa   = document.getElementById('newUserWA').value.trim().replace(/\D/g,"");
  if (!name) { showToast('Digite um nome'); return; }
  var users = getUsers();
  users.push({ name: name, wa: wa });
  saveUsers(users);
  document.getElementById('newUserName').value = '';
  document.getElementById('newUserWA').value = '';
  renderUserListEditor();
  showToast('‚úÖ ' + name + ' adicionado!');
}

function updateUser(i, field, val) {
  var users = getUsers();
  if (!users[i]) return;
  if (field === "wa") val = val.replace(/\D/g,"");
  users[i][field] = val;
  saveUsers(users);
}

function removeUser(i) {
  var users = getUsers();
  var name = users[i]?.name || 'usu√°rio';
  users.splice(i, 1);
  saveUsers(users);
  renderUserListEditor();
  showToast(name + ' removido');
}

function initTokenClient() { /* Google removed */ }

async function onTokenReceived(tokenResponse) {
  if (tokenResponse.error) {
    // Silent refresh failed ‚Äî show login screen
    document.getElementById('loginScreen').style.display = 'flex';
    if (tokenResponse.error !== 'user_cancel') {
      console.warn('Token error:', tokenResponse.error);
    }
    return;
  }

  const accessToken = tokenResponse.access_token;
  const expiresIn   = (tokenResponse.expires_in || 3600) * 1000; // ms
  const tokenExpiry = Date.now() + expiresIn;

  // Schedule silent refresh 5 minutes before expiry
  if (tokenRefreshTimer) clearTimeout(tokenRefreshTimer);
  // tokenRefreshTimer removed

  // If we already have user info (silent refresh), just update token
  if (currentUser?.email) {
    currentUser.accessToken = accessToken;
    currentUser.tokenExpiry = tokenExpiry;
    if (gApiReady) gapi.client.setToken({ access_token: accessToken });
    saveSession(currentUser);
    gTokenReady = true;
    setSyncStatus('idle', '‚úì Sheets');
    return;
  }

  // First login ‚Äî decode user info from id_token JWT (no extra network call needed)
  try {
    // id_token is a JWT ‚Äî decode the payload (middle segment, base64url encoded)
    const idToken = tokenResponse.id_token;
    let info = null;

    if (idToken) {
      // Decode JWT payload without verifying signature (Google already verified it)
      const payload = idToken.split('.')[1];
      const decoded = JSON.parse(atob(payload.replace(/-/g, '+').replace(/_/g, '/')));
      info = {
        name:    decoded.name    || decoded.email?.split('@')[0] || 'Usu√°rio',
        email:   decoded.email   || '',
        picture: decoded.picture || ''
      };
    } else {
      // Fallback: fetch userinfo if no id_token (shouldn't happen but just in case)
      const res = await fetch('https://www.googleapis.com/oauth2/v3/userinfo', {
        headers: { Authorization: 'Bearer ' + accessToken }
      });
      info = await res.json();
    }

    currentUser = {
      name: info.name,
      email: info.email,
      picture: info.picture,
      accessToken,
      tokenExpiry
    };
    saveSession(currentUser);
    localStorage.setItem('mavUser', JSON.stringify({ name: info.name, email: info.email, picture: info.picture }));

    if (gApiReady) gapi.client.setToken({ access_token: accessToken });
    completeLogin();
  } catch(e) {
    console.error('Profile decode error:', e);
    // Last resort: create a minimal user from whatever we have
    currentUser = {
      name: 'Usu√°rio',
      email: '',
      picture: '',
      accessToken,
      tokenExpiry
    };
    saveSession(currentUser);
    if (gApiReady) gapi.client.setToken({ access_token: accessToken });
    completeLogin();
  }
}

function completeLogin() {
  // Hide login screen
  document.getElementById('loginScreen').style.display = 'none';

  // Update UI
  updateUserUI();

  // Set up token auto-refresh (Google tokens expire in 1h)
  gTokenReady = true;

  // Always sync ‚Äî both IDs are hardcoded
  showToast('üëã Bem-vindo, ' + currentUser.name.split(' ')[0] + '!');
}

function updateUserUI() {
  if (!currentUser) return;

  const pill = document.getElementById('userPill');
  pill.style.display = 'flex';

  const initials = currentUser.name.split(' ').map(w => w[0]).join('').toUpperCase().slice(0,2);
  const fallback = document.getElementById('userAvatarFallback');
  const img      = document.getElementById('userAvatarImg');

  if (currentUser.picture) {
    img.src = currentUser.picture;
    img.style.display = 'block';
    fallback.style.display = 'none';
  } else {
    fallback.textContent = initials;
    fallback.style.display = 'flex';
    img.style.display = 'none';
  }

  document.getElementById('userNameLabel').textContent = currentUser.name.split(' ')[0];
  document.getElementById('umName').textContent  = currentUser.name;
  document.getElementById('umEmail').textContent = currentUser.email;
}

function toggleUserMenu() {
  const menu = document.getElementById('userMenu');
  menu.classList.toggle('open');
}

document.addEventListener('click', e => {
  const menu = document.getElementById('userMenu');
  if (!e.target.closest('#userPill') && !e.target.closest('#userMenu')) {
    menu?.classList.remove('open');
  }
});

function signOut() {
  if (currentUser?.accessToken) {
    google.accounts.oauth2.revoke(currentUser.accessToken);
  }
  if (tokenRefreshTimer) clearTimeout(tokenRefreshTimer);
  currentUser = null;
  gTokenReady = false;
  clearSession();
  document.getElementById('userPill').style.display = 'none';
  document.getElementById('userMenu')?.classList.remove('open');
  document.getElementById('loginScreen').style.display = 'flex';
  showToast('üëã Sess√£o encerrada.');
}

// ‚îÄ‚îÄ Restore session ‚Äî called on page load ‚îÄ‚îÄ
function tryRestoreSession() {
  const session = loadSession();

  if (!session) {
    // No saved session at all ‚Äî show login
    document.getElementById('loginScreen').style.display = 'flex';
    return;
  }

  // Restore user info immediately (so UI shows name/avatar right away)
  currentUser = { ...session };
  updateUserUI();

  if (session.accessToken) {
    // Token is still valid ‚Äî go straight in, no Google popup at all
    document.getElementById('loginScreen').style.display = 'none';
    if (gApiReady) gapi.client.setToken({ access_token: session.accessToken });
    gTokenReady = true;

    // Schedule refresh before expiry
    const msLeft = session.tokenExpiry - Date.now();
    if (tokenRefreshTimer) clearTimeout(tokenRefreshTimer);
    // tokenRefreshTimer removed

    // Sheets sync removed
  }
}

// ‚îÄ‚îÄ Silent token refresh (no user interaction) ‚îÄ‚îÄ
function silentRefresh() { /* Google removed */ }

// ‚îÄ‚îÄ Sheet Info Modal ‚îÄ‚îÄ
function openSheetConfig() {
  document.getElementById('sheetConfigOverlay').classList.add('open');
  document.getElementById('userMenu')?.classList.remove('open');
}
function closeSheetConfig() {
  document.getElementById('sheetConfigOverlay').classList.remove('open');
}
function onSheetConfigOverlayClick(e) {
  if (e.target === document.getElementById('sheetConfigOverlay')) closeSheetConfig();
}

// ‚îÄ‚îÄ Sync status UI ‚îÄ‚îÄ
function setSyncStatus(state, label) {
  const pill = document.getElementById('syncPill');
  const lbl  = document.getElementById('syncLabel');
  if (!pill) return;
  pill.className = 'sync-pill ' + state;
  lbl.textContent = label;
}

// ‚îÄ‚îÄ Ensure header row exists ‚îÄ‚îÄ
async function ensureSheetHeader() { /* Google removed */ }

// ‚îÄ‚îÄ Append product row to sheet ‚îÄ‚îÄ
async function appendToSheet() { /* Google removed */ }

// ‚îÄ‚îÄ Read all products from sheet ‚îÄ‚îÄ
async function syncFromSheet() { /* Google removed */ }

// ‚îÄ‚îÄ Save Modal ‚îÄ‚îÄ
function openSaveModal() {
  const _hasName = document.getElementById('prodNameInput')?.value.trim() || document.getElementById('srchInput').value.trim();
  if (!selectedProduct && !_hasName) { showToast(T('toastNoProduct')); return; }
  const { br, us } = lastCalcResult;
  if (!br && !us) { showToast(T('toastNoProduct')); return; }

  // Populate who badge
  if (currentUser) {
    const initials = currentUser.name.split(' ').map(w=>w[0]).join('').toUpperCase().slice(0,2);
    const av = document.getElementById('saveWhoAvatar');
    av.textContent = initials;
    document.getElementById('saveWhoName').textContent  = currentUser.name;
    document.getElementById('saveWhoEmail').textContent = currentUser.email;
  }

  // Trip suggestions
  const trips = getRecentTrips();
  const sug = document.getElementById('tripSuggestions');
  sug.innerHTML = trips.map(t => `<span class="trip-sug" onclick="document.getElementById('tripTagInput').value='${t.replace(/'/g,"\\'")}'">${t}</span>`).join('');

  document.getElementById('tripTagInput').value   = '';
  document.getElementById('saveNotesInput').value = '';
  document.getElementById('saveOverlay').classList.add('open');
  document.body.style.overflow = 'hidden';
  setTimeout(() => document.getElementById('tripTagInput').focus(), 100);
}

function closeSaveModal() {
  document.getElementById('saveOverlay').classList.remove('open');
  document.body.style.overflow = '';
}
function onSaveOverlayClick(e) {
  if (e.target === document.getElementById('saveOverlay')) closeSaveModal();
}

async function confirmSaveProduct() {
  const trip  = document.getElementById('tripTagInput').value.trim();
  const notes = document.getElementById('saveNotesInput').value.trim();
  closeSaveModal();
  await saveProduct(trip, notes);
  if (trip) addRecentTrip(trip);
}

// ‚îÄ‚îÄ OVERRIDE saveProduct to accept trip+notes and sync to sheet ‚îÄ‚îÄ
async function saveProduct(trip = '', notes = '') {
  const _hasName = document.getElementById('prodNameInput')?.value.trim() || document.getElementById('srchInput').value.trim();
  if (!selectedProduct && !_hasName) { showToast(T('toastNoProduct')); return; }
  const { br, us } = lastCalcResult;
  if (!br && !us) { showToast(T('toastNoProduct')); return; }

  const name = (document.getElementById('prodNameInput')?.value.trim()) || (selectedProduct ? selectedProduct.desc : '') || document.getElementById('srchInput').value.trim() || 'Produto sem nome';
  const ncm  = selectedProduct ? selectedProduct.fmtNCM : '‚Äì';

  const rmbVal = document.getElementById('priceRMB').value;
  const usdVal = document.getElementById('priceUSD').value;
  const dup = savedProducts.find(p => p.name === name && p.priceUSD === usdVal);
  if (dup) { showToast(T('toastAlreadySaved')); return; }

  const entry = {
    id:         Date.now(),
    name:       name.charAt(0).toUpperCase() + name.slice(1).toLowerCase(),
    ncm,
    priceRMB:   rmbVal,
    priceUSD:   usdVal,
    qty:        document.getElementById('qty').value,
    dest:       currentDest,
    trip:       trip,
    notes:      notes,
    savedAt:    new Date().toLocaleString('pt-BR'),
    userName:   currentUser?.name  || 'Usu√°rio',
    userEmail:  currentUser?.email || '',
    // Brazil
    brUnitCost: br ? br.unitBRL    : null,
    brMargin:   br ? br.margBR     : null,
    brMonthly:  br ? br.monProfBR  : null,
    brSuggest:  br ? br.suggestBR  : null,
    mlPrice:    br ? br.mlP        : null,
    // USA
    usUnitCost: us ? us.unitUS     : null,
    usMargin:   us ? us.margUS     : null,
    usMonthly:  us ? us.monProfUS  : null,
    usSuggest:  us ? us.suggestUS  : null,
    amzPrice:   us ? us.amzP       : null,
  };

  savedProducts.push(entry);
  persistSaved();
  renderSaved();
  showToast('‚òÖ ' + T('toastSaved'));

  // Sync to Google Sheets
  if (GSHEET_ID && gApiReady && currentUser?.accessToken) {
    const ok = await appendToSheet(entry);
    if (!ok) showToast('‚ö†Ô∏è Salvo local. Sincronize manualmente depois.');
  } else if (GSHEET_ID) {
    showToast('‚ö†Ô∏è Salvo local. Configure o Sheets para sincronizar.');
  }
}


// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SETTINGS MODAL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openSettings() {
  renderUserListEditor();
  document.getElementById('settWorkerUrl').value = getProxyUrl();
  document.getElementById('sII').value     = document.getElementById('brII')?.value || '20';
  document.getElementById('sIPI').value    = document.getElementById('brIPI')?.value || '0';
  document.getElementById('sICMS').value   = document.getElementById('brICMS')?.value || '18';
  document.getElementById('sPIS').value    = document.getElementById('brPIS')?.value || '1.65';
  document.getElementById('sCOFINS').value = document.getElementById('brCOFINS')?.value || '7.6';
  document.getElementById('sFixed').value  = document.getElementById('brFixed')?.value || '1164';
  document.getElementById('sDuty').value   = document.getElementById('usDuty')?.value || '2.5';
  document.getElementById('sBroker').value = document.getElementById('usFixed')?.value || '';
  document.getElementById('settingsOverlay').style.display = 'block';
}
function closeSettings() {
  document.getElementById('settingsOverlay').style.display = 'none';
}
function saveSettings() {
  const url = document.getElementById('settWorkerUrl').value.trim();
  if (url) localStorage.setItem('mavericks_proxy_url', url);
  const map = [['sII','brII'],['sIPI','brIPI'],['sICMS','brICMS'],['sPIS','brPIS'],
               ['sCOFINS','brCOFINS'],['sFixed','brFixed'],['sDuty','usDuty'],['sBroker','usFixed']];
  map.forEach(([s,f]) => { const el=document.getElementById(f); if(el) el.value=document.getElementById(s).value; });
  calc();
  closeSettings();
  showToast('‚úÖ Configura√ß√µes salvas!');
}
async function testWorker() {
  const url = document.getElementById('settWorkerUrl').value.trim();
  const st  = document.getElementById('settWorkerStatus');
  if (!url) { st.textContent = '‚ö†Ô∏è Digite o URL primeiro'; return; }
  st.textContent = '‚è≥ Testando...';
  try {
    const r = await fetch(url, {method:'POST',headers:{'Content-Type':'application/json'},
      body: JSON.stringify({model:'claude-haiku-4-5-20251001',max_tokens:5,messages:[{role:'user',content:'hi'}]})});
    const d = await r.json();
    if (d.content || d.type === 'message') {
      st.style.color='var(--green)'; st.textContent = '‚úÖ Worker funcionando!';
      localStorage.setItem('mavericks_proxy_url', url);
    } else {
      st.style.color='var(--red)'; st.textContent = '‚ö†Ô∏è Resposta inesperada: ' + JSON.stringify(d).slice(0,60);
    }
  } catch(e) {
    st.style.color='var(--red)'; st.textContent = '‚ùå Erro: ' + e.message;
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SHOW TOAST
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let toastTimer;
function showToast(msg, dur=3000) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => t.classList.remove('show'), dur);
}

// Override window.onload: call goToStep(1) first, then base init
const _baseOnload = window.onload;
window.onload = async function() {
  goToStep(1);
  if (_baseOnload) await _baseOnload();
  // Hook calc to also update dual display
  const _bc = window.calc;
  window.calc = function() { try { _bc(); } catch(e){} updatePriceDual(); };
  const _bo = window.onUSD;
  window.onUSD = function() { try { _bo(); } catch(e){} updatePriceDual(); };
};

// Close menus on outside tap
document.addEventListener('click', function(e) {
  if (!e.target.closest('#userPill') && !e.target.closest('#userMenu'))
    document.getElementById('userMenu')?.classList.remove('open');
  if (!e.target.closest('#srchInput') && !e.target.closest('#acDrop')) {
    const dd = document.getElementById('acDrop');
    if (dd && dd.classList.contains('open')) dd.classList.remove('open');
  }
});

// i18n extra keys for new HTML elements
const _ext = {
  pt: {
    p1Title: 'Identifica√ß√£o do Produto',
    prodNameLabel: 'Nome do produto',
    prodNamePh: 'Ex: √ìculos solar, drone, t√™nis‚Ä¶',
    searchPh: 'Digite o produto (m√≠n. 2 letras)‚Ä¶',
    camTitle: 'Fotografar para identificar NCM (IA)',
    camSub: 'IA analisa e sugere classifica√ß√£o aduaneira',
    btnNext1: 'Pr√≥ximo: Pre√ßo e Custos ‚Üí',
    destLabel: 'Destino de Importa√ß√£o',
    pricingTitle: 'Pre√ßo China + Convers√£o em Tempo Real',
    exRateLabel: 'C√¢mbio (toque para ajustar)',
    logisticsTitle: 'Log√≠stica Internacional',
    freightLabel: 'Frete Internacional USD',
    insuranceLabel: 'Seguro USD',
    shipModeLabel: 'Modal',
    contTypeLabel: 'Container',
    portLabel: 'Porto',
    brTaxTitle: 'üáßüá∑ Impostos Brasil (auto pelo NCM)',
    simplifiedLabel: 'Modo Simplificado ‚Äî China Gate / ‚â§ US$50',
    fixedLabel: 'Fixos R$',
    usTaxTitle: 'üá∫üá∏ Impostos USA (Tarifas 2026)',
    marginTitle: 'Meta de Margem',
    minMarginLabel: 'Margem m√≠nima desejada',
    btnNext2: 'Mercado de Venda ‚Üí',
    mktTitle: 'Pre√ßo dos Concorrentes',
    researchTitle: 'Pesquisar Pre√ßos Online',
    autoPriceBtn: 'Buscar Pre√ßos Automaticamente (IA)',
    btnCalc: 'Calcular Resultado ‚Üí',
    btnSave: 'Salvar Produto',
    btnWA: 'Compartilhar via WhatsApp',
    btnReset: 'Nova Busca',
    btnSavedNav: 'üìã Produtos Salvos ‚Üí',
    savedTitle: 'üì¶ Produtos Salvos',
    savedSearchPh: 'Buscar por nome, NCM, feira, usu√°rio‚Ä¶',
    btnNewProduct: '+ Analisar Novo Produto',
  },
  en: {
    p1Title: 'Product Identification',
    prodNameLabel: 'Product name',
    prodNamePh: 'Ex: Sunglasses, drone, sneakers‚Ä¶',
    searchPh: 'Type product name (min. 2 chars)‚Ä¶',
    camTitle: 'Take photo to identify NCM/HTS (AI)',
    camSub: 'AI analyzes and suggests customs classification',
    btnNext1: 'Next: Price & Costs ‚Üí',
    destLabel: 'Import Destination',
    pricingTitle: 'China Price + Real-Time Conversion',
    exRateLabel: 'Exchange rates (tap to adjust)',
    logisticsTitle: 'International Logistics',
    freightLabel: 'International Freight USD',
    insuranceLabel: 'Insurance USD',
    shipModeLabel: 'Mode',
    contTypeLabel: 'Container',
    portLabel: 'Port',
    brTaxTitle: 'üáßüá∑ Brazil Taxes (auto by NCM)',
    simplifiedLabel: 'Simplified Mode ‚Äî China Gate / ‚â§ US$50',
    fixedLabel: 'Fixed Costs R$',
    usTaxTitle: 'üá∫üá∏ USA Taxes (2026 Tariffs)',
    marginTitle: 'Margin Target',
    minMarginLabel: 'Minimum desired margin',
    btnNext2: 'Sales Market ‚Üí',
    mktTitle: 'Competitor Prices',
    researchTitle: 'Research Prices Online',
    autoPriceBtn: 'Auto-fetch Market Prices (AI)',
    btnCalc: 'Calculate Result ‚Üí',
    btnSave: 'Save Product',
    btnWA: 'Share via WhatsApp',
    btnReset: 'New Search',
    btnSavedNav: 'üìã Saved Products ‚Üí',
    savedTitle: 'üì¶ Saved Products',
    savedSearchPh: 'Search by name, NCM, fair, user‚Ä¶',
    btnNewProduct: '+ Analyze New Product',
  }
};

// Patch applyLang to also translate new elements
const _baseApplyLang = typeof applyLang === 'function' ? applyLang : null;
window.applyLang = function() {
  if (_baseApplyLang) _baseApplyLang();
  const cur = typeof lang !== 'undefined' ? lang : 'pt';
  const d = _ext[cur] || _ext.pt;
  // data-i18n elements
  document.querySelectorAll('[data-i18n]').forEach(el => {
    const k = el.getAttribute('data-i18n');
    if (d[k]) el.textContent = d[k];
  });
  // data-i18n-ph placeholders
  document.querySelectorAll('[data-i18n-ph]').forEach(el => {
    const k = el.getAttribute('data-i18n-ph');
    if (d[k]) el.placeholder = d[k];
  });
};

// Photo injection into save flow
const _origConfirm = typeof confirmSaveProduct === 'function' ? confirmSaveProduct : null;
if (_origConfirm) {
  window.confirmSaveProduct = async function() {
    await _origConfirm();
    if (window._productPhoto && typeof savedProducts !== 'undefined' && savedProducts.length) {
      savedProducts[savedProducts.length-1].photoData = window._productPhoto;
      if (typeof persistSaved === 'function') persistSaved();
      if (typeof renderSaved === 'function') renderSaved();
    }
  };
}
</script>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     SCRIPT 3 ‚Äî POST-INIT
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->


<!-- Settings Modal -->
<div id="settingsOverlay" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:9999;overflow-y:auto" onclick="if(event.target===this)closeSettings()">
  <div style="background:var(--bg2);border-radius:16px;margin:20px auto;max-width:480px;padding:24px;border:1px solid var(--sep)">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
      <div style="font-size:18px;font-weight:700">‚öôÔ∏è Configura√ß√µes</div>
      <button onclick="closeSettings()" style="background:none;border:none;color:var(--t3);font-size:22px;cursor:pointer">‚úï</button>
    </div>

    <div style="font-size:12px;font-weight:700;color:var(--t4);text-transform:uppercase;letter-spacing:.08em;margin-bottom:8px">üë• Usu√°rios</div>
    <div id="userListEditor" style="display:flex;flex-direction:column;gap:6px;margin-bottom:8px"></div>
    <div style="display:grid;grid-template-columns:1fr 1fr auto;gap:6px;margin-bottom:16px">
      <input id="newUserName" type="text" placeholder="Nome" style="padding:8px;border-radius:8px;background:var(--bg3);border:1px solid var(--sep);color:var(--t1);font-size:13px">
      <input id="newUserWA" type="text" placeholder="WhatsApp (ex: 5511...)" style="padding:8px;border-radius:8px;background:var(--bg3);border:1px solid var(--sep);color:var(--t1);font-size:13px">
      <button onclick="addUserToList()" style="padding:8px 12px;background:var(--green);color:#000;border:none;border-radius:8px;font-weight:700;cursor:pointer;font-size:14px">+</button>
    </div>
    <div style="font-size:12px;font-weight:700;color:var(--t4);text-transform:uppercase;letter-spacing:.08em;margin-bottom:8px">Worker URL (Claude AI)</div>
    <input id="settWorkerUrl" type="text" style="width:100%;padding:10px;border-radius:8px;background:var(--bg3);border:1px solid var(--sep);color:var(--t1);font-size:13px;margin-bottom:8px;box-sizing:border-box" placeholder="https://...workers.dev">
    <button onclick="testWorker()" style="width:100%;padding:10px;border-radius:8px;background:var(--blue);color:#fff;border:none;font-size:13px;font-weight:600;cursor:pointer;margin-bottom:16px">üîå Testar Conex√£o Worker</button>
    <div id="settWorkerStatus" style="font-size:12px;color:var(--t3);margin-bottom:16px"></div>

    <div style="font-size:12px;font-weight:700;color:var(--t4);text-transform:uppercase;letter-spacing:.08em;margin-bottom:8px">üáßüá∑ Impostos Brasil</div>
    <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-bottom:16px">
      <div><div style="font-size:11px;color:var(--t3);margin-bottom:4px">II %</div><input id="sII" type="number" style="width:100%;padding:8px;border-radius:8px;background:var(--bg3);border:1px solid var(--sep);color:var(--t1);font-size:13px;box-sizing:border-box"></div>
      <div><div style="font-size:11px;color:var(--t3);margin-bottom:4px">IPI %</div><input id="sIPI" type="number" style="width:100%;padding:8px;border-radius:8px;background:var(--bg3);border:1px solid var(--sep);color:var(--t1);font-size:13px;box-sizing:border-box"></div>
      <div><div style="font-size:11px;color:var(--t3);margin-bottom:4px">ICMS %</div><input id="sICMS" type="number" style="width:100%;padding:8px;border-radius:8px;background:var(--bg3);border:1px solid var(--sep);color:var(--t1);font-size:13px;box-sizing:border-box"></div>
      <div><div style="font-size:11px;color:var(--t3);margin-bottom:4px">PIS %</div><input id="sPIS" type="number" style="width:100%;padding:8px;border-radius:8px;background:var(--bg3);border:1px solid var(--sep);color:var(--t1);font-size:13px;box-sizing:border-box"></div>
      <div><div style="font-size:11px;color:var(--t3);margin-bottom:4px">COFINS %</div><input id="sCOFINS" type="number" style="width:100%;padding:8px;border-radius:8px;background:var(--bg3);border:1px solid var(--sep);color:var(--t1);font-size:13px;box-sizing:border-box"></div>
      <div><div style="font-size:11px;color:var(--t3);margin-bottom:4px">Fixos R$</div><input id="sFixed" type="number" style="width:100%;padding:8px;border-radius:8px;background:var(--bg3);border:1px solid var(--sep);color:var(--t1);font-size:13px;box-sizing:border-box"></div>
    </div>

    <div style="font-size:12px;font-weight:700;color:var(--t4);text-transform:uppercase;letter-spacing:.08em;margin-bottom:8px">üá∫üá∏ Taxas USA</div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:20px">
      <div><div style="font-size:11px;color:var(--t3);margin-bottom:4px">HTS Duty %</div><input id="sDuty" type="number" style="width:100%;padding:8px;border-radius:8px;background:var(--bg3);border:1px solid var(--sep);color:var(--t1);font-size:13px;box-sizing:border-box"></div>
      <div><div style="font-size:11px;color:var(--t3);margin-bottom:4px">Broker Fee USD</div><input id="sBroker" type="number" style="width:100%;padding:8px;border-radius:8px;background:var(--bg3);border:1px solid var(--sep);color:var(--t1);font-size:13px;box-sizing:border-box"></div>
    </div>

    <button onclick="saveSettings()" style="width:100%;padding:14px;border-radius:12px;background:var(--green);color:#000;border:none;font-size:15px;font-weight:700;cursor:pointer">Salvar Configura√ß√µes</button>
  </div>
</div>

</body>
</html>
